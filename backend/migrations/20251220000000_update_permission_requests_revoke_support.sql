-- ===========================================
-- Migration: Update Permission Requests Table
-- ===========================================
-- Purpose: Update permission_requests table to reflect revoke_permission support
-- Date: 2025-12-20
-- Changes:
--   1. Update request_type comment to include 'revoke_permission'
--   2. Add documentation for new fields in request_details JSON
--
-- Note: SQLite doesn't support ALTER TABLE ... MODIFY COLUMN comments,
-- so this migration serves as documentation of the schema changes.
-- The actual table structure already supports all required fields.
-- ===========================================

-- ========================================
-- DOCUMENTATION: Permission Request Types
-- ========================================
-- request_type supports the following values:
--   - 'grant_role': Grant a role to a user
--   - 'grant_permission': Grant specific permissions to a user on a resource
--   - 'revoke_permission': Revoke specific permissions from a user on a resource
--
-- ========================================
-- DOCUMENTATION: Request Details JSON Schema
-- ========================================
-- The request_details TEXT field stores JSON with the following structure:
--
-- Common fields:
--   - action: String (optional) - Action type, matches request_type
--   - target_user: String (optional) - Target user name (e.g., "analyst_user")
--   - target_account: String (optional) - Full account format for SQL (e.g., "user@'%'")
--
-- For 'grant_role':
--   - target_role: String - Role name to grant (e.g., "db_admin")
--
-- For 'grant_permission' and 'revoke_permission':
--   - resource_type: String - Resource type: 'catalog' | 'database' | 'table'
--   - scope: String (optional) - Legacy field for backward compatibility
--   - catalog: String (optional) - Catalog name (StarRocks specific)
--   - database: String (optional) - Database name
--   - table: String (optional) - Table name
--   - permissions: Array<String> - List of permissions (e.g., ['SELECT', 'INSERT'])
--   - with_grant_option: Boolean (optional) - Grant WITH GRANT OPTION privilege
--   - valid_until: String (optional) - Validity period
--
-- Example JSON for grant_permission:
-- {
--   "action": "grant_permission",
--   "target_user": "analyst_user",
--   "resource_type": "database",
--   "catalog": "default_catalog",
--   "database": "my_db",
--   "permissions": ["SELECT", "INSERT"]
-- }
--
-- Example JSON for revoke_permission:
-- {
--   "action": "revoke_permission",
--   "target_user": "analyst_user",
--   "resource_type": "table",
--   "catalog": "default_catalog",
--   "database": "my_db",
--   "table": "users",
--   "permissions": ["DELETE"]
-- }

-- ========================================
-- DOCUMENTATION: Status Workflow
-- ========================================
-- Status transitions:
--   pending -> approved -> executing -> completed
--                      \-> failed
--          \-> rejected
--
-- Status descriptions:
--   - pending: Waiting for approval
--   - approved: Approved by admin/approver, waiting for execution
--   - executing: SQL is being executed on the database
--   - completed: Successfully executed
--   - failed: Execution failed (error message in execution_result)
--   - rejected: Rejected by admin/approver

-- ========================================
-- DOCUMENTATION: SQL Generation
-- ========================================
-- The executed_sql field contains SQL generated by PermissionSqlGenerator
-- based on cluster_type (StarRocks or Doris):
--
-- For grant_role:
--   GRANT 'role_name' TO USER 'username'@'%';
--
-- For grant_permission (database level):
--   GRANT SELECT, INSERT ON `database`.* TO USER 'username'@'%';
--
-- For grant_permission (table level):
--   GRANT SELECT ON `database`.`table` TO USER 'username'@'%';
--
-- For grant_permission (catalog level, StarRocks only):
--   GRANT USAGE ON CATALOG `catalog_name` TO USER 'username'@'%';
--
-- For revoke_permission:
--   REVOKE SELECT, INSERT ON `database`.* FROM USER 'username'@'%';

-- ========================================
-- VALIDATION: Verify Table Structure
-- ========================================
-- The following query can be used to verify the table structure:
-- PRAGMA table_info(permission_requests);
--
-- Expected columns:
--   id, cluster_id, applicant_id, applicant_org_id, request_type,
--   request_details, reason, valid_until, status, approver_id,
--   approval_comment, approved_at, executed_sql, execution_result,
--   executed_at, created_at, updated_at
