<div class="row">
  <!-- Search and Filter Section -->
  <div class="col-12 mb-3">
    <div class="input-group">
      <input
        type="text"
        class="form-control"
        placeholder="搜索用户名或邮箱..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
      />
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Users List Section -->
  <div class="col-12">
    <nb-card>
      <nb-card-header>
        <h6>系统用户 ({{ filteredUsers.length }} / {{ systemUsers.length }})</h6>
      </nb-card-header>

      <nb-card-body>
        <!-- Loading Spinner -->
        <div *ngIf="usersLoading" class="text-center p-4">
          <nb-spinner></nb-spinner>
          <p>加载用户中...</p>
        </div>

        <!-- Users Table -->
        <div *ngIf="!usersLoading && filteredUsers.length > 0">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>角色</th>
                <th>类型</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of filteredUsers">
                <td><small>#{{ user.id }}</small></td>
                <td><strong>{{ user.username }}</strong></td>
                <td><small>{{ user.email }}</small></td>
                <td>
                  <span
                    *ngFor="let role of user.roles"
                    class="badge badge-info mr-1"
                  >
                    {{ role.name }}
                  </span>
                </td>
                <td>
                  <span
                    *ngIf="user.is_org_admin"
                    class="badge badge-danger"
                  >
                    组织管理员
                  </span>
                  <span *ngIf="!user.is_org_admin" class="badge badge-secondary">
                    普通用户
                  </span>
                </td>
                <td><small class="text-muted">{{ user.created_at }}</small></td>
                <td>
                  <button
                    class="btn btn-sm btn-info"
                    (click)="onViewDetail(user)"
                  >
                    详情
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div *ngIf="!usersLoading && filteredUsers.length === 0" class="text-center p-4">
          <p class="text-muted">暂无用户</p>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<!-- User Detail Modal -->
<nb-card *ngIf="selectedUser" class="detail-modal-overlay" (click)="onCloseDetail()">
  <div class="detail-modal-content" (click)="$event.stopPropagation()">
    <nb-card>
      <nb-card-header>
        <div class="d-flex justify-content-between align-items-center">
          <h6>用户详情: {{ selectedUser.username }}</h6>
          <button
            type="button"
            class="btn btn-sm btn-ghost"
            aria-label="关闭"
            (click)="onCloseDetail()"
          >
            ✕
          </button>
        </div>
      </nb-card-header>

      <nb-card-body>
        <!-- Basic Info -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="text-muted">用户名</label>
              <div><strong>{{ selectedUser.username }}</strong></div>
            </div>
            <div class="mb-3">
              <label class="text-muted">邮箱</label>
              <div>{{ selectedUser.email }}</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label class="text-muted">用户类型</label>
              <div>
                <span
                  *ngIf="selectedUser.is_org_admin"
                  class="badge badge-danger"
                >
                  组织管理员
                </span>
                <span *ngIf="!selectedUser.is_org_admin" class="badge badge-secondary">
                  普通用户
                </span>
              </div>
            </div>
            <div class="mb-3">
              <label class="text-muted">创建时间</label>
              <div><small>{{ selectedUser.created_at }}</small></div>
            </div>
          </div>
        </div>

        <!-- Role Assignment -->
        <div class="row mb-4">
          <div class="col-12">
            <label class="text-muted">系统角色</label>
            <div class="mt-2">
              <div class="custom-control custom-checkbox" *ngFor="let role of availableRoles">
                <input
                  type="checkbox"
                  class="custom-control-input"
                  [id]="'role_' + role.id"
                  [checked]="hasRole(role.id)"
                  (change)="onToggleRole(role.id)"
                />
                <label class="custom-control-label" [for]="'role_' + role.id">
                  {{ role.name }}
                  <small class="text-muted" *ngIf="role.description"> - {{ role.description }}</small>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
          <div class="col-12">
            <button
              type="button"
              class="btn btn-success"
              (click)="onSaveRoles()"
              [disabled]="selectedUser.is_super_admin"
            >
              保存角色
            </button>
            <button
              type="button"
              class="btn btn-secondary ml-2"
              (click)="onCloseDetail()"
            >
              关闭
            </button>
          </div>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</nb-card>

<style>
  .detail-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .detail-modal-content {
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    background: white;
    border-radius: 4px;
  }
</style>
