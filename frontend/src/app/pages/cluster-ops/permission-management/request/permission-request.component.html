<div class="row">
  <!-- Form Section -->
  <div class="col-12 mb-4" *ngIf="showForm">
    <nb-card>
      <nb-card-header>
        <h6>新建权限申请</h6>
      </nb-card-header>

      <nb-card-body>
        <form [formGroup]="requestForm">
          <!-- Request Type Selection -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label>申请类型 <span class="text-danger">*</span></label>
              <nb-select
                fullWidth
                formControlName="request_type"
                (selectedChange)="onRequestTypeChange()"
              >
                <nb-option *ngFor="let type of requestTypes" [value]="type.value">
                  {{ type.label }}
                </nb-option>
              </nb-select>
            </div>
          </div>

          <!-- Target User (Common for all types) -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label>选择用户 <span class="text-danger">*</span></label>
              <ng-container *ngIf="!isCreatingUser; else createUserBlock">
                <nb-select
                  fullWidth
                  formControlName="target_user"
                  [disabled]="loadingAccounts"
                  [placeholder]="loadingAccounts ? '加载中...' : '请选择用户'"
                  (selectedChange)="onTargetUserChange($event)"
                >
                  <nb-option *ngFor="let user of dbAccounts" [value]="user">
                    {{ user }}
                  </nb-option>
                  <nb-option value="__CREATE_NEW_USER__">
                    + 创建新账号
                  </nb-option>
                </nb-select>
              </ng-container>
              <ng-template #createUserBlock>
                <input
                  type="text"
                  class="form-control"
                  formControlName="new_user_name"
                  placeholder="请输入新建数据库账户名"
                />
                <small class="text-muted d-block mt-1">
                  将创建新的数据库账户，并为该账户申请以下权限。
                </small>
              </ng-template>
            </div>
            <div class="col-md-3" *ngIf="isCreatingUser">
              <label>初始密码</label>
              <input
                type="password"
                class="form-control"
                formControlName="new_user_password"
                placeholder="请输入初始密码"
              />
            </div>
          </div>

          <!-- Role selection (for grant_role and permission types) -->
          <div *ngIf="isGrantRole || isPermissionType" class="row mb-3">
            <div class="col-md-6">
              <label>选择角色</label>
              <ng-container *ngIf="!isCreatingRole; else createRoleBlock">
                <nb-select
                  fullWidth
                  formControlName="target_role"
                  [disabled]="loadingRoles"
                  [placeholder]="loadingRoles ? '加载中...' : '请选择角色'"
                  (selectedChange)="onTargetRoleChange($event)"
                >
                  <nb-option *ngFor="let role of dbRoles" [value]="role">
                    {{ role }}
                  </nb-option>
                  <nb-option value="__CREATE_NEW_ROLE__">
                    + 创建新角色
                  </nb-option>
                </nb-select>
              </ng-container>
              <ng-template #createRoleBlock>
                <input
                  type="text"
                  class="form-control"
                  formControlName="new_role_name"
                  placeholder="请输入新建数据库角色名"
                />
                <small class="text-muted d-block mt-1">
                  将创建新的数据库角色，并为该角色申请以下权限。
                </small>
              </ng-template>
            </div>
          </div>

          <!-- For grant/revoke_permission -->
          <ng-container *ngIf="isPermissionType">
            <!-- Resource Type -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label>资源类型 <span class="text-danger">*</span></label>
                <nb-select
                  fullWidth
                  formControlName="resource_type"
                >
                  <nb-option value="">-- 请选择资源类型 --</nb-option>
                  <nb-option *ngFor="let type of resourceTypes" [value]="type.value">
                    {{ type.label }}
                  </nb-option>
                </nb-select>
              </div>
            </div>

            <!-- Catalog Selection (for catalog/database/table level) -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label>Catalog</label>
                <nb-select
                  fullWidth
                  formControlName="catalog"
                  [disabled]="loadingCatalogs"
                >
                  <nb-option value="">-- {{ loadingCatalogs ? '加载中...' : '请选择 Catalog' }} --</nb-option>
                  <nb-option *ngFor="let catalog of catalogs" [value]="catalog">
                    {{ catalog }}
                  </nb-option>
                </nb-select>
              </div>
            </div>

            <!-- Database Selection (for database/table level) -->
            <div class="row mb-3" *ngIf="currentResourceType === 'database' || currentResourceType === 'table'">
              <div class="col-md-6">
                <label>数据库 <span class="text-danger">*</span></label>
                <nb-select
                  fullWidth
                  formControlName="database"
                  [disabled]="loadingDatabases"
                >
                  <nb-option value="">-- {{ loadingDatabases ? '加载中...' : '请选择数据库' }} --</nb-option>
                  <nb-option *ngFor="let db of databases" [value]="db">
                    {{ db }}
                  </nb-option>
                </nb-select>
              </div>
            </div>

            <!-- Table Selection (for table level) -->
            <div class="row mb-3" *ngIf="currentResourceType === 'table'">
              <div class="col-md-6">
                <label>表 <span class="text-danger">*</span></label>
                <nb-select
                  fullWidth
                  formControlName="table"
                  [disabled]="loadingTables"
                >
                  <nb-option value="">-- {{ loadingTables ? '加载中...' : '请选择表' }} --</nb-option>
                  <nb-option *ngFor="let table of tables" [value]="table">
                    {{ table }}
                  </nb-option>
                </nb-select>
              </div>
            </div>

            <!-- Permission List (checkboxes) -->
            <div class="row mb-3">
              <div class="col-md-12">
                <label>权限列表 <span class="text-danger">*</span></label>
                <div class="row">
                  <div class="col-md-3" *ngFor="let perm of availablePermissions">
                    <div class="custom-control custom-checkbox">
                      <input
                        type="checkbox"
                        class="custom-control-input"
                        [id]="'perm_' + perm.value"
                        [checked]="isPermissionSelected(perm.value)"
                        (change)="togglePermission(perm.value)"
                      />
                      <label class="custom-control-label" [for]="'perm_' + perm.value">
                        {{ perm.label }}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Reason -->
          <div class="row mb-3">
            <div class="col-12">
              <label>申请原因 <span class="text-danger">*</span></label>
              <textarea
                class="form-control"
                rows="3"
                formControlName="reason"
                placeholder="请详细说明申请权限的原因..."
              ></textarea>
            </div>
          </div>

          <!-- Buttons -->
          <div class="row">
            <div class="col-12">
              <button
                type="button"
                class="btn btn-primary"
                (click)="onSubmitRequest()"
                [disabled]="!requestForm.valid || formSubmitting"
              >
                <span *ngIf="!formSubmitting">提交申请</span>
                <span *ngIf="formSubmitting">
                  <nb-spinner diameter="16"></nb-spinner>
                  提交中...
                </span>
              </button>
              <button
                type="button"
                class="btn btn-secondary ml-2"
                (click)="requestForm.reset({ request_type: 'grant_permission' })"
              >
                重置
              </button>
            </div>
          </div>
        </form>
      </nb-card-body>
    </nb-card>
  </div>

  <!-- My Requests List Section -->
  <div class="col-12">
    <nb-card>
      <nb-card-header>
        <h6>我的申请</h6>
      </nb-card-header>

      <nb-card-body>
        <!-- Status Filter -->
        <div class="row mb-3">
          <div class="col-md-4">
            <nb-select
              fullWidth
              [(selected)]="statusFilter"
              (selectedChange)="onStatusFilterChange()"
            >
              <nb-option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </nb-option>
            </nb-select>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div *ngIf="requestsLoading" class="text-center p-4">
          <nb-spinner></nb-spinner>
          <p>加载申请中...</p>
        </div>

        <!-- Requests Table -->
        <div *ngIf="!requestsLoading && filteredRequests.length > 0">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>申请类型</th>
                <th>目标</th>
                <th>申请原因</th>
                <th>权限</th>
                <th>状态</th>
                <th>创建时间</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let req of filteredRequests">
                <td><small>#{{ req.id }}</small></td>
                <td>
                  <span class="badge badge-primary">
                    {{ req.request_type === 'grant_role' ? '授予角色' : req.request_type === 'grant_permission' ? '授予权限' : '撤销权限' }}
                  </span>
                </td>
                <td>
                  <small>{{ getRequestTarget(req) }}</small>
                </td>
                <td>
                  <small class="text-truncate d-inline-block" style="max-width: 150px">
                    {{ req.reason }}
                  </small>
                </td>
                <td>
                  <small>{{ getRequestPermissions(req) }}</small>
                </td>
                <td>
                  <span class="badge" [ngClass]="'badge-' + getStatusBadgeType(req.status)">
                    {{ getStatusLabel(req.status) }}
                  </span>
                </td>
                <td>
                  <small class="text-muted">{{ req.created_at }}</small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div *ngIf="!requestsLoading && filteredRequests.length === 0" class="text-center p-4">
          <p class="text-muted">暂无申请</p>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>
