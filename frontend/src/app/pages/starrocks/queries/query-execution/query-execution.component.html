<!-- Page-level loading overlay for info dialogs -->
<div class="info-dialog-loading-overlay" *ngIf="infoDialogPageLoading">
  <div class="loading-content">
    <nb-spinner status="primary" size="large" [message]="''"></nb-spinner>
    <p class="mt-3 text-hint">正在加载数据...</p>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-body>
        <!-- Tab Selector with Toggle Button -->
        <div class="tab-header-wrapper">
          <div class="tab-header-with-toggle">
            <nb-tabset (changeTab)="selectTab($event.tabId)">
              <!-- Real-time Query Tab -->
              <nb-tab tabTitle="实时查询" tabId="realtime" [active]="selectedTab === 'realtime'">
              <div class="realtime-query-container">
              <div class="query-split-layout">
                <div class="nav-tree-wrapper" [class.collapsed]="treeCollapsed" [style.width.px]="treePanelWidth">
                  <ng-container *ngIf="!treeCollapsed; else collapsedButton">
                    <nb-card size="tiny" class="nav-tree-card" [style.height.px]="treePanelHeight">
                      <nb-card-header>
                        <div class="nav-tree-header">
                          <nb-icon icon="layers-outline"></nb-icon>
                          <span>Catalog / 数据库</span>
                        </div>
                        <button 
                          nbButton 
                          status="basic"
                          size="tiny" 
                          class="tree-collapse-toggle header-button"
                          type="button"
                          (click)="toggleTreeCollapsed()"
                          [title]="treeCollapsed ? '展开数据库树' : '收起数据库树'">
                          <nb-icon icon="arrow-ios-back-outline"></nb-icon>
                        </button>
                      </nb-card-header>
                      <nb-card-body>
                        <div class="tree-scroll">
                          <div class="tree-loading" *ngIf="loadingCatalogs">
                            <nb-spinner size="small" status="primary" [message]="''"></nb-spinner>
                          </div>
                          <ul class="nav-tree" *ngIf="!loadingCatalogs && databaseTree.length > 0; else emptyTree">
                            <ng-container *ngFor="let node of databaseTree; trackBy: trackNodeById">
                              <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { $implicit: node }"></ng-container>
                            </ng-container>
                          </ul>
                          <ng-template #emptyTree>
                            <div class="empty-tree">
                              <nb-icon icon="alert-circle-outline"></nb-icon>
                              <span>暂无 Catalog</span>
                            </div>
                          </ng-template>
                        </div>
                      </nb-card-body>
                    </nb-card>
                  </ng-container>
                  <ng-template #collapsedButton>
                    <button 
                      nbButton 
                      status="basic"
                      size="tiny" 
                      class="tree-collapse-toggle collapsed-button"
                      type="button"
                      (click)="toggleTreeCollapsed()"
                      [title]="treeCollapsed ? '展开数据库树' : '收起数据库树'">
                      <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                    </button>
                  </ng-template>
                </div>

                <div class="tree-resizer" *ngIf="!treeCollapsed" (mousedown)="startTreeResize($event)">
                  <span class="resizer-grip"></span>
                </div>

                <div class="editor-panel" [class.editor-collapsed]="sqlEditorCollapsed">
                  <!-- Collapsed SQL Bar (shown when editor is collapsed) -->
                  <div *ngIf="sqlEditorCollapsed" class="collapsed-sql-bar" (click)="toggleSqlEditor(false)">
                    <div class="collapsed-sql-preview">
                      <nb-icon icon="code-outline" status="primary"></nb-icon>
                      <span class="sql-text" *ngIf="sqlInput && sqlInput.length > 0">{{ sqlInput | slice:0:100 }}{{ sqlInput.length > 100 ? '...' : '' }}</span>
                      <span class="sql-text sql-placeholder" *ngIf="!sqlInput || sqlInput.length === 0">点击展开 SQL 编辑器</span>
                    </div>
                  </div>

                  <!-- SQL Editor - CodeMirror (shown when editor is expanded) -->
                  <div class="sql-editor-section" [@editorCollapse]="sqlEditorCollapsed ? 'collapsed' : 'expanded'">
                    <div class="selection-toolbar d-flex justify-content-between align-items-center">
                      <div class="selection-path d-flex align-items-center">
                        <nb-icon icon="pin-outline" status="primary"></nb-icon>
                        <span class="path-segment" [class.inactive]="!selectedCatalog">{{ selectedCatalog || '未选择 Catalog' }}</span>
                        <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                        <span class="path-segment" [class.inactive]="!selectedDatabase">{{ selectedDatabase || '未选择数据库' }}</span>
                        <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                        <span class="path-segment" [class.inactive]="!selectedTable">{{ selectedTable || '未选择表' }}</span>
                        <nb-spinner *ngIf="loadingDatabases" size="tiny" status="info" class="loading-indicator" [message]="''"></nb-spinner>
                      </div>

                      <div class="editor-action-buttons d-flex align-items-center gap-2">
                        <button 
                          nbButton 
                          status="primary" 
                          size="small"
                          [nbSpinner]="executing"
                          nbSpinnerStatus="control"
                          nbSpinnerSize="small"
                          (click)="executeSQL()" 
                          [disabled]="executing || !clusterId || !sqlInput">
                          <nb-icon *ngIf="!executing" icon="play-circle-outline"></nb-icon>
                          {{ executing ? '执行中...' : '执行' }}
                        </button>
                        <button 
                          nbButton 
                          status="basic" 
                          size="small"
                          (click)="clearSQL()" 
                          [disabled]="executing">
                          <nb-icon icon="trash-2-outline"></nb-icon>
                          清空
                        </button>
                        <button 
                          nbButton 
                          status="info" 
                          size="small"
                          (click)="formatSQL()" 
                          [disabled]="executing || !sqlInput">
                          <nb-icon icon="code-outline"></nb-icon>
                          格式化
                        </button>
                        <button 
                          nbButton 
                          status="warning" 
                          size="small"
                          [nbSpinner]="diagnosing"
                          nbSpinnerStatus="control"
                          nbSpinnerSize="small"
                          (click)="diagnoseSQL()" 
                          [disabled]="executing || diagnosing || !sqlInput || !clusterId">
                          <nb-icon *ngIf="!diagnosing" icon="bulb-outline"></nb-icon>
                          {{ diagnosing ? '诊断中...' : '诊断' }}
                        </button>
                      </div>
                    </div>

                    <!-- CodeMirror Editor Container -->
                    <div class="editor-wrapper">
                      <div #editorContainer class="codemirror-container"></div>

                      <!-- Loading overlay with Nebular spinner -->
                      <div *ngIf="executing" class="loading-overlay">
                        <nb-spinner size="large" status="primary" [message]="''"></nb-spinner>
                        <p class="loading-text">正在执行查询...</p>
                      </div>



                      <div class="editor-footer d-flex justify-content-between align-items-center">
                        <small class="hint-text">
                          <nb-icon icon="info-outline"></nb-icon>
                          SELECT 查询会自动添加 LIMIT 限制（如未指定）
                        </small>

                        <div class="right-actions">
                          <span class="limit-label">限制:</span>
                          <nb-select 
                            [(selected)]="queryLimit" 
                            size="tiny"
                            [disabled]="executing">
                            <nb-option *ngFor="let option of limitOptions" [value]="option.value">
                              {{ option.label }}
                            </nb-option>
                          </nb-select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Query Results (attached to editor panel) -->
                  <div class="results-section" *ngIf="queryResult">
                    <!-- Single Result (when only 1 SQL) -->
                    <nb-card *ngIf="queryResults.length === 1" class="result-card">
                      <nb-card-header>
                        <div class="result-header">
                          <h6 class="mb-0">查询结果</h6>
                          <div class="result-actions">
                            <div class="result-stat-item">
                              <nb-icon icon="clock-outline" status="success" class="stat-icon"></nb-icon>
                              <span class="stat-label">执行耗时:</span>
                              <span class="stat-value stat-time">{{ executionTime }}ms</span>
                            </div>
                            <div class="result-stat-item">
                              <nb-icon icon="list-outline" status="info" class="stat-icon"></nb-icon>
                              <span class="stat-label">返回行数:</span>
                              <span class="stat-value stat-count">{{ rowCount | number }}</span>
                            </div>
                            <button 
                              *ngIf="queryResults[0].success"
                              nbButton 
                              size="small" 
                              status="success"
                              (click)="exportResults(0)"
                              class="ml-2">
                              <nb-icon icon="download-outline"></nb-icon>
                              导出 CSV
                            </button>
                          </div>
                        </div>
                      </nb-card-header>
                      <nb-card-body>
                        <div *ngIf="queryResults[0].error" class="error-message mb-3">
                          <nb-alert status="danger" [title]="'执行失败'">{{ queryResults[0].error }}</nb-alert>
                        </div>
                        <ng2-smart-table 
                          *ngIf="resultSettings[0] && queryResults[0].success" 
                          [settings]="resultSettings[0]" 
                          [source]="resultSources[0]">
                        </ng2-smart-table>
                        <div *ngIf="queryResults[0].success && rowCount === 0" class="no-data-message">
                          <nb-icon icon="inbox-outline"></nb-icon>
                          <p>查询未返回任何数据</p>
                        </div>
                      </nb-card-body>
                    </nb-card>

                    <!-- Multiple Results (using nb-tabset) -->
                    <nb-card *ngIf="queryResults.length > 1" class="result-card">
                      <nb-card-body>
                        <div class="tabset-with-export">
                          <nb-tabset #tabsetRef class="result-tabset" (changeTab)="currentResultIndex = $event.tabId ? parseInt($event.tabId.split('-')[1]) : 0">
                            <nb-tab 
                              *ngFor="let result of queryResults; let i = index" 
                              [tabTitle]="'结果' + (i + 1)"
                              [tabId]="'result-' + i"
                              [active]="i === 0">
                              <div class="tab-content-wrapper">
                                <!-- Error Message -->
                                <div *ngIf="result.error" class="error-message mb-3">
                                  <nb-alert status="danger" [title]="'执行失败'">{{ result.error }}</nb-alert>
                                </div>

                                <!-- Result Table -->
                                <ng2-smart-table 
                                  *ngIf="resultSettings[i] && result.success" 
                                  [settings]="resultSettings[i]" 
                                  [source]="resultSources[i]">
                                </ng2-smart-table>

                                <!-- Result Stats at bottom right -->
                                <div *ngIf="result.success" class="result-stats-footer">
                                  <span class="stats-text">
                                    <nb-icon icon="list-outline" class="stats-icon"></nb-icon>
                                    {{ result.row_count }} 行
                                    <span class="stats-separator">|</span>
                                    <nb-icon icon="clock-outline" class="stats-icon"></nb-icon>
                                    {{ result.execution_time_ms }}ms
                                  </span>
                                </div>

                                <!-- No Data Message -->
                                <div *ngIf="result.success && result.row_count === 0" class="no-data-message">
                                  <nb-icon icon="inbox-outline"></nb-icon>
                                  <p>查询未返回任何数据</p>
                                </div>
                              </div>
                            </nb-tab>
                          </nb-tabset>

                          <!-- Export button aligned with tabs -->
                          <div class="export-button-wrapper" *ngIf="queryResults.length > 0 && queryResults[currentResultIndex]?.success && queryResults[currentResultIndex]?.row_count > 0">
                            <button 
                              nbButton 
                              size="small" 
                              status="success"
                              (click)="exportResults(currentResultIndex)"
                              class="export-btn">
                              <nb-icon icon="download-outline" class="export-icon"></nb-icon>
                              导出 CSV
                            </button>
                          </div>
                        </div>
                      </nb-card-body>
                    </nb-card>
                  </div>
                </div>
              </div>

              <ng-template #treeNodeTemplate let-node>
                <li class="tree-node" [class.expanded]="node.expanded" [class.selected]="node.id === selectedNodeId">
                  <div class="tree-node-row" [ngClass]="'type-' + node.type" [style.paddingLeft.px]="getNodeIndent(node)" (click)="onNodeSelect(node, $event)" (contextmenu)="onNodeRightClick(node, $event)">
                    <button 
                      *ngIf="isNodeExpandable(node)"
                      nbButton 
                      ghost 
                      size="tiny" 
                      class="toggle-btn"
                      type="button"
                      (click)="toggleNode(node, $event)"
                      [class.expanded]="node.expanded">
                      <nb-icon [icon]="node.expanded ? 'chevron-down-outline' : 'chevron-right-outline'"></nb-icon>
                    </button>
                    <div class="node-icon">
                      <nb-icon [icon]="node.icon || 'folder-outline'"></nb-icon>
                    </div>
                    <span class="node-text">{{ node.name }}</span>
                    <ng-container [ngSwitch]="node.data?.tableType">
                      <span *ngSwitchCase="'VIEW'" class="node-badge node-badge-view">VIEW</span>
                      <span *ngSwitchCase="'MATERIALIZED_VIEW'" class="node-badge node-badge-mv">MV</span>
                    </ng-container>
                    <nb-spinner *ngIf="node.loading" size="tiny" status="primary" [message]="''"></nb-spinner>
                  </div>
                  <ul class="tree-children" *ngIf="node.children && node.children.length && node.expanded">
                    <ng-container *ngFor="let child of node.children; trackBy: trackNodeById">
                      <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { $implicit: child }"></ng-container>
                    </ng-container>
                  </ul>
                </li>
              </ng-template>

            </div>
          </nb-tab>

          <!-- Running Queries Tab -->
          <nb-tab tabTitle="运行中" tabId="running" [active]="selectedTab === 'running'">
            <!-- Filter and Actions Bar -->
            <div class="running-query-filters mb-3" *ngIf="!loading">
              <div class="filter-content">
                <div class="filter-options">
                  <nb-checkbox 
                    [(ngModel)]="runningQueryFilter.slowQueryOnly"
                    (checkedChange)="applyRunningQueryFilter()"
                    class="filter-checkbox">
                    <span class="text-hint">仅显示慢查询（≥5分钟）</span>
                  </nb-checkbox>
                  <nb-checkbox 
                    [(ngModel)]="runningQueryFilter.highCostOnly"
                    (checkedChange)="applyRunningQueryFilter()"
                    class="filter-checkbox">
                    <span class="text-hint">仅显示高消耗查询（≥1GB）</span>
                  </nb-checkbox>
                  <button 
                    *ngIf="runningQueryFilter.slowQueryOnly || runningQueryFilter.highCostOnly"
                    nbButton 
                    ghost 
                    size="tiny"
                    status="basic"
                    (click)="resetRunningQueryFilter()"
                    class="clear-filter-btn">
                    <span class="text-hint">清除筛选</span>
                  </button>
                </div>
                <div class="filter-actions">
                  <button 
                    nbButton 
                    status="danger" 
                    size="small"
                    (click)="batchKillSelectedQueries()"
                    [disabled]="loading">
                    <nb-icon icon="trash-2-outline"></nb-icon>
                    批量查杀当前显示
                  </button>
                </div>
              </div>
            </div>
            
            <div *ngIf="loading" class="text-center mt-3"><nb-spinner status="primary" [message]="''"></nb-spinner></div>
            <ng2-smart-table 
              *ngIf="!loading" 
              [settings]="runningSettings" 
              [source]="runningSource"
              (delete)="onQueryDeleteConfirm($event)"
              (edit)="onQueryEdit($event)">
            </ng2-smart-table>
          </nb-tab>
          </nb-tabset>
          </div>
          
          <!-- SQL Editor Toggle Button (only visible on realtime tab) -->
          <button 
            *ngIf="selectedTab === 'realtime'"
            nbButton 
            ghost 
            size="tiny"
            (click)="toggleSqlEditor()"
            class="sql-editor-toggle-btn"
            [title]="sqlEditorCollapsed ? '展开 SQL 编辑器' : '收起 SQL 编辑器'">
            <nb-icon [icon]="sqlEditorCollapsed ? 'chevron-down-outline' : 'chevron-up-outline'"></nb-icon>
          </button>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<!-- Table Schema Dialog Template -->
<ng-template #tableSchemaDialog let-ref="dialogRef">
  <nb-card class="table-schema-dialog">
    <nb-card-header>
      <div class="schema-dialog-header">
        <div class="schema-dialog-title">
          <nb-icon icon="file-text-outline" status="info"></nb-icon>
          <div class="schema-text-group">
            <span class="schema-title-text">{{ schemaDialogTitle || '表结构' }}</span>
            <span class="schema-subtitle-text" *ngIf="schemaDialogSubtitle">{{ schemaDialogSubtitle }}</span>
          </div>
        </div>
        <button nbButton ghost status="basic" size="tiny" (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div class="schema-loading" *ngIf="tableSchemaLoading">
        <nb-spinner status="primary" size="large" [message]="''"></nb-spinner>
        <p class="mt-2 text-hint">正在获取表结构...</p>
      </div>
      <div class="schema-content" *ngIf="!tableSchemaLoading">
        <div class="schema-scroll">
          <pre class="schema-text" *ngIf="currentTableSchema; else emptySchema">{{ currentTableSchema }}</pre>
          <ng-template #emptySchema>
            <div class="empty-schema">
              <nb-icon icon="alert-circle-outline" status="warning"></nb-icon>
              <p class="mb-0">未获取到建表语句</p>
            </div>
          </ng-template>
        </div>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<div 
  class="tree-context-menu" 
  *ngIf="contextMenuVisible"
  [style.left.px]="contextMenuX"
  [style.top.px]="contextMenuY"
  (contextmenu)="$event.preventDefault()">
  <button 
    type="button"
    class="context-menu-item"
    *ngFor="let item of contextMenuItems"
    (click)="onContextMenuItemClick(item, $event)">
    <nb-icon [icon]="item.icon"></nb-icon>
    <span>{{ item.label }}</span>
  </button>
</div>

<!-- Info Dialog Template -->
<ng-template #infoDialog let-ref="dialogRef">
  <nb-card class="info-dialog-card">
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ infoDialogTitle }}</h5>
        <button nbButton ghost (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body class="info-dialog-body">
      <nb-alert *ngIf="infoDialogError" status="danger" closable="false">
        <strong>错误：</strong>{{ infoDialogError }}
      </nb-alert>

      <!-- Transaction tabs (only for transactions type) -->
      <nb-tabset *ngIf="infoDialogType === 'transactions' && !infoDialogError" (changeTab)="switchTransactionTab($event.tabId)">
        <nb-tab tabTitle="运行中" tabId="running" [active]="transactionCurrentTab === 'running'">
        </nb-tab>
        <nb-tab tabTitle="已完成" tabId="finished" [active]="transactionCurrentTab === 'finished'">
        </nb-tab>
      </nb-tabset>

      <!-- Table stats tabs (only for tableStats type) -->
      <nb-tabset *ngIf="infoDialogType === 'tableStats' && !infoDialogError" (changeTab)="switchTableStatsTab($event.tabId)">
        <nb-tab tabTitle="分区结构" tabId="partition" [active]="tableStatsCurrentTab === 'partition'">
        </nb-tab>
        <nb-tab tabTitle="Compaction Score" tabId="compaction" [active]="tableStatsCurrentTab === 'compaction'">
        </nb-tab>
        <nb-tab tabTitle="表统计" tabId="storage" [active]="tableStatsCurrentTab === 'storage'">
        </nb-tab>
      </nb-tabset>

      <!-- Bucket analysis tabs (only for bucketAnalysis type) -->
      <nb-tabset *ngIf="infoDialogType === 'bucketAnalysis' && !infoDialogError" (changeTab)="switchBucketAnalysisTab($event.tabId)">
        <nb-tab tabTitle="分桶倾斜分析" tabId="skew" [active]="bucketAnalysisCurrentTab === 'skew'">
        </nb-tab>
        <nb-tab tabTitle="BE级别分布" tabId="distribution" [active]="bucketAnalysisCurrentTab === 'distribution'">
        </nb-tab>
        <nb-tab tabTitle="排序键基数分析" tabId="sortkey" [active]="bucketAnalysisCurrentTab === 'sortkey'">
        </nb-tab>
        <nb-tab tabTitle="分桶调整" tabId="adjust" [active]="bucketAnalysisCurrentTab === 'adjust'">
        </nb-tab>
      </nb-tabset>

      <!-- Bucket adjustment form (only for bucketAnalysis type, adjust tab) -->
      <div *ngIf="infoDialogType === 'bucketAnalysis' && bucketAnalysisCurrentTab === 'adjust' && !infoDialogError" class="bucket-adjustment-form">
        <div class="form-group">
          <label class="label">当前分桶数</label>
          <div class="form-control-static">
            <strong>{{ bucketAnalysisCurrentBuckets }}</strong>
          </div>
        </div>

        <div class="form-group mt-3">
          <label class="label">推荐分桶数</label>
          <div class="form-control-static">
            <strong>{{ getBucketAdjustmentRecommendedBuckets() }}</strong>
            <button 
              nbButton 
              size="tiny" 
              status="basic" 
              class="ml-2"
              (click)="useRecommendedBuckets()">
              使用推荐值
            </button>
          </div>
          <small class="form-text text-muted">
            推荐值基于数据大小计算（每10GB约1个分桶）
          </small>
        </div>

        <div class="form-group mt-3">
          <label class="label">新分桶数 <span class="text-danger">*</span></label>
          <input 
            type="number" 
            nbInput 
            [(ngModel)]="bucketAdjustmentNewBuckets"
            (ngModelChange)="onBucketAdjustmentInputChange($event)"
            [min]="1" 
            [max]="128"
            placeholder="请输入新的分桶数（1-128）"
            [disabled]="bucketAdjustmentAdjusting">
          <small class="form-text text-muted">
            分桶数范围：1-128。建议使用推荐值或根据数据量调整
          </small>
        </div>

        <nb-alert status="warning" closable="false" class="mt-3">
          <strong>警告：</strong>
          <ul class="mb-0 mt-2">
            <li>分桶调整需要重建表，这是一个耗时操作</li>
            <li>重建表期间，表将被锁定，无法进行读写操作</li>
            <li>请确保有足够的存储空间用于数据迁移</li>
            <li>建议在业务低峰期执行此操作</li>
            <li>此操作需要 ALTER TABLE 和 CREATE TABLE 权限</li>
          </ul>
        </nb-alert>

        <div class="d-flex justify-content-end mt-4">
          <button 
            nbButton 
            status="basic" 
            class="mr-2"
            (click)="previewBucketAdjustment()"
            [disabled]="!bucketAdjustmentNewBuckets || bucketAdjustmentNewBuckets <= 0 || bucketAdjustmentAdjusting">
            预览调整
          </button>
          <button 
            nbButton 
            status="danger"
            (click)="executeBucketAdjustment()"
            [disabled]="!bucketAdjustmentNewBuckets || bucketAdjustmentNewBuckets <= 0 || bucketAdjustmentAdjusting || bucketAdjustmentNewBuckets === bucketAnalysisCurrentBuckets">
            <nb-icon icon="flash-outline"></nb-icon>
            {{ bucketAdjustmentAdjusting ? '调整中...' : '执行调整' }}
          </button>
        </div>
      </div>

      <!-- Regular table display for other tabs -->
      <ng2-smart-table
        *ngIf="!infoDialogError && !(infoDialogType === 'bucketAnalysis' && bucketAnalysisCurrentTab === 'adjust')"
        [settings]="infoDialogSettings"
        [source]="infoDialogSource">
      </ng2-smart-table>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex align-items-center">
        <!-- Per page selector - moved to left bottom -->
        <div class="per-page-selector" *ngIf="!infoDialogError">
          <label>每页显示：</label>
          <nb-select 
            [(selected)]="infoDialogPerPage" 
            (selectedChange)="onPerPageChange($event)"
            size="small">
            <nb-option *ngFor="let option of perPageOptions" [value]="option">
              {{ option }}
            </nb-option>
          </nb-select>
        </div>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- Compaction Trigger Dialog Template -->
<ng-template #compactionTriggerDialog let-ref="dialogRef">
  <nb-card>
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>手动触发Compaction: {{ compactionTriggerTable }}</h5>
        <button nbButton ghost (click)="closeCompactionTriggerDialog()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div class="form-group">
        <label class="label">触发模式</label>
        <nb-radio-group [(ngModel)]="compactionTriggerMode">
          <nb-radio value="table">整个表</nb-radio>
          <nb-radio value="partition">指定分区</nb-radio>
        </nb-radio-group>
        <small class="form-text text-muted">
          选择对整个表执行Compaction，还是对指定分区执行Compaction
        </small>
      </div>

      <div class="form-group mt-3" *ngIf="compactionTriggerMode === 'partition'">
        <label class="label">选择分区（可多选）</label>
        <div class="partition-selector" style="max-height: 300px; overflow-y: auto; border: 1px solid #e4e9f2; padding: 10px; border-radius: 4px;">
          <nb-checkbox
            *ngFor="let partition of (availablePartitions || [])"
            [checked]="compactionSelectedPartitions.includes(partition)"
            (checkedChange)="togglePartitionSelection(partition, $event)"
            class="mb-2">
            {{ partition }}
          </nb-checkbox>
          <p *ngIf="!availablePartitions || availablePartitions.length === 0" class="text-hint">
            暂无分区数据
          </p>
        </div>
        <small class="form-text text-muted">
          选择要执行Compaction的分区，可以多选
        </small>
      </div>

      <nb-alert status="info" closable="false" class="mt-3">
        <strong>提示：</strong>
        <ul class="mb-0 mt-2">
          <li>Compaction任务会在后台执行，不会阻塞当前操作</li>
          <li>可以通过"查看Compaction信息"查看任务执行状态</li>
          <li>如果表或分区正在执行Compaction，新的任务会排队等待</li>
        </ul>
      </nb-alert>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-end gap-2">
        <button
          nbButton
          status="basic"
          (click)="closeCompactionTriggerDialog()"
          [disabled]="compactionTriggering">
          取消
        </button>
        <button
          nbButton
          status="primary"
          (click)="triggerCompaction()"
          [disabled]="compactionTriggering || (compactionTriggerMode === 'partition' && compactionSelectedPartitions.length === 0)">
          <nb-icon icon="flash-outline"></nb-icon>
          {{ compactionTriggering ? '触发中...' : '触发Compaction' }}
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- Query Detail Dialog Template -->
<ng-template #queryDetailDialog let-ref="dialogRef">
  <nb-card class="query-detail-dialog">
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5>查询详情</h5>
        <button nbButton ghost (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body *ngIf="currentQueryDetail">
      <div class="query-detail-content">
        <div class="detail-row">
          <label class="detail-label">Query ID:</label>
          <span class="detail-value">{{ currentQueryDetail.QueryId }}</span>
        </div>
        <div class="detail-row">
          <label class="detail-label">用户:</label>
          <span class="detail-value">{{ currentQueryDetail.User }}</span>
        </div>
        <div class="detail-row">
          <label class="detail-label">数据库:</label>
          <span class="detail-value">{{ currentQueryDetail.Database || 'N/A' }}</span>
        </div>
        <div class="detail-row">
          <label class="detail-label">连接ID:</label>
          <span class="detail-value">{{ currentQueryDetail.ConnectionId }}</span>
        </div>
        <div class="detail-row">
          <label class="detail-label">执行时间:</label>
          <span class="detail-value" [innerHTML]="renderSlowQueryBadge(currentQueryDetail.ExecTime)"></span>
        </div>
        <div class="detail-row">
          <label class="detail-label">扫描数据量:</label>
          <span class="detail-value" [innerHTML]="formatBytes(currentQueryDetail.ScanBytes)"></span>
        </div>
        <div class="detail-row">
          <label class="detail-label">处理行数:</label>
          <span class="detail-value">{{ formatNumber(currentQueryDetail.ProcessRows) }}</span>
        </div>
        <div class="detail-row">
          <label class="detail-label">CPU时间:</label>
          <span class="detail-value" [innerHTML]="formatTime(currentQueryDetail.CPUTime)"></span>
        </div>
        <div class="detail-row" *ngIf="currentQueryDetail.StartTime">
          <label class="detail-label">开始时间:</label>
          <span class="detail-value">{{ currentQueryDetail.StartTime }}</span>
        </div>
        <div class="detail-row" *ngIf="currentQueryDetail.MemoryUsage">
          <label class="detail-label">内存使用:</label>
          <span class="detail-value">{{ currentQueryDetail.MemoryUsage }}</span>
        </div>
        <div class="detail-row" *ngIf="currentQueryDetail.ResourceGroup">
          <label class="detail-label">资源组:</label>
          <span class="detail-value">{{ currentQueryDetail.ResourceGroup }}</span>
        </div>
        <div class="detail-row" *ngIf="currentQueryDetail.feIp">
          <label class="detail-label">FE节点:</label>
          <span class="detail-value">{{ currentQueryDetail.feIp }}</span>
        </div>
        <div class="detail-row detail-row-full">
          <label class="detail-label">SQL语句:</label>
          <div class="sql-content">
            <pre class="sql-text">{{ currentQueryDetail.Sql || 'N/A' }}</pre>
          </div>
        </div>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-end">
        <button nbButton status="danger" (click)="killQueryFromDetail(); ref.close()">
          <nb-icon icon="trash-2-outline"></nb-icon>
          查杀查询
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- SQL Diagnosis Dialog Template -->
<ng-template #sqlDiagDialog let-ref="dialogRef">
  <nb-card class="sql-diag-dialog">
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center w-100">
        <div class="d-flex align-items-center">
          <nb-icon icon="bulb-outline" status="warning" class="mr-2"></nb-icon>
          <h5 class="mb-0">SQL 诊断报告</h5>
          <nb-badge *ngIf="diagCached" status="info" class="ml-2">缓存</nb-badge>
        </div>
        <button nbButton ghost status="basic" size="tiny" (click)="closeDiagDialog()" class="diag-close-btn">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    
    <nb-card-body>
      <!-- Loading state -->
      <div *ngIf="diagnosing" class="text-center py-5">
        <nb-spinner status="primary" size="large" [message]="''"></nb-spinner>
        <h6 class="mt-3 mb-2">正在分析 SQL 性能</h6>
        <p class="text-hint">AI 正在深度分析您的查询语句...</p>
      </div>

      <!-- Error state -->
      <nb-alert *ngIf="diagError && !diagnosing" status="danger" closable="false">
        <strong>诊断失败：</strong>{{ diagError }}
      </nb-alert>

      <!-- Result state -->
      <div *ngIf="diagResult && !diagnosing">
        
        <!-- 1. 优化后的 SQL (最重要，放在第一位) -->
        <div *ngIf="diagResult.changed && diagResult.sql" class="mb-3">
          <nb-card accent="success">
            <nb-card-header>
              <div class="d-flex align-items-center">
                <nb-icon icon="code-outline" status="success" class="mr-2"></nb-icon>
                <h6 class="mb-0">优化后的 SQL</h6>
              </div>
            </nb-card-header>
            <nb-card-body>
              <div class="sql-code-box">
                <pre>{{ formatDiagSQL(diagResult.sql) }}</pre>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- 2. 诊断摘要 + 性能问题（合并显示） -->
        <div class="mb-3">
          <nb-card>
            <nb-card-header>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <nb-icon [icon]="hasIssues() ? 'alert-triangle-outline' : 'checkmark-circle-2-outline'" 
                           [status]="hasIssues() ? 'warning' : 'success'" class="mr-2"></nb-icon>
                  <h6 class="mb-0">{{ hasIssues() ? '已应用' + diagResult.perf_issues.length + '个优化项' : '未发现明显问题' }}</h6>
                </div>
                <nb-badge [status]="diagResult.confidence > 0.7 ? 'success' : 'warning'">
                  {{ (diagResult.confidence * 100).toFixed(0) }}%
                </nb-badge>
              </div>
            </nb-card-header>
            <nb-card-body>
              <!-- 摘要 -->
              <p class="text-hint mb-3">{{ diagResult.summary }}</p>
              
              <!-- 问题列表 -->
              <div *ngIf="diagResult.perf_issues?.length > 0">
                <div *ngFor="let issue of diagResult.perf_issues; let i = index; let last = last" 
                     class="issue-item" [class.mb-3]="!last">
                  <div class="d-flex align-items-start">
                    <nb-badge [status]="getSeverityStatus(issue.severity)" class="mr-2 mt-1">
                      {{ getSeverityLabel(issue.severity) }}
                    </nb-badge>
                    <div class="flex-grow-1">
                      <strong class="d-block mb-1">{{ issue.type }}</strong>
                      <p class="text-hint mb-2">{{ issue.desc }}</p>
                      <div *ngIf="issue.fix" class="fix-box">
                        <nb-icon icon="lightbulb-outline" status="success" class="mr-1"></nb-icon>
                        {{ issue.fix }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

      </div>
    </nb-card-body>
    
    <nb-card-footer>
      <div class="d-flex align-items-center text-hint">
        <nb-icon icon="info-outline" class="mr-1"></nb-icon>
        <span>由 AI 智能分析生成</span>
        <span *ngIf="diagElapsedMs > 0" class="ml-2">• 耗时: {{ diagElapsedMs }}ms</span>
      </div>
      <button *ngIf="diagResult?.changed && diagResult?.sql" nbButton status="success" size="small" (click)="acceptDiagSQL()">
        <nb-icon icon="checkmark-outline" class="mr-1"></nb-icon>
        应用优化
      </button>
    </nb-card-footer>
  </nb-card>
</ng-template>

<!-- SQL Blacklist Add Dialog -->
<ng-template #blacklistDialog let-ref="dialogRef">
  <nb-card class="blacklist-dialog">
    <nb-card-header>
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">添加 SQL 黑名单规则</h5>
        <button nbButton ghost status="basic" size="small" (click)="cancelBlacklistDialog()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body>
      <div class="form-group">
        <label class="label">正则表达式</label>
        <textarea nbInput fullWidth rows="4" [(ngModel)]="newBlacklistPattern" 
          placeholder="例如: SELECT.*FROM.*sensitive_table.*"></textarea>
        <span class="hint-text">匹配此正则表达式的 SQL 语句将被拒绝执行</span>
      </div>
    </nb-card-body>
    <nb-card-footer>
      <div class="d-flex justify-content-end gap-2">
        <button nbButton status="basic" size="small" (click)="cancelBlacklistDialog()">取消</button>
        <button nbButton status="primary" size="small" (click)="submitBlacklistPattern()" [disabled]="blacklistLoading">
          <nb-spinner *ngIf="blacklistLoading" size="tiny" status="control"></nb-spinner>
          添加
        </button>
      </div>
    </nb-card-footer>
  </nb-card>
</ng-template>
