<div class="row">
  <div class="col-12">
    <nb-card>
      <nb-card-header>
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">Profiles</h5>
            <span class="text-hint">|</span>
            <span class="text-hint" style="font-size: 13px;">
              ÈõÜÁæ§: <strong>{{ activeCluster?.name || 'Êú™ÈÄâÊã©' }}</strong>
            </span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button nbButton status="primary" size="small" (click)="loadProfiles()" [disabled]="loading || !clusterId">
              <nb-icon icon="refresh-outline"></nb-icon>
              Âà∑Êñ∞
            </button>
            
            <nb-select 
              [(selected)]="selectedRefreshInterval" 
              size="small" 
              placeholder="Ëá™Âä®Âà∑Êñ∞"
              (selectedChange)="onRefreshIntervalChange($event)"
              [disabled]="!clusterId"
              style="min-width: 100px;"
            >
              <nb-option *ngFor="let option of refreshIntervalOptions" [value]="option.value">
                {{ option.label }}
              </nb-option>
            </nb-select>
          </div>
        </div>
      </nb-card-header>
      <nb-card-body>
        <div class="profile-container">
          <div *ngIf="loading" class="text-center mt-3"><nb-spinner status="primary"></nb-spinner></div>
          <ng2-smart-table 
            *ngIf="!loading" 
            [settings]="profileSettings" 
            [source]="profileSource"
            (edit)="onProfileEdit($event)">
          </ng2-smart-table>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
</div>

<!-- Profile Detail Dialog Template -->
<ng-template #profileDetailDialog let-data let-ref="dialogRef">
  <nb-card class="profile-dialog-card" 
           [ngStyle]="{'width': '90vw', 'max-width': '1400px', 'height': '85vh', 'overflow': 'hidden'}">
    <nb-card-header class="profile-dialog-header-compact">
      <div class="header-title-row">
        <span class="header-title">Query Profile</span>
        <span class="header-query-id" *ngIf="currentQueryId">{{ currentQueryId }}</span>
      </div>
      <div class="header-actions">
        <button nbButton ghost status="primary" size="tiny" (click)="refreshAnalysis()" [disabled]="profileDetailLoading">
          <nb-icon icon="refresh-outline"></nb-icon>
        </button>
        <button nbButton ghost status="basic" size="tiny" (click)="ref.close()">
          <nb-icon icon="close-outline"></nb-icon>
        </button>
      </div>
    </nb-card-header>
    <nb-card-body class="p-0">
      <nb-tabset>
        <!-- Tab 1: DAG ÊâßË°åÂàÜÊûê (ÈªòËÆ§) -->
        <nb-tab tabTitle="ÊâßË°åÂàÜÊûê" tabIcon="activity-outline">
          <div class="dag-container">
            <div *ngIf="analysisLoading" class="text-center py-5">
              <nb-spinner status="primary" size="large"></nb-spinner>
              <p class="mt-3 text-hint">Ê≠£Âú®ÂàÜÊûê Profile...</p>
            </div>
            
            <div *ngIf="!analysisLoading && analysisError" class="text-center py-5">
              <nb-icon icon="alert-triangle-outline" status="warning" class="mb-2" style="font-size: 2rem;"></nb-icon>
              <p class="text-hint">{{ analysisError }}</p>
              <p class="text-hint" style="font-size: 12px;">
                ÊèêÁ§∫: StarRocks ÁöÑ Profile Êï∞ÊçÆ‰ºöÂÆöÊúüÊ∏ÖÁêÜÔºåËæÉÊó©ÁöÑÊü•ËØ¢ÂèØËÉΩÂ∑≤Êó†Ê≥ïËé∑ÂèñËØ¶ÁªÜÂàÜÊûê„ÄÇ
              </p>
            </div>
            
            <div *ngIf="!analysisLoading && !analysisError && analysisData" class="dag-layout" [class.fullscreen-mode]="isFullscreen">

              <!-- Center Panel: Graph (No left panel, like Figure 1) -->
              <div class="dag-center-panel" 
                   (wheel)="onWheel($event)"
                   (mousedown)="startPan($event)"
                   (window:mousemove)="pan($event)"
                   (window:mouseup)="endPan()"
                   (click)="onDagPanelClick($event)">
                <!-- Toolbar -->
                <div class="dag-toolbar">
                  <button nbButton size="tiny" status="basic" ghost (click)="toggleFullscreen()" [nbTooltip]="isFullscreen ? 'ÈÄÄÂá∫ÂÖ®Â±è' : 'ÂÖ®Â±è'">
                    <nb-icon [icon]="isFullscreen ? 'collapse-outline' : 'expand-outline'"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="zoomIn()" nbTooltip="ÊîæÂ§ß">
                    <nb-icon icon="plus-outline"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="zoomOut()" nbTooltip="Áº©Â∞è">
                    <nb-icon icon="minus-outline"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="resetZoom()" nbTooltip="ÈáçÁΩÆ">
                    <nb-icon icon="maximize-outline"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="toggleGraphDirection()" [nbTooltip]="graphDirection === 'BT' ? 'ÂàáÊç¢‰∏∫Ê®™Âêë' : 'ÂàáÊç¢‰∏∫Á∫µÂêë'">
                    <nb-icon [icon]="graphDirection === 'BT' ? 'swap-outline' : 'flip-2-outline'"></nb-icon>
                  </button>
                  <button nbButton size="tiny" [status]="isFlowAnimationEnabled ? 'primary' : 'basic'" ghost (click)="toggleFlowAnimation()" [nbTooltip]="isFlowAnimationEnabled ? 'ÂÖ≥Èó≠ÊµÅÂä®ÊïàÊûú' : 'ÂºÄÂêØÊµÅÂä®ÊïàÊûú'">
                    <nb-icon icon="activity-outline"></nb-icon>
                  </button>
                  <button nbButton size="tiny" status="basic" ghost (click)="exportDagAsPng()" nbTooltip="ÂØºÂá∫ÂõæÁâá">
                    <nb-icon icon="download-outline"></nb-icon>
                  </button>
                </div>
                
                <div class="graph-viewport">
                  <div class="graph-content" 
                       [style.width.px]="graphWidth" 
                       [style.height.px]="graphHeight"
                       [style.transform]="'translate(' + translateX + 'px, ' + translateY + 'px) scale(' + zoomLevel + ')'"
                       [style.transformOrigin]="'0 0'">
                    
                    <!-- Edges SVG -->
                    <svg class="edges-svg" 
                         [attr.width]="graphWidth" 
                         [attr.height]="graphHeight">
                      <defs>
                        <marker *ngFor="let edge of graphEdges"
                                [attr.id]="edge.markerId"
                                [attr.markerWidth]="edge.arrowSize"
                                [attr.markerHeight]="edge.arrowSize"
                                [attr.refX]="edge.arrowRefX"
                                [attr.refY]="edge.arrowRefY"
                                orient="auto"
                                markerUnits="userSpaceOnUse">
                          <polygon [attr.points]="edge.arrowPoints" [attr.fill]="edge.strokeColor"/>
                        </marker>
                      </defs>
                      <g *ngFor="let edge of graphEdges">
                        <path [attr.d]="getEdgePath(edge.points)" 
                              class="edge-path edge-base" 
                              [attr.stroke]="edge.strokeColor"
                              [attr.stroke-width]="edge.strokeWidth"
                              stroke-linejoin="round"
                              [attr.marker-end]="'url(#' + edge.markerId + ')'" />
                        <path *ngIf="isFlowAnimationEnabled"
                              [attr.d]="getEdgePath(edge.points)" 
                              class="edge-path edge-flow" 
                              [attr.stroke-width]="edge.strokeWidth"
                              stroke-linejoin="round" />
                      </g>
                    </svg>
                    
                    <!-- Edge Labels -->
                    <div class="edge-labels-layer">
                      <ng-container *ngFor="let edge of graphEdges">
                        <div *ngIf="edge.labelFormatted"
                             class="edge-label-text"
                             [style.left.px]="edge.labelPos?.x"
                             [style.top.px]="edge.labelPos?.y">
                          {{ edge.labelFormatted }}
                        </div>
                      </ng-container>
                    </div>
                    
                    <!-- Nodes -->
                    <div *ngFor="let node of graphNodes" 
                         class="dag-node" [attr.data-node-id]="node.id"
                         [ngClass]="{
                           'selected': selectedNode?.id === node.id,
                           'is-top-1': getNodeRank(node) === 1, 
                           'is-top-node': getNodeRank(node) > 0,
                           'node-scan': isScanNode(node),
                           'node-join': isJoinNode(node),
                           'node-project': isProjectNode(node),
                           'node-exchange': isExchangeNode(node),
                           'node-agg': isAggregationNode(node)
                         }"
                         [style.left.px]="node.x - node.width/2"
                         [style.top.px]="node.y - node.height/2"
                         [style.width.px]="node.width"
                         (click)="selectNode(node, $event)">
                      
                      <!-- Header with dynamic color -->
                      <div class="node-header" [ngClass]="getNodeHeaderClass(node)">
                        <!-- Diagnostic warning indicator (left side) -->
                        <div *ngIf="node.has_diagnostic" class="diagnostic-indicator" nbTooltip="ËØ•ËäÇÁÇπÊúâËØäÊñ≠Âª∫ËÆÆ">‚ö†Ô∏è</div>
                        <span class="node-title">{{ node.operator_name }}</span>
                        <!-- Top N mark (right corner) -->
                        <div *ngIf="getNodeRank(node) > 1" class="top-mark" nbTooltip="Top {{ getNodeRank(node) }} ËÄóÊó∂ËäÇÁÇπ"></div>
                      </div>
                      
                      <!-- Body -->
                      <div class="node-body">
                        <div class="node-row id-row">
                          <span>plan_node_id={{ node.plan_node_id }}</span>
                        </div>
                        <!-- Horizontal layout: Time | Percentage (Â§çÂàªÂõæ1) -->
                        <div class="node-row metric-row-horizontal">
                          <span class="time-value">ËÄóÊó∂: {{ formatDurationNs(node.metrics?.operator_total_time) }}</span>
                          <span class="pct-value">{{ node.time_percentage | number:'1.2-2' }}%</span>
                        </div>
                      </div>

                      <!-- Bottom Progress Line (all nodes including Top 1) -->
                      <div class="node-bottom-progress">
                         <div class="progress-bar" [style.width.%]="node.time_percentage" [style.background]="getProgressColor(node)"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Right Panel: Dynamic content based on selection -->
              <div class="resize-handle" (mousedown)="startResizeRight($event)" [class.collapsed]="isRightPanelCollapsed"></div>
              
              <div class="dag-right-panel" [style.width.px]="isRightPanelCollapsed ? 40 : rightPanelWidth" [class.collapsed]="isRightPanelCollapsed">
                
                <!-- Top 10 By Time/Memory Section (only when no node selected) -->
                <div class="right-section top10-section" *ngIf="!selectedNode">
                  <div class="section-header">
                    <span class="title">Top 10 By {{ showMemoryView ? 'Memory' : 'Time' }}</span>
                    <span class="link" (click)="toggleMemoryView()">‚áÑ {{ showMemoryView ? 'Time' : 'Memory' }}</span>
                    <span class="collapse-toggle" (click)="toggleTop10()">{{ isTop10Collapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isTop10Collapsed && !isRightPanelCollapsed">
                    <!-- Time View -->
                    <table class="top10-table" *ngIf="!showMemoryView">
                      <thead>
                        <tr>
                          <th>ËäÇÁÇπ</th>
                          <th>Êó∂Èó¥</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let node of top10NodesByTime; let i = index" 
                            (click)="selectNodeById(node.id)" 
                            [class.selected]="selectedNode?.id === node.id">
                          <td class="node-name">{{ node.operator_name }}</td>
                          <td class="node-time">{{ node.time_percentage | number:'1.2-2' }}%</td>
                        </tr>
                        <tr *ngIf="!top10NodesByTime?.length">
                          <td colspan="2" class="text-center text-hint">ÊöÇÊó†Êï∞ÊçÆ</td>
                        </tr>
                      </tbody>
                    </table>
                    <!-- Memory View -->
                    <table class="top10-table" *ngIf="showMemoryView">
                      <thead>
                        <tr>
                          <th>ËäÇÁÇπ</th>
                          <th>ÂÜÖÂ≠ò</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let node of top10NodesByMemory; let i = index" 
                            (click)="selectNodeById(node.id)" 
                            [class.selected]="selectedNode?.id === node.id">
                          <td class="node-name">{{ node.operator_name }}</td>
                          <td class="node-memory">{{ formatBytes(node.metrics?.memory_usage) }}</td>
                        </tr>
                        <tr *ngIf="!top10NodesByMemory?.length">
                          <td colspan="2" class="text-center text-hint">ÊöÇÊó†Êï∞ÊçÆ</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Summary Section (when no node selected) -->
                <div class="right-section summary-section" *ngIf="!selectedNode">
                  <div class="section-header">
                    <span class="title">
                      ÊÄªËßà
                      <nb-icon 
                        *ngIf="analysisData?.summary?.is_profile_complete === false"
                        icon="alert-triangle-outline" 
                        status="warning"
                        class="profile-incomplete-icon"
                        [nbTooltip]="analysisData?.summary?.profile_completeness_warning || 'Profile Êï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÈÉ®ÂàÜÊåáÊ†áÂèØËÉΩÁº∫Â§±'"
                        nbTooltipPlacement="left">
                      </nb-icon>
                    </span>
                    <span class="collapse-toggle" (click)="toggleSummary()">{{ isSummaryCollapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isSummaryCollapsed && !isRightPanelCollapsed">
                    <!-- Execution Time Bar -->
                    <div class="summary-row">
                      <span class="label">Execution time</span>
                    </div>
                    <div class="exec-time-bar">
                      <div class="bar-fill io" [style.width.%]="getScanTimePercentage()"></div>
                      <div class="bar-fill processing" [style.width.%]="getCpuTimePercentage()"></div>
                    </div>
                    
                    <!-- IO Section (blue dot) - for disaggregated storage -->
                    <div class="metric-group" *ngIf="hasIoMetrics()">
                      <div class="metric-header">
                        <span class="dot io"></span>
                        <span class="name">IO</span>
                        <span class="value">{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_scan_time, getScanTimePercentage()) }}</span>
                      </div>
                      <div class="metric-sub-list">
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.io_seek_time">
                          <span class="metric-label">
                            IoSeekTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('IoSeekTime')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.io_seek_time }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.local_disk_read_io_time">
                          <span class="metric-label">
                            LocalDiskReadIOTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('LocalDiskReadIOTime')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.local_disk_read_io_time }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.remote_read_io_time">
                          <span class="metric-label">
                            RemoteReadIOTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('RemoteReadIOTime')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.remote_read_io_time }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Processing Section (yellow dot) -->
                    <div class="metric-group">
                      <div class="metric-header">
                        <span class="dot processing"></span>
                        <span class="name">Processing</span>
                        <span class="value">{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_cpu_time, getCpuTimePercentage()) }}</span>
                      </div>
                      <div class="metric-sub-list">
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_execution_wall_time">
                          <span class="metric-label">
                            ExecutionWallTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('ExecutionWallTime')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.query_execution_wall_time }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.collect_profile_time">
                          <span class="metric-label">
                            CollectProfileTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('CollectProfileTime')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.collect_profile_time }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.planner_total_time">
                          <span class="metric-label">
                            PlannerTotalTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="'Êü•ËØ¢ËÆ°ÂàíÁîüÊàêÊÄªËÄóÊó∂'"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.planner_total_time }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_cpu_time">
                          <span class="metric-label">
                            QueryCpuTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('QueryCpuTime')"></nb-icon>
                          </span>
                          <span>{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_cpu_time, getCpuTimePercentage()) }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_peak_schedule_time">
                          <span class="metric-label">
                            QueryScheduleTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('PeakScheduleTime')"></nb-icon>
                          </span>
                          <span>{{ formatTimeWithPercent(analysisData?.summary?.query_peak_schedule_time, getScheduleTimePercentage()) }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_scan_time">
                          <span class="metric-label">
                            QueryScanTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('QueryScanTime')"></nb-icon>
                          </span>
                          <span>{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_scan_time, getScanTimePercentage()) }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_cumulative_network_time">
                          <span class="metric-label">
                            QueryNetworkTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('QueryNetworkTime')"></nb-icon>
                          </span>
                          <span>{{ formatTimeWithPercent(analysisData?.summary?.query_cumulative_network_time, getNetworkTimePercentage()) }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.result_deliver_time">
                          <span class="metric-label">
                            ResultDeliverTime
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('ResultDeliverTime')"></nb-icon>
                          </span>
                          <span>{{ formatTimeWithPercent(analysisData?.summary?.result_deliver_time, getResultDeliverTimePercentage()) }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Diagnosis Summary Link -->
                    <div class="diagnosis-summary-link" *ngIf="analysisData?.aggregated_diagnostics?.length">
                      <span class="diag-icon">‚ö†Ô∏è</span>
                      <span class="diag-text">Â≠òÂú®ÊúâËØäÊñ≠Âª∫ËÆÆÁöÑÁÆóÂ≠ê</span>
                      <span class="diag-link" (click)="scrollToDiagnosis()">ËØ¶ÊÉÖ</span>
                    </div>
                    
                    <!-- IO Statistics Section -->
                    <div class="metric-group io-stats-group" *ngIf="hasIoStatistics()">
                      <div class="metric-header">
                        <span class="name">IO</span>
                      </div>
                      <div class="metric-sub-list">
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.total_raw_rows_read">
                          <span class="metric-label">
                            RawRowsRead
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('RawRowsRead')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.total_raw_rows_read | number }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.total_bytes_read_display">
                          <span class="metric-label">
                            DiskReadBytes
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('BytesRead')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.total_bytes_read_display }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.pages_count_memory">
                          <span class="metric-label">
                            PagesCountMemory
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('PagesCountMemory')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.pages_count_memory | number }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.pages_count_local_disk">
                          <span class="metric-label">
                            PagesCountLocalDisk
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('PagesCountLocalDisk')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.pages_count_local_disk | number }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.pages_count_remote">
                          <span class="metric-label">
                            PagesCountRemote
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="getMetricDescription('PagesCountRemote')"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.pages_count_remote | number }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.result_rows">
                          <span class="metric-label">
                            ResultRows
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="'ËøîÂõûÁªôÂÆ¢Êà∑Á´ØÁöÑÁªìÊûúË°åÊï∞'"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.result_rows | number }}</span>
                        </div>
                        <div class="metric-row-simple" *ngIf="analysisData?.summary?.result_bytes_display">
                          <span class="metric-label">
                            ResultBytes
                            <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                     [nbTooltip]="'ËøîÂõûÁªôÂÆ¢Êà∑Á´ØÁöÑÁªìÊûúÊï∞ÊçÆÈáè'"></nb-icon>
                          </span>
                          <span>{{ analysisData?.summary?.result_bytes_display }}</span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Other Metrics -->
                    <div class="metrics-list-simple other-metrics">
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_sum_memory_usage">
                        <span class="metric-label">
                          MemoryUsage
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('MemoryUsage')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_sum_memory_usage }}</span>
                      </div>
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.query_spill_bytes">
                        <span class="metric-label">
                          SpillBytes
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getMetricDescription('SpillBytes')"></nb-icon>
                        </span>
                        <span>{{ analysisData?.summary?.query_spill_bytes }}</span>
                      </div>
                      <!-- DataCache Hit Rate (for disaggregated storage-compute clusters) -->
                      <div class="metric-row-simple" *ngIf="analysisData?.summary?.datacache_hit_rate !== null">
                        <span class="metric-label">
                          DataCacheÂëΩ‰∏≠Áéá
                          <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                   [nbTooltip]="getDataCacheTooltip()"
                                   nbTooltipPlacement="left"></nb-icon>
                        </span>
                        <span [class.text-success]="analysisData?.summary?.datacache_hit_rate >= 0.7"
                              [class.text-warning]="analysisData?.summary?.datacache_hit_rate >= 0.3 && analysisData?.summary?.datacache_hit_rate < 0.7"
                              [class.text-danger]="analysisData?.summary?.datacache_hit_rate < 0.3">
                          {{ (analysisData?.summary?.datacache_hit_rate * 100).toFixed(1) }}%
                        </span>
                      </div>
                      <!-- Fallback when no metrics available -->
                      <div *ngIf="!hasAnyMetric()" class="text-hint text-center py-2">
                        ÊöÇÊó†ÊåáÊ†áÊï∞ÊçÆ
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Node Detail Section (when node is selected) -->
                <div class="right-section node-detail-section" *ngIf="selectedNode">
                  <div class="section-header node-detail-header">
                    <div class="node-title-area">
                      <span class="title">{{ selectedNode.operator_name }}</span>
                      <span class="node-id">(plan_node_id={{ selectedNode.plan_node_id }})</span>
                    </div>
                    <span class="close-btn" (click)="clearNodeSelection()">‚úï</span>
                  </div>
                  <div class="section-body" *ngIf="!isRightPanelCollapsed">
                    <!-- Node Tabs using Nebular -->
                    <nb-tabset class="node-detail-tabs">
                      <!-- ËäÇÁÇπ Tab (Core Metrics - like official UI) -->
                      <nb-tab tabTitle="ËäÇÁÇπ">
                        <div class="node-tab-content">
                          <!-- Execution time section (like official UI) -->
                          <div class="metric-section" *ngIf="getExecutionTimeBreakdown() as execTime">
                            <div class="section-title">Execution time</div>
                            <div class="exec-time-bar-container">
                              <div class="exec-time-bar">
                                <ng-container *ngFor="let item of execTime.items">
                                  <div class="bar-fill" [ngClass]="item.color" [style.width.%]="item.percent"></div>
                                </ng-container>
                              </div>
                            </div>
                            <div class="exec-time-legend">
                              <div class="legend-row" *ngFor="let item of execTime.items">
                                <span class="dot" [ngClass]="item.color"></span>
                                <span class="legend-label">{{ item.label }}</span>
                                <span class="legend-value">{{ item.time }}</span>
                                <span class="legend-percent">{{ item.percent | number:'1.2-2' }}%</span>
                              </div>
                            </div>
                          </div>
                          
                          <!-- Core Metrics section -->
                          <div class="metric-section" *ngIf="getNodeCoreMetrics().length">
                            <ng-container *ngFor="let metric of getNodeCoreMetrics()">
                              <div class="metric-row">
                                <span class="metric-label">
                                  {{ metric.key }}
                                  <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                           [nbTooltip]="getMetricDescription(metric.key)" 
                                           *ngIf="getMetricDescription(metric.key)"></nb-icon>
                                </span>
                                <span class="metric-value">{{ metric.value }}</span>
                              </div>
                            </ng-container>
                          </div>
                          
                          <!-- Memory section -->
                          <div class="metric-section" *ngIf="getNodeMemoryMetrics().length">
                            <div class="section-title">Memory</div>
                            <ng-container *ngFor="let metric of getNodeMemoryMetrics()">
                              <div class="metric-row">
                                <span class="metric-label">{{ metric.key }}</span>
                                <span class="metric-value">{{ metric.value }}</span>
                              </div>
                            </ng-container>
                          </div>
                          
                          <!-- Indexes section (SCAN only) -->
                          <div class="metric-section" *ngIf="getNodeIndexMetrics().length">
                            <div class="section-title">Indexes</div>
                            <ng-container *ngFor="let metric of getNodeIndexMetrics()">
                              <div class="metric-row">
                                <span class="metric-label">{{ metric.key }}</span>
                                <span class="metric-value index-value">{{ metric.value }}</span>
                              </div>
                            </ng-container>
                          </div>
                          
                          <!-- Over Consuming Metrics section -->
                          <div class="metric-section" *ngIf="getOverConsumingMetrics().length">
                            <div class="section-title">Over Consuming Metrics</div>
                            <ng-container *ngFor="let metric of getOverConsumingMetrics()">
                              <div class="metric-row over-consuming" [class.indented]="metric.indent === 1">
                                <span class="metric-label">{{ metric.key }}</span>
                                <span class="metric-value time-value">{{ metric.value }}</span>
                              </div>
                            </ng-container>
                          </div>
                          
                          <!-- Node Diagnostics -->
                          <div class="metric-section diagnostics-section" *ngIf="getNodeDiagnostics(selectedNode)?.length">
                            <div class="section-title">
                              ËØäÊñ≠Âª∫ËÆÆ
                              <span class="count-badge">{{ getNodeDiagnostics(selectedNode).length }}</span>
                            </div>
                            <div class="diagnosis-list-inline">
                              <div *ngFor="let diag of getNodeDiagnostics(selectedNode)" class="diag-item-inline">
                                <div class="diag-header-inline">
                                  <span class="diag-badge-inline" [ngClass]="{
                                    'badge-danger': diag.severity === 'Error',
                                    'badge-warning': diag.severity === 'Warning',
                                    'badge-info': diag.severity === 'Info'
                                  }">{{ diag.rule_id }}</span>
                                  <span class="diag-name-inline">{{ diag.rule_name }}</span>
                                </div>
                                <div class="diag-message-inline">{{ diag.message }}</div>
                                <div class="diag-suggestions-inline" *ngIf="diag.suggestions?.length">
                                  <div *ngFor="let suggestion of diag.suggestions" class="suggestion-item">
                                    üí° {{ suggestion }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </nb-tab>
                      
                      <!-- ËäÇÁÇπËØ¶ÊÉÖ Tab (All Operators with CommonMetrics + UniqueMetrics) -->
                      <nb-tab tabTitle="ËäÇÁÇπËØ¶ÊÉÖ">
                        <div class="metrics-list-simple node-detail-content">
                          <!-- Show operators from pipeline (like official UI) -->
                          <ng-container *ngFor="let operator of getNodeOperatorsFromPipeline(); let i = index">
                            <div class="operator-section">
                              <div class="operator-header">
                                {{ operator.name }} 
                                <span *ngIf="operator.plan_node_id">(plan_node_id={{ operator.plan_node_id }})</span>
                                <span *ngIf="operator.operator_id"> (operator id={{ operator.operator_id }})</span>
                              </div>
                              
                              <!-- CommonMetrics -->
                              <div class="metrics-group" *ngIf="operator.common_metrics && objectKeys(operator.common_metrics).length">
                                <div class="metrics-group-header">CommonMetrics:</div>
                                <div class="metric-row-simple" *ngFor="let key of objectKeys(operator.common_metrics)">
                                  <span class="metric-label">
                                    {{ key }}
                                    <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                             [nbTooltip]="getMetricDescription(key)" 
                                             *ngIf="getMetricDescription(key)"></nb-icon>
                                  </span>
                                  <span>{{ operator.common_metrics[key] }}</span>
                                </div>
                              </div>
                              
                              <!-- UniqueMetrics -->
                              <div class="metrics-group" *ngIf="operator.unique_metrics && objectKeys(operator.unique_metrics).length">
                                <div class="metrics-group-header">UniqueMetrics:</div>
                                <div class="metric-row-simple" *ngFor="let key of objectKeys(operator.unique_metrics)">
                                  <span class="metric-label">
                                    {{ key }}
                                    <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                             [nbTooltip]="getMetricDescription(key)" 
                                             *ngIf="getMetricDescription(key)"></nb-icon>
                                  </span>
                                  <span>{{ operator.unique_metrics[key] }}</span>
                                </div>
                              </div>
                            </div>
                          </ng-container>
                          
                          <!-- Fallback: show node's own metrics if no operators found -->
                          <ng-container *ngIf="!getNodeOperatorsFromPipeline().length">
                            <ng-container *ngIf="selectedNode.metrics">
                              <div class="metric-category-header">Âü∫Á°ÄÊåáÊ†á</div>
                              <div class="metric-row-simple" *ngFor="let key of getMetricKeys(selectedNode.metrics)">
                                <span class="metric-label">{{ key }}</span>
                                <span>{{ formatMetricValue(key, selectedNode.metrics[key]) }}</span>
                              </div>
                            </ng-container>
                            
                            <ng-container *ngIf="selectedNode.unique_metrics && objectKeys(selectedNode.unique_metrics).length">
                              <div class="metric-category-header">ÂîØ‰∏ÄÊåáÊ†á</div>
                              <div class="metric-row-simple" *ngFor="let key of objectKeys(selectedNode.unique_metrics)">
                                <span class="metric-label">{{ key }}</span>
                                <span>{{ formatMetricValue(key, selectedNode.unique_metrics[key]) }}</span>
                              </div>
                            </ng-container>
                          </ng-container>
                          
                          <div *ngIf="!getNodeOperatorsFromPipeline().length && !selectedNode.metrics && !selectedNode.unique_metrics" 
                               class="text-hint text-center py-2">
                            ÊöÇÊó†ËØ¶ÁªÜÊåáÊ†á
                          </div>
                        </div>
                      </nb-tab>
                      
                      <!-- Pipeline Tab (Fragment + Pipeline info like official UI) -->
                      <nb-tab tabTitle="Pipeline">
                        <div class="metrics-list-simple pipeline-content">
                          <!-- Fragment Section -->
                          <div class="pipeline-section" *ngIf="selectedNode.fragment_id">
                            <div class="pipeline-section-header">
                              Fragment {{ selectedNode.fragment_id }}:
                            </div>
                            
                            <!-- Fragment basic info -->
                            <ng-container *ngFor="let metric of getFragmentMetrics()">
                              <div class="metric-row-simple">
                                <span class="metric-label">
                                  {{ metric.key }}
                                  <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                           [nbTooltip]="getMetricDescription(metric.key)" 
                                           *ngIf="getMetricDescription(metric.key)"></nb-icon>
                                </span>
                                <span>{{ metric.value }}</span>
                              </div>
                            </ng-container>
                          </div>
                          
                          <!-- Pipeline Section -->
                          <div class="pipeline-section" *ngIf="selectedNode.pipeline_id">
                            <div class="pipeline-section-header">
                              Pipeline (id={{ selectedNode.pipeline_id }}):
                            </div>
                            
                            <!-- Pipeline metrics -->
                            <ng-container *ngFor="let metric of getPipelineMetrics()">
                              <div class="metric-row-simple">
                                <span class="metric-label">
                                  {{ metric.key }}
                                  <nb-icon icon="question-mark-circle-outline" class="metric-hint" 
                                           [nbTooltip]="getMetricDescription(metric.key)" 
                                           *ngIf="getMetricDescription(metric.key)"></nb-icon>
                                </span>
                                <span>{{ metric.value }}</span>
                              </div>
                            </ng-container>
                          </div>
                          
                          <!-- Fallback: basic node info if no fragment/pipeline -->
                          <ng-container *ngIf="!selectedNode.fragment_id && !selectedNode.pipeline_id">
                            <div class="metric-row-simple">
                              <span class="metric-label">Depth</span>
                              <span>{{ selectedNode.depth }}</span>
                            </div>
                            <div class="metric-row-simple">
                              <span class="metric-label">NodeType</span>
                              <span>{{ selectedNode.node_type }}</span>
                            </div>
                            
                            <!-- Hotspot info -->
                            <div class="metric-row-simple" *ngIf="selectedNode.is_hotspot">
                              <span class="metric-label">IsHotspot</span>
                              <span class="badge badge-danger">Yes</span>
                            </div>
                            
                            <div class="text-hint text-center py-2">
                              Pipeline ‰ø°ÊÅØÊöÇ‰∏çÂèØÁî®
                            </div>
                          </ng-container>
                        </div>
                      </nb-tab>
                    </nb-tabset>
                  </div>
                </div>

                <!-- Root Cause Analysis Section - Loading state for LLM -->
                <div class="right-section root-cause-section" *ngIf="!selectedNode && (llmAnalysisLoading || llmAnalysisError || getRootCauseAnalysis()?.root_causes?.length)">
                  <div class="section-header">
                    <span class="title">üîç Ê†πÂõ†ÂàÜÊûê</span>
                    <span class="warning-badge" *ngIf="!llmAnalysisLoading && !llmAnalysisError">{{ getRootCauseAnalysis()?.root_causes?.length || 0 }}</span>
                    
                    <!-- Loading state -->
                    <span class="llm-loading-badge" *ngIf="llmAnalysisLoading">
                      <nb-icon icon="loader-outline" class="spin"></nb-icon>
                      <span>LLM ÂàÜÊûê‰∏≠...</span>
                    </span>
                    
                    <!-- Success state with time -->
                    <span class="llm-badge" *ngIf="!llmAnalysisLoading && !llmAnalysisError && hasLLMAnalysis()">
                      ü§ñ LLM
                      <span class="llm-time" *ngIf="getLLMElapsedTime()">{{ getLLMElapsedTime() }}</span>
                      <span class="llm-cached" *ngIf="isLLMAnalysisCached()" nbTooltip="‰ªéÁºìÂ≠òÂä†ËΩΩÔºåÁÇπÂáªÂà∑Êñ∞ÈáçÊñ∞ÂàÜÊûê">üì¶</span>
                    </span>
                    
                    <!-- Error state -->
                    <span class="llm-error-badge" *ngIf="llmAnalysisError">
                      <nb-icon icon="alert-circle-outline"></nb-icon>
                      <span>ÂàÜÊûêÂ§±Ë¥•</span>
                    </span>
                    
                    <!-- Refresh button (always visible when not loading) -->
                    <button nbButton 
                            ghost 
                            size="tiny" 
                            status="info"
                            *ngIf="!llmAnalysisLoading"
                            (click)="retryLLMAnalysis()"
                            [nbTooltip]="llmAnalysisError ? 'ÈáçËØï LLM ÂàÜÊûê' : 'Âà∑Êñ∞ LLM ÂàÜÊûê'"
                            class="llm-refresh-btn">
                      <nb-icon icon="sync-outline"></nb-icon>
                    </button>
                    
                    <span class="collapse-toggle" (click)="isRootCauseCollapsed = !isRootCauseCollapsed">{{ isRootCauseCollapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isRootCauseCollapsed && !isRightPanelCollapsed">
                    <!-- Summary (LLM provides richer summary) -->
                    <div class="root-cause-summary" *ngIf="!llmAnalysisError && getRootCauseAnalysis().summary">
                      <nb-icon icon="bulb-outline" class="text-warning"></nb-icon>
                      <span>{{ getRootCauseAnalysis().summary }}</span>
                    </div>
                    
                    <!-- Hidden Issues from LLM -->
                    <div class="hidden-issues" *ngIf="getRootCauseAnalysis().hidden_issues?.length">
                      <div class="hidden-issue-header">
                        <nb-icon icon="eye-off-outline" class="text-info"></nb-icon>
                        <span>ÈöêÂºèÈóÆÈ¢ò (ËßÑÂàôÂºïÊìéÊú™Ê£ÄÊµãÂà∞)</span>
                      </div>
                      <div *ngFor="let issue of getRootCauseAnalysis().hidden_issues" class="hidden-issue-item">
                        <div class="issue-desc">‚ö†Ô∏è {{ issue.issue }}</div>
                        <div class="issue-suggestion" *ngIf="issue.suggestion">üí° {{ issue.suggestion }}</div>
                      </div>
                    </div>
                    
                    <!-- Root Causes List -->
                    <div class="root-cause-list">
                      <div *ngFor="let rc of getRootCauseAnalysis().root_causes; let i = index" 
                           class="root-cause-item"
                           [ngClass]="{
                             'high-impact': rc.impact_percentage >= 40 || rc.confidence >= 0.8,
                             'llm-source': rc.source === 'llm' || rc.source === 'both',
                             'implicit': rc.is_implicit
                           }">
                        <div class="rc-header">
                          <span class="rc-id">{{ rc.id || rc.root_cause_id }}</span>
                          <!-- Show confidence for LLM, impact_percentage for rule -->
                          <span class="rc-impact" *ngIf="rc.confidence" [ngClass]="{
                            'high': rc.confidence >= 0.8,
                            'medium': rc.confidence >= 0.5 && rc.confidence < 0.8,
                            'low': rc.confidence < 0.5
                          }">ÁΩÆ‰ø°Â∫¶ {{ rc.confidence * 100 | number:'1.0-0' }}%</span>
                          <span class="rc-impact" *ngIf="!rc.confidence && rc.impact_percentage" [ngClass]="{
                            'high': rc.impact_percentage >= 40,
                            'medium': rc.impact_percentage >= 20 && rc.impact_percentage < 40,
                            'low': rc.impact_percentage < 20
                          }">ÂΩ±ÂìçÂ∫¶ {{ rc.impact_percentage | number:'1.0-0' }}%</span>
                          <span class="source-badge" *ngIf="rc.source">
                            {{ rc.source === 'llm' ? 'ü§ñ' : rc.source === 'both' ? 'üîó' : 'üìã' }}
                          </span>
                          <span class="implicit-badge" *ngIf="rc.is_implicit">ÈöêÂºè</span>
                        </div>
                        <div class="rc-description">{{ rc.description }}</div>
                        <!-- Related rule IDs -->
                        <div class="rc-rules" *ngIf="rc.diagnostic_ids?.length || rc.related_rule_ids?.length || rc.symptoms?.length">
                          <span class="rule-badge" *ngFor="let ruleId of (rc.diagnostic_ids || rc.related_rule_ids || rc.symptoms)">{{ ruleId }}</span>
                        </div>
                        <!-- Evidence (LLM provides detailed evidence from profile metrics) -->
                        <div class="rc-evidence" *ngIf="rc.evidence?.length">
                          <div *ngFor="let ev of rc.evidence" class="evidence-item">
                            <nb-icon icon="checkmark-circle-2-outline" class="text-success"></nb-icon>
                            <span class="text-hint">{{ ev }}</span>
                          </div>
                        </div>
                        <!-- Suggestions (rule-based) -->
                        <div class="rc-suggestions" *ngIf="rc.suggestions?.length">
                          <div *ngFor="let sug of rc.suggestions" class="suggestion-item">
                            <span class="icon">üí°</span>
                            <span>{{ sug }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Causal Chains - Visual chain display -->
                    <div class="causal-chains" *ngIf="getRootCauseAnalysis().causal_chains?.length">
                      <div class="chain-header">
                        <nb-icon icon="trending-up-outline" class="text-info"></nb-icon>
                        <span>Âõ†ÊûúÈìæ</span>
                        <span class="chain-count">({{ getRootCauseAnalysis().causal_chains.length }})</span>
                      </div>
                      <div class="chain-list">
                        <div *ngFor="let chain of getRootCauseAnalysis().causal_chains; let i = index" class="chain-item">
                          <ng-container *ngFor="let node of chain.chain; let j = index; let last = last">
                            <span *ngIf="node !== '‚Üí'" class="chain-node" [ngClass]="{
                              'root-cause': j === 0,
                              'symptom': last
                            }">
                              <nb-icon *ngIf="j === 0" icon="alert-circle-outline" class="node-icon"></nb-icon>
                              <nb-icon *ngIf="last && j > 0" icon="flag-outline" class="node-icon"></nb-icon>
                              {{ node }}
                            </span>
                            <span *ngIf="node === '‚Üí'" class="chain-arrow">
                              <nb-icon icon="arrow-forward-outline"></nb-icon>
                            </span>
                          </ng-container>
                          <!-- Chain explanation -->
                          <div class="chain-explanation" *ngIf="chain.explanation">
                            <span class="text-hint">{{ chain.explanation }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>

                <!-- Unified Diagnosis & Recommendations Section -->
                <!-- When LLM analysis is available, show ONLY LLM recommendations (override rules) -->
                <div class="right-section diagnosis-section" *ngIf="!selectedNode && (getCurrentDiagnosticsCount() > 0 || (hasLLMAnalysis() && getRootCauseAnalysis().recommendations?.length))">
                  <div class="section-header">
                    <span class="title">ËØäÊñ≠Âª∫ËÆÆ</span>
                    <span class="warning-badge">{{ getEffectiveRecommendationsCount() }}</span>
                    <span class="llm-badge" *ngIf="hasLLMAnalysis() && getRootCauseAnalysis().recommendations?.length">ü§ñ LLM</span>
                    <span class="collapse-toggle" (click)="toggleDiagnosis()">{{ isDiagnosisCollapsed ? '‚à® Â±ïÂºÄ' : '‚àß Êî∂Ëµ∑' }}</span>
                  </div>
                  <div class="section-body" *ngIf="!isDiagnosisCollapsed && !isRightPanelCollapsed">
                      <!-- LLM Recommendations (completely override rule-based when available) -->
                      <div *ngIf="hasLLMAnalysis() && getRootCauseAnalysis().recommendations?.length" class="llm-recommendations-merged">
                        <div *ngFor="let rec of getRootCauseAnalysis().recommendations; let i = index" 
                             class="rec-item llm-rec">
                          <div class="rec-priority">
                            <span class="priority-num">{{ rec.priority || (i + 1) }}</span>
                          </div>
                          <div class="rec-content">
                            <div class="rec-action">{{ rec.action }}</div>
                            <div class="rec-improvement" *ngIf="rec.expected_improvement">
                              <nb-icon icon="trending-up-outline" class="text-success"></nb-icon>
                              <span>{{ rec.expected_improvement }}</span>
                            </div>
                            <div class="rec-sql" *ngIf="rec.sql_example">
                              <pre><code (click)="copyToClipboard(rec.sql_example)" nbTooltip="ÁÇπÂáªÂ§çÂà∂">{{ rec.sql_example }}</code></pre>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Rule-based Diagnostics (only show when NO LLM recommendations) -->
                      <div *ngIf="!(hasLLMAnalysis() && getRootCauseAnalysis().recommendations?.length) && analysisData?.aggregated_diagnostics?.length" class="diagnosis-list">
                        <div *ngFor="let diag of analysisData?.aggregated_diagnostics" class="diagnosis-item-detailed">
                          <div class="diag-header">
                            <span class="diag-badge" [ngClass]="{
                              'badge-danger': diag.severity === 'Error',
                              'badge-warning': diag.severity === 'Warning',
                              'badge-info': diag.severity === 'Info'
                            }">{{ diag.rule_id }}</span>
                            <span class="diag-name">{{ diag.rule_name }}</span>
                            <span class="node-count-badge" *ngIf="diag.node_count > 1">√ó{{ diag.node_count }} ‰∏™ËäÇÁÇπ</span>
                          </div>
                          <div class="diag-message">{{ diag.message }}</div>
                          <div class="diag-reason" *ngIf="diag.reason">
                            <nb-icon icon="info-outline" class="text-info"></nb-icon>
                            <span class="reason-text">{{ diag.reason }}</span>
                          </div>
                          <div class="diag-affected-nodes" *ngIf="diag.affected_nodes?.length">
                            <nb-icon icon="pin-outline" class="text-hint"></nb-icon>
                            <span class="text-hint">Ê∂âÂèäËäÇÁÇπ: {{ diag.affected_nodes.join(', ') }}</span>
                          </div>
                          <div class="diag-suggestions" *ngIf="diag.suggestions?.length">
                            <div *ngFor="let suggestion of diag.suggestions" class="diag-suggestion">
                              <span class="icon">üí°</span>
                              <span>{{ suggestion }}</span>
                            </div>
                          </div>
                          <div class="diag-params" *ngIf="diag.parameter_suggestions?.length">
                            <div *ngFor="let param of diag.parameter_suggestions" class="param-item">
                              <div class="param-header">
                                <nb-icon icon="settings-2-outline" class="text-primary"></nb-icon>
                                <span class="param-name">{{ param.name }}</span>
                                <span class="param-type badge badge-basic">{{ param.param_type }}</span>
                              </div>
                              <div class="param-description" *ngIf="param.description">
                                <span class="text-hint">{{ param.description }}</span>
                              </div>
                              <div class="param-impact" *ngIf="param.impact">
                                <nb-icon icon="trending-up-outline" class="text-success"></nb-icon>
                                <span class="impact-text">{{ param.impact }}</span>
                              </div>
                              <div class="param-value-row">
                                <span class="text-hint" *ngIf="param.current">ÂΩìÂâçÂÄº: <code>{{ param.current }}</code> ‚Üí</span>
                                <span class="text-hint">Êé®ËçêÂÄº:</span>
                                <code class="recommended-value">{{ param.recommended }}</code>
                              </div>
                              <div class="param-command" *ngIf="param.command">
                                <code class="command-text" (click)="copyToClipboard(param.command)" nbTooltip="ÁÇπÂáªÂ§çÂà∂">{{ param.command }}</code>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div *ngIf="!analysisData?.aggregated_diagnostics?.length && analysisData?.suggestions?.length" class="diagnosis-list">
                        <div *ngFor="let suggestion of analysisData?.suggestions" class="diagnosis-item">
                          <span class="icon">üí°</span>
                          <span class="text">{{ suggestion }}</span>
                        </div>
                      </div>
                      <div *ngIf="!analysisData?.aggregated_diagnostics?.length && !analysisData?.suggestions?.length" class="empty-diagnosis">
                        ÊöÇÊó†ËØäÊñ≠Âª∫ËÆÆ
                      </div>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </nb-tab>
        
        <!-- Tab 2: Profile ÂéüÂßãÊñáÊú¨ -->
        <nb-tab tabTitle="ProfileËØ¶ÊÉÖ" tabIcon="file-text-outline">
          <nb-card accent="basic" class="m-0">
            <nb-card-body class="profile-scroll-container position-relative">
              <div *ngIf="profileDetailLoading" class="text-center py-4">
                <nb-spinner status="primary" size="large"></nb-spinner>
                <p class="mt-3 text-hint">Âä†ËΩΩ Profile ËØ¶ÊÉÖ‰∏≠...</p>
              </div>

              <div class="profile-copy-overlay" *ngIf="!profileDetailLoading" style="position: absolute; top: 0.5rem; right: 0.5rem; left: auto; z-index: 10;">
                <button
                  nbButton
                  status="basic"
                  size="small"
                  (click)="copyProfileToClipboard()"
                  [disabled]="!currentProfileDetail"
                  nbTooltip="Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø"
                  nbTooltipPlacement="left"
                >
                  <nb-icon icon="copy-outline"></nb-icon>
                </button>
              </div>
              <div *ngIf="!profileDetailLoading" class="profile-pre-wrapper">
                <div *ngIf="!currentProfileDetail || currentProfileDetail.trim() === ''" class="text-center py-4 text-hint">
                  <nb-icon icon="file-text-outline" status="basic" class="mb-2"></nb-icon>
                  <p>ÊöÇÊó† Profile Êï∞ÊçÆ</p>
                </div>
                <pre *ngIf="currentProfileDetail && currentProfileDetail.trim() !== ''" class="profile-content-text">{{ currentProfileDetail }}</pre>
              </div>
            </nb-card-body>
          </nb-card>
        </nb-tab>
      </nb-tabset>
    </nb-card-body>
  </nb-card>
</ng-template>
