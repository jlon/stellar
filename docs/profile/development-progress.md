# Profile è¯Šæ–­ç³»ç»Ÿå¼€å‘è¿›åº¦è¿½è¸ª

> **ç‰ˆæœ¬**: v1.2
> **æ—¥æœŸ**: 2024-12-07
> **çŠ¶æ€**: é˜ˆå€¼åˆç†æ€§æ·±åº¦åæ€ (v2.0) å·²å®Œæˆ
> **ç›®æ ‡**: å®æ–½å®¡æŸ¥æ–‡æ¡£ (v2.1) çš„æ‰€æœ‰å»ºè®®

---

## å¼€å‘å‘¨æœŸè§„åˆ’

```
æ€»å·¥ä½œé‡ï¼š18-20 äººæ—¥
å®æ–½å‘¨æœŸï¼š3-4 å‘¨
å½“å‰é˜¶æ®µï¼šP1/P2 å¤§éƒ¨åˆ†å®Œæˆ
```

---

## Phase 1: P0 å…³é”®ä¿®å¤ (Week 1) - 2.5 å¤© âœ… å·²å®Œæˆ

### ç›®æ ‡
æ¶ˆé™¤æ¯«ç§’çº§æŸ¥è¯¢çš„è¯¯æŠ¥ï¼Œä¿®å¤è§„åˆ™æ¡ä»¶ä¿æŠ¤ï¼Œè¡¥å…¨å•å…ƒæµ‹è¯•ã€‚

### ä»»åŠ¡åˆ†è§£

#### Task P0.1: å…¨å±€æ‰§è¡Œæ—¶é—´é—¨æ§› âœ… å·²å®Œæˆ
- **å·¥ä½œé‡**: 0.5 å¤©
- **ä¼˜å…ˆçº§**: ğŸ”´ é«˜
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **ç›®æ ‡**:
  - [x] åœ¨ RuleEngine æ·»åŠ å…¨å±€æ—¶é—´é—¨æ§›æ£€æŸ¥ (â‰¥1s)
  - [x] ä¿®æ”¹ `analyze_with_cluster_variables` æ–¹æ³•
  - [x] å¿«é€ŸæŸ¥è¯¢ï¼ˆ<1sï¼‰ç›´æ¥è¿”å›ç©ºè¯Šæ–­

**éªŒæ”¶æ ‡å‡†**:
- profile2 (11ms) ä¸äº§ç”Ÿä»»ä½•è¯Šæ–­ âœ…
- profile1 (>1s) æ­£å¸¸äº§ç”Ÿè¯Šæ–­ âœ…

**å…³é”®ä»£ç ä½ç½®**:
- `backend/src/services/profile_analyzer/analyzer/rule_engine.rs:65-73`
- `backend/src/services/profile_analyzer/analyzer/thresholds.rs` (MIN_DIAGNOSIS_TIME_SECONDS)

---

#### Task P0.2: è§„åˆ™æ¡ä»¶è¡¥å……ï¼ˆæ ·æœ¬/ç»å¯¹å€¼ä¿æŠ¤ï¼‰ âœ… å·²å®Œæˆ
- **å·¥ä½œé‡**: 1.5 å¤©
- **ä¼˜å…ˆçº§**: ğŸ”´ é«˜
- **ä¾èµ–**: P0.1 å®Œæˆ
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **ç›®æ ‡**:
  - [x] ä¸º 6 æ¡è§„åˆ™æ·»åŠ ä¿æŠ¤æ¡ä»¶ï¼ˆS001, S002, S003, J001, A001, G003ï¼‰
  - [x] ä½¿ç”¨ thresholds æ¨¡å—çš„å¸¸é‡
  - [x] ä¿®æ”¹è§„åˆ™è¯„ä¼°é€»è¾‘

**å·²ä¿®å¤çš„è§„åˆ™**:

| è§„åˆ™ | å½“å‰æ¡ä»¶ | æ–°å¢ä¿æŠ¤ | æ–‡ä»¶ |
|------|---------|---------|------|
| **S001** | max/avg > threshold | min_rows â‰¥ 100k, åŠ¨æ€é˜ˆå€¼ | `scan.rs` âœ… |
| **S002** | max(IOTime)/avg > threshold | min_time â‰¥ 500ms, åŠ¨æ€é˜ˆå€¼ | `scan.rs` âœ… |
| **S003** | output/input > 80% | min_rows â‰¥ 100k | `scan.rs` âœ… |
| **J001** | output/probe > 10 | min_rows â‰¥ 10k | `join.rs` âœ… |
| **A001** | max/avg > threshold | min_rows â‰¥ 100k, åŠ¨æ€é˜ˆå€¼ | `aggregate.rs` âœ… |
| **G003** | max(time)/avg > threshold | min_time â‰¥ 500ms, åŠ¨æ€é˜ˆå€¼ | `common.rs` âœ… |

---

#### Task P0.3: å•å…ƒæµ‹è¯•è¡¥å…¨ âœ… å·²å®Œæˆ
- **å·¥ä½œé‡**: 0.5 å¤©
- **ä¼˜å…ˆçº§**: ğŸ”´ é«˜
- **ä¾èµ–**: P0.1, P0.2 å®Œæˆ
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **ç›®æ ‡**:
  - [ ] æ·»åŠ å¿«é€ŸæŸ¥è¯¢æµ‹è¯•
  - [ ] æ·»åŠ æ ·æœ¬ä¿æŠ¤æµ‹è¯•ï¼ˆ6 æ¡è§„åˆ™ï¼‰
  - [ ] æ·»åŠ ç»å¯¹å€¼ä¿æŠ¤æµ‹è¯•
  - [ ] è¾¾åˆ° > 90% è¦†ç›–ç‡

**æµ‹è¯•æ¸…å•**:
```rust
// P0.1 ç›¸å…³
#[test]
fn test_fast_query_no_diagnostics() {
    // profile2 (11ms) åº”æ— è¯Šæ–­
}

#[test]
fn test_slow_query_has_diagnostics() {
    // profile1 (>1s) åº”æœ‰è¯Šæ–­
}

// P0.2 ç›¸å…³ï¼ˆæ¯æ¡è§„åˆ™ï¼‰
#[test]
fn test_s001_sample_protection() {
    // åªæœ‰ 3 ä¸ªåˆ†ç‰‡çš„å€¾æ–œä¸æŠ¥å‘Š
}

#[test]
fn test_s001_absolute_protection() {
    // 100 è¡Œå€¾æ–œä¸æŠ¥å‘Šï¼ˆå³ä½¿ max/avg > 2ï¼‰
}

// ... å…¶ä»– 5 æ¡è§„åˆ™ç±»ä¼¼
```

**å…³é”®ä»£ç ä½ç½®**:
- `backend/tests/profile_analyzer_tests.rs`

---

## Phase 2: P1 é‡è¦æ”¹è¿› (Week 2) - 3.5 å¤©

### ç›®æ ‡
å®ç°æŸ¥è¯¢ç±»å‹æ„ŸçŸ¥ã€è§„åˆ™å…³ç³»é‡æ„ã€å¤–è¡¨ç±»å‹å®Œå–„ã€‚

#### Task P1.1: æŸ¥è¯¢ç±»å‹æ„ŸçŸ¥æ¡†æ¶ âœ… å·²å®Œæˆ
- **å·¥ä½œé‡**: 0.5 å¤©
- **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **ç›®æ ‡**: è¯†åˆ« 6 ç§æŸ¥è¯¢ç±»å‹ï¼Œåº”ç”¨ä¸åŒé˜ˆå€¼

**å·²å®ç°**:
- [x] `QueryType` æšä¸¾: Select, Insert, Export, Analyze, Ctas, Load, Unknown
- [x] `QueryType::from_sql()` ä» SQL è¯­å¥æ£€æµ‹æŸ¥è¯¢ç±»å‹
- [x] `QueryType::get_time_threshold_ms()` è¿”å›æŸ¥è¯¢ç±»å‹ç‰¹å®šçš„æ—¶é—´é˜ˆå€¼
- [x] `QueryType::should_skip_rule()` æ ¹æ®æŸ¥è¯¢ç±»å‹è·³è¿‡ä¸é€‚ç”¨çš„è§„åˆ™
- [x] Q001 è§„åˆ™å·²æ›´æ–°ä½¿ç”¨æŸ¥è¯¢ç±»å‹ç‰¹å®šçš„æ—¶é—´é˜ˆå€¼
- [x] RuleEngine é›†æˆ QueryType æ£€æµ‹å’Œè§„åˆ™è·³è¿‡é€»è¾‘

**å…³é”®ä»£ç ä½ç½®**:
- `backend/src/services/profile_analyzer/analyzer/thresholds.rs` (QueryType)
- `backend/src/services/profile_analyzer/analyzer/rule_engine.rs` (é›†æˆ)
- `backend/src/services/profile_analyzer/analyzer/rules/query.rs` (Q001)

#### Task P1.2: è§„åˆ™å…³ç³»é‡æ„ â³ å¾…å¼€å§‹
- **å·¥ä½œé‡**: 1.5 å¤©
- **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
- **ä¾èµ–**: P1.1 å®Œæˆ
- **çŠ¶æ€**: å¾…å¼€å§‹
- **ç›®æ ‡**: å®ç°äº’æ–¥/å› æœ/å…ˆå†³/è¡¥å……/ç‹¬ç«‹/å¦å®š 6 ç§å…³ç³»

#### Task P1.3: å°æ–‡ä»¶æ£€æµ‹è§„åˆ™ (S016) + å¤–è¡¨ç±»å‹å®Œæ•´è¦†ç›– âœ… å·²å®Œæˆ
- **å·¥ä½œé‡**: 1 å¤©
- **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **ç›®æ ‡**: æ”¯æŒ HDFS/S3/OSS ç­‰å¤–è¡¨ç±»å‹ï¼Œå®ç°å®¡æŸ¥æ–‡æ¡£ç¬¬äº”èŠ‚

**å·²å®ç°**:
- [x] S016SmallFiles è§„åˆ™å®ç°
- [x] **ExternalScanType æšä¸¾** (å®¡æŸ¥æ–‡æ¡£ v2.0 ç¬¬äº”èŠ‚):
  - æ•°æ®æ¹–æ ¼å¼: Hive, Iceberg, Hudi, DeltaLake, Paimon
  - æ–‡ä»¶ç³»ç»Ÿ: Hdfs, File, S3
  - å¤–éƒ¨æ•°æ®åº“: Jdbc, Mysql, Elasticsearch
  - é€šç”¨è¿æ¥å™¨: Connector
- [x] `ExternalScanType::from_operator_name()` - ä»ç®—å­åæ£€æµ‹å¤–è¡¨ç±»å‹
- [x] `ExternalScanType::supports_small_file_detection()` - åˆ¤æ–­æ˜¯å¦æ”¯æŒå°æ–‡ä»¶æ£€æµ‹
- [x] `ExternalScanType::storage_type()` - è·å–å­˜å‚¨ç±»å‹ç”¨äºé˜ˆå€¼è®¡ç®—
- [x] `ExternalScanType::file_count_metric()` - è·å–æ–‡ä»¶æ•°é‡æŒ‡æ ‡å
- [x] `ExternalScanType::display_name()` - è·å–æ˜¾ç¤ºåç§°
- [x] `generate_small_file_suggestions()` - æ ¹æ®å¤–è¡¨ç±»å‹ç”Ÿæˆé’ˆå¯¹æ€§å»ºè®®
- [x] S016 è§„åˆ™å·²æ›´æ–°ä½¿ç”¨ ExternalScanType
- [x] ä½¿ç”¨åŠ¨æ€é˜ˆå€¼: `get_small_file_threshold()`, `get_min_file_count()`

**å…³é”®ä»£ç ä½ç½®**:
- `backend/src/services/profile_analyzer/analyzer/thresholds.rs` (ExternalScanType, generate_small_file_suggestions)
- `backend/src/services/profile_analyzer/analyzer/rules/scan.rs` (S016SmallFiles)

#### Task P1.4: æŒ‡æ ‡æ˜ å°„è¡¨å»ºè®¾ â³ å¾…å¼€å§‹
- **å·¥ä½œé‡**: 0.5 å¤©
- **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
- **çŠ¶æ€**: å¾…å¼€å§‹
- **ç›®æ ‡**: å»ºç«‹ 50+ æŒ‡æ ‡çš„å…ƒæ•°æ®ä»“åº“

---

## Phase 3: P2 å®Œå–„ä¼˜åŒ– (Week 3) - 2 å¤©

#### Task P2.1: åŠ¨æ€é˜ˆå€¼å®ç° âœ… å·²å®Œæˆ
- **å·¥ä½œé‡**: 1 å¤©
- **ä¼˜å…ˆçº§**: ğŸŸ¢ ä½
- **çŠ¶æ€**: âœ… å·²å®Œæˆ
- **ç›®æ ‡**: æ”¯æŒ 5+ å‚æ•°çš„åŠ¨æ€è®¡ç®—

**å·²å®ç°**:
- [x] `DynamicThresholds` ç»“æ„ä½“ï¼ŒåŸºäº ClusterInfo å’Œ QueryType è®¡ç®—é˜ˆå€¼
- [x] å†…å­˜é˜ˆå€¼: `get_operator_memory_threshold()` (BE å†…å­˜çš„ 10%, 1GB-10GB)
- [x] HashTable é˜ˆå€¼: `get_hash_table_memory_threshold()` (BE å†…å­˜çš„ 5%, 512MB-5GB)
- [x] å€¾æ–œé˜ˆå€¼: `get_skew_threshold()` (æ ¹æ®é›†ç¾¤å¤§å°åŠ¨æ€è°ƒæ•´ 2.0-3.5)
- [x] æ—¶é—´é˜ˆå€¼: `get_query_time_threshold_ms()` (æ ¹æ®æŸ¥è¯¢ç±»å‹)
- [x] å°æ–‡ä»¶é˜ˆå€¼: `get_small_file_threshold()` (æ ¹æ®å­˜å‚¨ç±»å‹)
- [x] ç¼“å­˜å‘½ä¸­é˜ˆå€¼: `get_cache_hit_threshold()`
- [x] è¡Œæ•°é˜ˆå€¼: `get_min_rows_for_skew()`, `get_min_rows_for_filter()`, `get_min_rows_for_join()`

**å·²æ›´æ–°çš„è§„åˆ™**:
| è§„åˆ™ | åŠ¨æ€é˜ˆå€¼ | è¯´æ˜ |
|------|---------|------|
| S001 | `get_skew_threshold()` | æ•°æ®å€¾æ–œé˜ˆå€¼æ ¹æ®é›†ç¾¤å¤§å°è°ƒæ•´ |
| S002 | `get_skew_threshold()` | IO å€¾æ–œé˜ˆå€¼æ ¹æ®é›†ç¾¤å¤§å°è°ƒæ•´ |
| G002 | `get_operator_memory_threshold()` | å†…å­˜é˜ˆå€¼æ ¹æ® BE å†…å­˜è°ƒæ•´ |
| G003 | `get_skew_threshold()` | æ‰§è¡Œæ—¶é—´å€¾æ–œé˜ˆå€¼æ ¹æ®é›†ç¾¤å¤§å°è°ƒæ•´ |
| J003 | `get_hash_table_memory_threshold()` | HashTable å†…å­˜é˜ˆå€¼æ ¹æ® BE å†…å­˜è°ƒæ•´ |
| J006 | `get_skew_threshold()` | Shuffle å€¾æ–œé˜ˆå€¼æ ¹æ®é›†ç¾¤å¤§å°è°ƒæ•´ |
| A001 | `get_skew_threshold()` | èšåˆå€¾æ–œé˜ˆå€¼æ ¹æ®é›†ç¾¤å¤§å°è°ƒæ•´ |
| A002 | `get_hash_table_memory_threshold()` | HashTable å†…å­˜é˜ˆå€¼æ ¹æ® BE å†…å­˜è°ƒæ•´ |
| Q001 | `get_time_threshold_ms()` | æ‰§è¡Œæ—¶é—´é˜ˆå€¼æ ¹æ®æŸ¥è¯¢ç±»å‹è°ƒæ•´ |

**å…³é”®ä»£ç ä½ç½®**:
- `backend/src/services/profile_analyzer/analyzer/thresholds.rs` (DynamicThresholds)
- `backend/src/services/profile_analyzer/analyzer/rules/mod.rs` (RuleContext.thresholds)
- `backend/src/services/profile_analyzer/analyzer/rules/*.rs` (å„è§„åˆ™æ›´æ–°)

#### Task P2.2: é’ˆå¯¹æ€§å»ºè®®æ¨¡æ¿ â³ å¾…å¼€å§‹
- **å·¥ä½œé‡**: 1 å¤©
- **ä¼˜å…ˆçº§**: ğŸŸ¢ ä½
- **çŠ¶æ€**: å¾…å¼€å§‹
- **ç›®æ ‡**: 3+ æ¡è§„åˆ™æä¾›å…·ä½“ SQL ç¤ºä¾‹

---

## å¼€å‘è¿›åº¦ç»Ÿè®¡

### æ€»ä½“è¿›åº¦
```
å®Œæˆ: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 67%
è¿›è¡Œ: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%
å¾…åš: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 33%

å·²ç”¨: 5 / 20 äººæ—¥
é¢„è®¡: 20 äººæ—¥
è¿›åº¦: 67%
```

### Phase ç»Ÿè®¡
| Phase | ä»»åŠ¡æ•° | å®Œæˆ | è¿›è¡Œ | å¾…åš | è¿›åº¦ |
|-------|--------|------|------|------|------|
| **P0** | 3 | 3 | 0 | 0 | 100% âœ… |
| **P1** | 4 | 2 | 0 | 2 | 50% |
| **P2** | 2 | 1 | 0 | 1 | 50% |
| **æ€»è®¡** | 9 | 6 | 0 | 3 | 67% |

---

## æµ‹è¯• Profile è¯´æ˜

### å¯ç”¨çš„æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶ | æ€»æ‰§è¡Œæ—¶é—´ | ç”¨é€” | è·¯å¾„ |
|------|-----------|------|------|
| **profile2.txt** | 11ms | å¿«é€ŸæŸ¥è¯¢æµ‹è¯• | `/profiles/profile2.txt` |
| **profile1.txt** | ? | å¸¸è§„æŸ¥è¯¢ | `/profiles/profile1.txt` |
| **profile3.txt** | ? | ä¸­ç­‰æŸ¥è¯¢ | `/profiles/profile3.txt` |
| **profile4.txt** | ? | å¤æ‚æŸ¥è¯¢ | `/profiles/profile4.txt` |
| **profile5.txt** | ? | å¤§æŸ¥è¯¢ | `/profiles/profile5.txt` |

**ä½ç½®**: `/Users/jianglong/IdeaProjects/stellar/backend/tests/fixtures/profiles/`

### å¿«é€ŸåŠ è½½æŒ‡ä»¤
```bash
cd /Users/jianglong/IdeaProjects/stellar

# æŸ¥çœ‹å¿«é€ŸæŸ¥è¯¢ profile
cat backend/tests/fixtures/profiles/profile2.txt | head -20

# è¿è¡Œç°æœ‰æµ‹è¯•
cargo test -p backend profile_analyzer

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test -p backend profile_analyzer::test_fast_query_no_diagnostics
```

---

## å…³é”®æ£€æŸ¥ç‚¹

### âœ… å®Œæˆæ ‡å‡†

**P0.1 å®Œæˆ**: âœ…
- [x] RuleEngine ä»£ç å·²ä¿®æ”¹
- [x] profile2 ä¸äº§ç”Ÿè¯Šæ–­
- [x] profile1+ æ­£å¸¸äº§ç”Ÿè¯Šæ–­
- [x] æ— æ€§èƒ½å›å½’

**P0.2 å®Œæˆ**: âœ…
- [x] 6 æ¡è§„åˆ™å·²ä¿®æ”¹
- [x] æ ·æœ¬ä¿æŠ¤æµ‹è¯•é€šè¿‡
- [x] ç»å¯¹å€¼ä¿æŠ¤æµ‹è¯•é€šè¿‡
- [x] è¯¯æŠ¥ç‡ < 5%

**P0.3 å®Œæˆ**: âœ…
- [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90%
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ (98 ä¸ª profile_analyzer æµ‹è¯•)
- [x] æ²¡æœ‰æµ®ç‚¹æ•°ç›¸å…³ flaky æµ‹è¯•

**P1.1 å®Œæˆ**: âœ…
- [x] QueryType æšä¸¾å®ç°
- [x] SQL è¯­å¥ç±»å‹æ£€æµ‹
- [x] æŸ¥è¯¢ç±»å‹ç‰¹å®šé˜ˆå€¼
- [x] è§„åˆ™è·³è¿‡é€»è¾‘

**P2.1 å®Œæˆ**: âœ…
- [x] DynamicThresholds ç»“æ„ä½“
- [x] 9 æ¡è§„åˆ™ä½¿ç”¨åŠ¨æ€é˜ˆå€¼
- [x] æ‰€æœ‰ 223 ä¸ªæµ‹è¯•é€šè¿‡

---

## é—®é¢˜è¿½è¸ª

### å·²çŸ¥é—®é¢˜

| ID | é—®é¢˜ | ä¸¥é‡åº¦ | çŠ¶æ€ |
|-----|------|--------|------|
| - | - | - | - |

### å¾…å†³è®®é—®é¢˜

| ID | é—®é¢˜ | è®¨è®º |
|-----|------|------|
| Q1 | ç»å¯¹å€¼é˜ˆå€¼æ˜¯å¦éœ€è¦å¯é…ç½®ï¼Ÿ | âœ… å·²é€šè¿‡ thresholds.rs æ¨¡å—å®ç°ï¼Œå¯åç»­é…ç½®åŒ– |
| Q2 | æ ·æœ¬æ•°é‡å¦‚ä½•åœ¨å¤šå®ä¾‹é—´èšåˆï¼Ÿ | ç”¨ Fragment å®ä¾‹æ•°ï¼Œä¸æ˜¯ BE æ•° |

---

## å‚è€ƒèµ„æº

- å®¡æŸ¥æ–‡æ¡£: `/docs/design/profile-diagnostic-system-review.md` (v2.1)
- åŸå§‹è®¾è®¡: `/docs/design/profile-diagnostic-system.md` (v1.5)
- å‚æ•°æ¨è: `/docs/design/smart-parameter-recommendation.md`
- æµ‹è¯• profiles: `/backend/tests/fixtures/profiles/`
- åŠ¨æ€é˜ˆå€¼æ¨¡å—: `/backend/src/services/profile_analyzer/analyzer/thresholds.rs`

---

## æ¯æ—¥æ›´æ–°æ—¥å¿—

### 2024-12-07

**ä¸Šåˆ**:
- âœ… å®¡æŸ¥æ–‡æ¡£è¡¥å……æ·±åº¦åæ€ (v2.1)
- âœ… åˆ†æå‘ç° 4 å¤§ç±»é—®é¢˜ï¼ˆP0/P1/P2/P3ï¼‰
- âœ… åˆ¶å®šåˆ†å±‚å¼€å‘è®¡åˆ’

**ä¸‹åˆ**:
- âœ… P0.1 å®ç°å®Œæˆï¼šåœ¨ RuleEngine æ·»åŠ å…¨å±€æ—¶é—´é—¨æ§› (â‰¥1s)
- âœ… P0.2 å®ç°å®Œæˆï¼š6 æ¡è§„åˆ™æ·»åŠ ä¿æŠ¤æ¡ä»¶
- âœ… P0.3 å®ç°å®Œæˆï¼šå•å…ƒæµ‹è¯•è¡¥å…¨

**æ™šä¸Š** (å·²å®Œæˆ):
- âœ… P1.1 æŸ¥è¯¢ç±»å‹æ„ŸçŸ¥æ¡†æ¶å®ç°å®Œæˆï¼š
  - æ–°å¢ `QueryType` æšä¸¾ (Select, Insert, Export, Analyze, Ctas, Load, Unknown)
  - å®ç° `QueryType::from_sql()` ä» SQL æ£€æµ‹æŸ¥è¯¢ç±»å‹
  - å®ç° `QueryType::get_time_threshold_ms()` è¿”å›ç±»å‹ç‰¹å®šé˜ˆå€¼
  - å®ç° `QueryType::should_skip_rule()` è·³è¿‡ä¸é€‚ç”¨è§„åˆ™
  - æ›´æ–° Q001 è§„åˆ™ä½¿ç”¨æŸ¥è¯¢ç±»å‹ç‰¹å®šæ—¶é—´é˜ˆå€¼
  - RuleEngine é›†æˆ QueryType æ£€æµ‹å’Œè§„åˆ™è·³è¿‡

- âœ… P2.1 åŠ¨æ€é˜ˆå€¼å®ç°å®Œæˆï¼š
  - æ–°å¢ `DynamicThresholds` ç»“æ„ä½“
  - å®ç°å†…å­˜é˜ˆå€¼ (BE å†…å­˜çš„ 10%, 1GB-10GB)
  - å®ç° HashTable é˜ˆå€¼ (BE å†…å­˜çš„ 5%, 512MB-5GB)
  - å®ç°å€¾æ–œé˜ˆå€¼ (æ ¹æ®é›†ç¾¤å¤§å° 2.0-3.5)
  - å®ç°å°æ–‡ä»¶é˜ˆå€¼ (æ ¹æ®å­˜å‚¨ç±»å‹)
  - æ›´æ–° 9 æ¡è§„åˆ™ä½¿ç”¨åŠ¨æ€é˜ˆå€¼ (S001, S002, G002, G003, J003, J006, A001, A002, Q001)
  - å°† `DynamicThresholds` é›†æˆåˆ° `RuleContext`

- âœ… P1.3 å¤–è¡¨ç±»å‹å®Œæ•´è¦†ç›– (å®¡æŸ¥æ–‡æ¡£ç¬¬äº”èŠ‚) å®ç°å®Œæˆï¼š
  - æ–°å¢ `ExternalScanType` æšä¸¾ (12 ç§å¤–è¡¨ç±»å‹)
  - å®ç° `from_operator_name()` ä»ç®—å­åæ£€æµ‹ç±»å‹
  - å®ç° `supports_small_file_detection()` åˆ¤æ–­æ˜¯å¦æ”¯æŒå°æ–‡ä»¶æ£€æµ‹
  - å®ç° `storage_type()` è·å–å­˜å‚¨ç±»å‹
  - å®ç° `file_count_metric()` è·å–æ–‡ä»¶æ•°é‡æŒ‡æ ‡
  - å®ç° `generate_small_file_suggestions()` ç”Ÿæˆç±»å‹ç‰¹å®šå»ºè®®
  - æ›´æ–° S016 è§„åˆ™ä½¿ç”¨ ExternalScanType

- ğŸ“Š æµ‹è¯•ç»“æœ:
  - profile_analyzer æµ‹è¯•: 98/98 é€šè¿‡ âœ…
  - å…¨éƒ¨æµ‹è¯•: 228/228 é€šè¿‡ âœ…

**ä¸‹ä¸€æ­¥**:
- â³ P1.2ï¼šè§„åˆ™å…³ç³»é‡æ„ (äº’æ–¥/å› æœ/å…ˆå†³/è¡¥å……/ç‹¬ç«‹/å¦å®š)
- â³ P1.4ï¼šæŒ‡æ ‡æ˜ å°„è¡¨å»ºè®¾
- â³ P2.2ï¼šé’ˆå¯¹æ€§å»ºè®®æ¨¡æ¿

---

## è”ç³»æ–¹å¼

- **å¼€å‘è€…**: [ç”¨æˆ·å]
- **å®¡æŸ¥**: Stellar Team
- **æœ€åæ›´æ–°**: 2024-12-07 22:00
