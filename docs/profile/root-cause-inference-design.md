# æ ¹å› æ¨æ–­å¼•æ“è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2024-12-07
> **ä½œè€…**: Stellar Team
> **çŠ¶æ€**: è®¾è®¡ä¸­

---

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 å½“å‰é—®é¢˜

å½“å‰è¯Šæ–­ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **è¯Šæ–­ç»“æœæ‰å¹³åŒ–**: æ‰€æœ‰è¯Šæ–­æŒ‰ä¸¥é‡åº¦æ’åºï¼Œç”¨æˆ·çœ‹åˆ°ä¸€å †å‘Šè­¦ä¸çŸ¥ä»ä½•ä¸‹æ‰‹
2. **ç¼ºä¹å› æœå…³ç³»**: ç—‡çŠ¶å’Œæ ¹å› æ··åœ¨ä¸€èµ·å±•ç¤ºï¼Œç”¨æˆ·å¯èƒ½å…ˆè§£å†³ç—‡çŠ¶è€Œéæ ¹å› 
3. **é‡å¤ä¿¡æ¯**: åŒä¸€æ ¹å› å¯¼è‡´çš„å¤šä¸ªç—‡çŠ¶åˆ†åˆ«å±•ç¤ºï¼Œä¿¡æ¯å†—ä½™
4. **ç¼ºä¹ä¼˜å…ˆçº§**: æ²¡æœ‰å‘Šè¯‰ç”¨æˆ·"è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶ä»–é—®é¢˜ä¼šè‡ªåŠ¨æ¶ˆå¤±"

### 1.2 ç›®æ ‡

1. **è¯†åˆ«æ ¹å› **: ä»å¤šä¸ªè¯Šæ–­ä¸­è¯†åˆ«å‡ºçœŸæ­£çš„æ ¹æœ¬åŸå› 
2. **å»ºç«‹å› æœé“¾**: å±•ç¤º"æ ¹å›  â†’ ç—‡çŠ¶"çš„å› æœå…³ç³»
3. **ä¼˜å…ˆçº§æ’åº**: æ ¹å› ä¼˜å…ˆäºç—‡çŠ¶å±•ç¤º
4. **å‡å°‘å™ªéŸ³**: åˆå¹¶å› æœç›¸å…³çš„è¯Šæ–­ï¼Œå‡å°‘ä¿¡æ¯å†—ä½™
5. **æå‡å¯æ“ä½œæ€§**: å‘Šè¯‰ç”¨æˆ·"ä¼˜å…ˆè§£å†³ Xï¼ŒY å’Œ Z ä¼šè‡ªåŠ¨æ”¹å–„"

---

## äºŒã€å‰ç«¯æ€»è§ˆè¯Šæ–­å±•ç¤ºé€»è¾‘æ¢³ç†

### 2.1 å½“å‰æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½“å‰è¯Šæ–­æ•°æ®æµ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  åç«¯ RuleEngine                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¯„ä¼°æ‰€æœ‰è§„åˆ™                             â”‚   â”‚
â”‚  â”‚ 2. æ”¶é›† Vec<Diagnostic>                                 â”‚   â”‚
â”‚  â”‚ 3. æŒ‰ä¸¥é‡åº¦æ’åº (Error > Warning > Info)                 â”‚   â”‚
â”‚  â”‚ 4. å»é‡ (rule_id + node_path)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  åç«¯ aggregate_diagnostics()                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. æŒ‰ rule_id åˆ†ç»„                                       â”‚   â”‚
â”‚  â”‚ 2. åˆå¹¶åŒè§„åˆ™çš„å¤šä¸ªèŠ‚ç‚¹                                   â”‚   â”‚
â”‚  â”‚ 3. ç”Ÿæˆ AggregatedDiagnostic                            â”‚   â”‚
â”‚  â”‚    - affected_nodes: å—å½±å“èŠ‚ç‚¹åˆ—è¡¨                       â”‚   â”‚
â”‚  â”‚    - node_count: èŠ‚ç‚¹æ•°é‡                                â”‚   â”‚
â”‚  â”‚    - suggestions: åˆå¹¶å»é‡çš„å»ºè®®                          â”‚   â”‚
â”‚  â”‚ 4. æŒ‰ä¸¥é‡åº¦ + èŠ‚ç‚¹æ•°æ’åº                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  API Response                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ {                                                       â”‚   â”‚
â”‚  â”‚   diagnostics: [...],           // åŸå§‹è¯Šæ–­åˆ—è¡¨          â”‚   â”‚
â”‚  â”‚   aggregated_diagnostics: [...], // èšåˆåçš„è¯Šæ–­         â”‚   â”‚
â”‚  â”‚   node_diagnostics: {...},      // èŠ‚ç‚¹çº§è¯Šæ–­æ˜ å°„        â”‚   â”‚
â”‚  â”‚ }                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  å‰ç«¯å±•ç¤º                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ€»è§ˆé¡µé¢:                                                â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚ â”‚ è¯Šæ–­å»ºè®® [3]                                     â”‚     â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚ â”‚ âš ï¸ S001 æ•°æ®å€¾æ–œ           Ã—2 ä¸ªèŠ‚ç‚¹            â”‚     â”‚   â”‚
â”‚  â”‚ â”‚    æ¶‰åŠèŠ‚ç‚¹: OLAP_SCAN(1), OLAP_SCAN(3)         â”‚     â”‚   â”‚
â”‚  â”‚ â”‚    ğŸ’¡ æ£€æŸ¥åˆ†æ¡¶é”®é€‰æ‹©æ˜¯å¦åˆç†                     â”‚     â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚ â”‚ âš ï¸ G003 æ‰§è¡Œæ—¶é—´å€¾æ–œ       Ã—2 ä¸ªèŠ‚ç‚¹            â”‚     â”‚   â”‚
â”‚  â”‚ â”‚    æ¶‰åŠèŠ‚ç‚¹: HASH_JOIN(2), AGGREGATE(4)         â”‚     â”‚   â”‚
â”‚  â”‚ â”‚    ğŸ’¡ æ£€æŸ¥æ•°æ®åˆ†å¸ƒæ˜¯å¦å‡åŒ€                       â”‚     â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚ â”‚ â„¹ï¸ S009 ç¼“å­˜å‘½ä¸­ç‡ä½       Ã—1 ä¸ªèŠ‚ç‚¹            â”‚     â”‚   â”‚
â”‚  â”‚ â”‚    æ¶‰åŠèŠ‚ç‚¹: CONNECTOR_SCAN(5)                  â”‚     â”‚   â”‚
â”‚  â”‚ â”‚    ğŸ’¡ å¢å¤§ DataCache å®¹é‡                       â”‚     â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.2 å½“å‰é—®é¢˜åˆ†æ

ä¸Šè¿°å±•ç¤ºå­˜åœ¨çš„é—®é¢˜ï¼š

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|-----|------|------|
| **æ— å› æœå…³ç³»** | S001 å’Œ G003 æ˜¯å› æœå…³ç³»ï¼Œä½†åˆ†å¼€å±•ç¤º | ç”¨æˆ·å¯èƒ½å…ˆå°è¯•è§£å†³ G003 |
| **é‡å¤å»ºè®®** | S001 å’Œ G003 çš„å»ºè®®éƒ½æ˜¯"æ£€æŸ¥æ•°æ®åˆ†å¸ƒ" | ä¿¡æ¯å†—ä½™ |
| **ä¼˜å…ˆçº§ä¸æ˜** | ç”¨æˆ·ä¸çŸ¥é“åº”è¯¥å…ˆè§£å†³å“ªä¸ª | å†³ç­–å›°éš¾ |
| **ç¼ºä¹æ ¹å› æ ‡è¯†** | æ²¡æœ‰å‘Šè¯‰ç”¨æˆ· S001 æ˜¯æ ¹å›  | å¯èƒ½æ²»æ ‡ä¸æ²»æœ¬ |

---

## ä¸‰ã€æ ¹å› æ¨æ–­å¼•æ“è®¾è®¡

### 3.1 è§„åˆ™å…³ç³»ç±»å‹å®šä¹‰

```rust
/// è§„åˆ™å…³ç³»ç±»å‹
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum RuleRelation {
    /// å› æœå…³ç³»: A æ˜¯ B çš„æ ¹å› 
    /// ä¾‹: S001(æ•°æ®å€¾æ–œ) â†’ G003(æ‰§è¡Œæ—¶é—´å€¾æ–œ)
    Causal,
    
    /// äº’æ–¥å…³ç³»: A å’Œ B ä¸ä¼šåŒæ—¶æ˜¯æ ¹å› ï¼Œåªä¿ç•™æ›´ä¸¥é‡çš„
    /// ä¾‹: G001(>30%) å’Œ G001b(>15%) äº’æ–¥
    MutuallyExclusive,
    
    /// ç‹¬ç«‹å…³ç³»: A å’Œ B æ˜¯ç‹¬ç«‹é—®é¢˜ï¼Œå¯åŒæ—¶å­˜åœ¨
    /// ä¾‹: S001(æ•°æ®å€¾æ–œ) å’Œ S016(å°æ–‡ä»¶) æ˜¯ç‹¬ç«‹é—®é¢˜
    Independent,
    
    /// åŠ å‰§å…³ç³»: A ä¼šåŠ å‰§ B çš„å½±å“
    /// ä¾‹: S016(å°æ–‡ä»¶) åŠ å‰§ S007(IOç“¶é¢ˆ)
    Aggravates,
}

/// è§„åˆ™å…³ç³»é…ç½®
#[derive(Debug, Clone)]
pub struct RuleRelationConfig {
    /// æºè§„åˆ™ ID
    pub source: &'static str,
    /// ç›®æ ‡è§„åˆ™ ID
    pub target: &'static str,
    /// å…³ç³»ç±»å‹
    pub relation: RuleRelation,
    /// ç½®ä¿¡åº¦ (0.0 - 1.0)
    pub confidence: f64,
    /// å…³ç³»æè¿°
    pub description: &'static str,
}
```

### 3.2 è§„åˆ™å…³ç³»é…ç½®è¡¨

```rust
/// è§„åˆ™å…³ç³»é…ç½®è¡¨
pub const RULE_RELATIONS: &[RuleRelationConfig] = &[
    // ========================================================================
    // å› æœå…³ç³» (Causal)
    // ========================================================================
    
    // æ•°æ®å€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ
    RuleRelationConfig {
        source: "S001",
        target: "G003",
        relation: RuleRelation::Causal,
        confidence: 0.9,
        description: "æ•°æ®å€¾æ–œå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹å¤„ç†æ›´å¤šæ•°æ®ï¼Œæ‰§è¡Œæ—¶é—´æ›´é•¿",
    },
    
    // æ•°æ®å€¾æ–œ â†’ Shuffle å€¾æ–œ
    RuleRelationConfig {
        source: "S001",
        target: "J006",
        relation: RuleRelation::Causal,
        confidence: 0.85,
        description: "æ•°æ®å€¾æ–œå¯¼è‡´ Shuffle æ•°æ®åˆ†å¸ƒä¸å‡",
    },
    
    // æ•°æ®å€¾æ–œ â†’ èšåˆå€¾æ–œ
    RuleRelationConfig {
        source: "S001",
        target: "A001",
        relation: RuleRelation::Causal,
        confidence: 0.8,
        description: "æ•°æ®å€¾æ–œå¯¼è‡´èšåˆæ“ä½œè´Ÿè½½ä¸å‡",
    },
    
    // Join è†¨èƒ€ â†’ å†…å­˜è¿‡é«˜
    RuleRelationConfig {
        source: "J001",
        target: "G002",
        relation: RuleRelation::Causal,
        confidence: 0.85,
        description: "Join ç»“æœè†¨èƒ€å¯¼è‡´å†…å­˜ä½¿ç”¨å¢åŠ ",
    },
    
    // Join è†¨èƒ€ â†’ HashTable è¿‡å¤§
    RuleRelationConfig {
        source: "J001",
        target: "J003",
        relation: RuleRelation::Causal,
        confidence: 0.8,
        description: "Join è†¨èƒ€å¯¼è‡´ HashTable æ„å»ºæ›´å¤§",
    },
    
    // ç¼“å­˜å‘½ä¸­ä½ â†’ IO ç“¶é¢ˆ
    RuleRelationConfig {
        source: "S009",
        target: "S007",
        relation: RuleRelation::Causal,
        confidence: 0.75,
        description: "ç¼“å­˜å‘½ä¸­ç‡ä½å¯¼è‡´æ›´å¤šç£ç›˜/ç½‘ç»œ IO",
    },
    
    // å°æ–‡ä»¶ â†’ IO ç“¶é¢ˆ
    RuleRelationConfig {
        source: "S016",
        target: "S007",
        relation: RuleRelation::Causal,
        confidence: 0.8,
        description: "å°æ–‡ä»¶è¿‡å¤šå¯¼è‡´ IO è¯·æ±‚æ•°å¢åŠ ",
    },
    
    // è¿‡æ»¤æ•ˆæœå·® â†’ æ‰§è¡Œæ—¶é—´é•¿
    RuleRelationConfig {
        source: "S003",
        target: "Q001",
        relation: RuleRelation::Causal,
        confidence: 0.7,
        description: "è¿‡æ»¤æ•ˆæœå·®å¯¼è‡´å¤„ç†æ›´å¤šæ•°æ®",
    },
    
    // ========================================================================
    // äº’æ–¥å…³ç³» (MutuallyExclusive)
    // ========================================================================
    
    // G001 å’Œ G001b äº’æ–¥
    RuleRelationConfig {
        source: "G001",
        target: "G001b",
        relation: RuleRelation::MutuallyExclusive,
        confidence: 1.0,
        description: "åŒä¸€èŠ‚ç‚¹ä¸ä¼šåŒæ—¶æ˜¯æœ€è€—æ—¶å’Œæ¬¡è€—æ—¶",
    },
    
    // ========================================================================
    // åŠ å‰§å…³ç³» (Aggravates)
    // ========================================================================
    
    // IO å€¾æ–œåŠ å‰§æ‰§è¡Œæ—¶é—´å€¾æ–œ
    RuleRelationConfig {
        source: "S002",
        target: "G003",
        relation: RuleRelation::Aggravates,
        confidence: 0.7,
        description: "IO å€¾æ–œä¼šåŠ å‰§æ‰§è¡Œæ—¶é—´å€¾æ–œ",
    },
];
```


### 3.3 æ ¹å› æ¨æ–­ç®—æ³•

```rust
/// æ ¹å› åˆ†æç»“æœ
#[derive(Debug, Clone, Serialize)]
pub struct RootCauseAnalysis {
    /// æ ¹å› è¯Šæ–­
    pub root_cause: DiagnosticResult,
    /// ç”±æ­¤æ ¹å› å¯¼è‡´çš„ç—‡çŠ¶åˆ—è¡¨
    pub symptoms: Vec<SymptomInfo>,
    /// ç»¼åˆç½®ä¿¡åº¦
    pub confidence: f64,
    /// é¢„ä¼°å½±å“ (è§£å†³æ ¹å› åé¢„è®¡æ”¹å–„çš„ç™¾åˆ†æ¯”)
    pub estimated_impact: f64,
    /// æ˜¯å¦ä¸ºç‹¬ç«‹é—®é¢˜ (æ— å› æœå…³ç³»)
    pub is_independent: bool,
}

/// ç—‡çŠ¶ä¿¡æ¯
#[derive(Debug, Clone, Serialize)]
pub struct SymptomInfo {
    /// ç—‡çŠ¶è¯Šæ–­
    pub diagnostic: DiagnosticResult,
    /// ä¸æ ¹å› çš„å…³ç³»ç±»å‹
    pub relation: RuleRelation,
    /// å…³ç³»ç½®ä¿¡åº¦
    pub confidence: f64,
    /// å…³ç³»æè¿°
    pub description: String,
}

/// æ ¹å› æ¨æ–­å¼•æ“
pub struct RootCauseInferenceEngine {
    /// è§„åˆ™å…³ç³»å›¾ (é‚»æ¥è¡¨)
    relation_graph: HashMap<String, Vec<(String, RuleRelationConfig)>>,
}

impl RootCauseInferenceEngine {
    pub fn new() -> Self {
        let mut relation_graph = HashMap::new();
        
        // æ„å»ºå…³ç³»å›¾
        for config in RULE_RELATIONS {
            relation_graph
                .entry(config.source.to_string())
                .or_insert_with(Vec::new)
                .push((config.target.to_string(), config.clone()));
        }
        
        Self { relation_graph }
    }
    
    /// æ‰§è¡Œæ ¹å› æ¨æ–­
    pub fn infer(&self, diagnostics: &[DiagnosticResult]) -> Vec<RootCauseAnalysis> {
        // Step 1: æ„å»ºè¯Šæ–­ ID é›†åˆ
        let diag_ids: HashSet<String> = diagnostics
            .iter()
            .map(|d| d.rule_id.clone())
            .collect();
        
        // Step 2: è¯†åˆ«æ ¹å›  (æ²¡æœ‰å…¶ä»–è¯Šæ–­æŒ‡å‘å®ƒçš„è¯Šæ–­)
        let mut root_causes = Vec::new();
        let mut symptoms_map: HashMap<String, Vec<SymptomInfo>> = HashMap::new();
        
        for diag in diagnostics {
            let is_root = !self.has_cause_in_set(&diag.rule_id, &diag_ids);
            
            if is_root {
                // æŸ¥æ‰¾ç”±æ­¤æ ¹å› å¯¼è‡´çš„ç—‡çŠ¶
                let symptoms = self.find_symptoms(&diag.rule_id, diagnostics);
                symptoms_map.insert(diag.rule_id.clone(), symptoms);
            }
        }
        
        // Step 3: æ„å»ºæ ¹å› åˆ†æç»“æœ
        for diag in diagnostics {
            if let Some(symptoms) = symptoms_map.remove(&diag.rule_id) {
                let confidence = self.calculate_confidence(&symptoms);
                let estimated_impact = self.estimate_impact(&symptoms);
                
                root_causes.push(RootCauseAnalysis {
                    root_cause: diag.clone(),
                    symptoms,
                    confidence,
                    estimated_impact,
                    is_independent: false,
                });
            }
        }
        
        // Step 4: å¤„ç†ç‹¬ç«‹é—®é¢˜ (æ²¡æœ‰å› æœå…³ç³»çš„è¯Šæ–­)
        let covered_ids: HashSet<String> = root_causes
            .iter()
            .flat_map(|rc| {
                std::iter::once(rc.root_cause.rule_id.clone())
                    .chain(rc.symptoms.iter().map(|s| s.diagnostic.rule_id.clone()))
            })
            .collect();
        
        for diag in diagnostics {
            if !covered_ids.contains(&diag.rule_id) {
                root_causes.push(RootCauseAnalysis {
                    root_cause: diag.clone(),
                    symptoms: vec![],
                    confidence: 1.0,
                    estimated_impact: 0.0,
                    is_independent: true,
                });
            }
        }
        
        // Step 5: æŒ‰ä¼˜å…ˆçº§æ’åº
        root_causes.sort_by(|a, b| {
            // ä¼˜å…ˆçº§: æœ‰ç—‡çŠ¶çš„æ ¹å›  > ç‹¬ç«‹é—®é¢˜
            // åŒç±»å†…æŒ‰: ç—‡çŠ¶æ•°é‡ > ç½®ä¿¡åº¦ > ä¸¥é‡åº¦
            let a_priority = if a.is_independent { 0 } else { 1 };
            let b_priority = if b.is_independent { 0 } else { 1 };
            
            b_priority.cmp(&a_priority)
                .then_with(|| b.symptoms.len().cmp(&a.symptoms.len()))
                .then_with(|| b.confidence.partial_cmp(&a.confidence).unwrap_or(std::cmp::Ordering::Equal))
        });
        
        root_causes
    }
    
    /// æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¯Šæ–­æ˜¯æ­¤è¯Šæ–­çš„æ ¹å› 
    fn has_cause_in_set(&self, rule_id: &str, diag_ids: &HashSet<String>) -> bool {
        for (source, targets) in &self.relation_graph {
            if diag_ids.contains(source) {
                for (target, config) in targets {
                    if target == rule_id && config.relation == RuleRelation::Causal {
                        return true;
                    }
                }
            }
        }
        false
    }
    
    /// æŸ¥æ‰¾ç”±æ ¹å› å¯¼è‡´çš„ç—‡çŠ¶
    fn find_symptoms(&self, root_id: &str, diagnostics: &[DiagnosticResult]) -> Vec<SymptomInfo> {
        let mut symptoms = Vec::new();
        
        if let Some(targets) = self.relation_graph.get(root_id) {
            for (target_id, config) in targets {
                if config.relation == RuleRelation::Causal {
                    if let Some(diag) = diagnostics.iter().find(|d| &d.rule_id == target_id) {
                        symptoms.push(SymptomInfo {
                            diagnostic: diag.clone(),
                            relation: config.relation,
                            confidence: config.confidence,
                            description: config.description.to_string(),
                        });
                    }
                }
            }
        }
        
        symptoms
    }
    
    /// è®¡ç®—ç»¼åˆç½®ä¿¡åº¦
    fn calculate_confidence(&self, symptoms: &[SymptomInfo]) -> f64 {
        if symptoms.is_empty() {
            return 1.0;
        }
        
        // ä½¿ç”¨ç—‡çŠ¶ç½®ä¿¡åº¦çš„åŠ æƒå¹³å‡
        let total: f64 = symptoms.iter().map(|s| s.confidence).sum();
        total / symptoms.len() as f64
    }
    
    /// ä¼°ç®—è§£å†³æ ¹å› åçš„å½±å“
    fn estimate_impact(&self, symptoms: &[SymptomInfo]) -> f64 {
        // ç®€å•ä¼°ç®—: æ¯ä¸ªç—‡çŠ¶è´¡çŒ® 20% çš„æ”¹å–„
        (symptoms.len() as f64 * 0.2).min(0.8)
    }
}
```


---

## å››ã€API å“åº”æ ¼å¼æ›´æ–°

### 4.1 æ–°å¢å­—æ®µ

```rust
/// Profile åˆ†æå“åº” (æ›´æ–°)
#[derive(Debug, Serialize)]
pub struct ProfileAnalysisResponse {
    // ... ç°æœ‰å­—æ®µ ...
    
    /// åŸå§‹è¯Šæ–­åˆ—è¡¨
    pub diagnostics: Vec<DiagnosticResult>,
    
    /// èšåˆè¯Šæ–­ (æŒ‰è§„åˆ™åˆ†ç»„)
    pub aggregated_diagnostics: Vec<AggregatedDiagnostic>,
    
    /// èŠ‚ç‚¹çº§è¯Šæ–­æ˜ å°„
    pub node_diagnostics: HashMap<i32, Vec<DiagnosticResult>>,
    
    /// ğŸ†• æ ¹å› åˆ†æç»“æœ
    pub root_cause_analysis: Vec<RootCauseAnalysis>,
}
```

### 4.2 JSON å“åº”ç¤ºä¾‹

```json
{
  "diagnostics": [...],
  "aggregated_diagnostics": [...],
  "node_diagnostics": {...},
  "root_cause_analysis": [
    {
      "root_cause": {
        "rule_id": "S001",
        "rule_name": "æ•°æ®å€¾æ–œ",
        "severity": "Warning",
        "message": "Scan å­˜åœ¨æ•°æ®å€¾æ–œï¼Œmax/avg æ¯”ç‡ä¸º 3.5",
        "node_path": "OLAP_SCAN (plan_node_id=1)"
      },
      "symptoms": [
        {
          "diagnostic": {
            "rule_id": "G003",
            "rule_name": "æ‰§è¡Œæ—¶é—´å€¾æ–œ",
            "severity": "Warning",
            "message": "æ‰§è¡Œæ—¶é—´å­˜åœ¨å€¾æ–œï¼Œmax/avg æ¯”ç‡ä¸º 2.8"
          },
          "relation": "Causal",
          "confidence": 0.9,
          "description": "æ•°æ®å€¾æ–œå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹å¤„ç†æ›´å¤šæ•°æ®ï¼Œæ‰§è¡Œæ—¶é—´æ›´é•¿"
        },
        {
          "diagnostic": {
            "rule_id": "J006",
            "rule_name": "Shuffle å€¾æ–œ",
            "severity": "Warning",
            "message": "Shuffle æ•°æ®åˆ†å¸ƒä¸å‡"
          },
          "relation": "Causal",
          "confidence": 0.85,
          "description": "æ•°æ®å€¾æ–œå¯¼è‡´ Shuffle æ•°æ®åˆ†å¸ƒä¸å‡"
        }
      ],
      "confidence": 0.875,
      "estimated_impact": 0.4,
      "is_independent": false
    },
    {
      "root_cause": {
        "rule_id": "S016",
        "rule_name": "å¤–è¡¨å°æ–‡ä»¶è¿‡å¤š",
        "severity": "Warning",
        "message": "æ‰«æäº† 2000 ä¸ªæ–‡ä»¶ï¼Œå¹³å‡å¤§å°ä»… 512KB"
      },
      "symptoms": [],
      "confidence": 1.0,
      "estimated_impact": 0.0,
      "is_independent": true
    }
  ]
}
```

---

## äº”ã€å‰ç«¯å±•ç¤ºè®¾è®¡

### 5.1 æ€»è§ˆé¡µé¢æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¯Šæ–­å»ºè®® (æ ¹å› åˆ†æè§†å›¾)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ” æ ¹å› åˆ†æ                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ”´ æ ¹å›  #1: S001 æ•°æ®å€¾æ–œ                    ç½®ä¿¡åº¦: 88% â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ âš ï¸ Scan å­˜åœ¨æ•°æ®å€¾æ–œï¼Œmax/avg æ¯”ç‡ä¸º 3.5            â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ ğŸ“ æ¶‰åŠèŠ‚ç‚¹: OLAP_SCAN(1), OLAP_SCAN(3)             â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ğŸ“Š å¯¼è‡´çš„ç—‡çŠ¶ (è§£å†³æ ¹å› åé¢„è®¡æ”¹å–„ 40%):                  â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ âš ï¸ G003 æ‰§è¡Œæ—¶é—´å€¾æ–œ (ç½®ä¿¡åº¦: 90%)                 â”‚   â”‚
â”‚  â”‚ â”‚   â””â”€â”€ æ•°æ®å€¾æ–œå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹å¤„ç†æ›´å¤šæ•°æ®                 â”‚   â”‚
â”‚  â”‚ â””â”€â”€ âš ï¸ J006 Shuffle å€¾æ–œ (ç½®ä¿¡åº¦: 85%)                 â”‚   â”‚
â”‚  â”‚     â””â”€â”€ æ•°æ®å€¾æ–œå¯¼è‡´ Shuffle æ•°æ®åˆ†å¸ƒä¸å‡               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ğŸ’¡ å»ºè®®æ“ä½œ:                                            â”‚   â”‚
â”‚  â”‚ 1. æ£€æŸ¥åˆ†æ¡¶é”®é€‰æ‹©æ˜¯å¦åˆç†                               â”‚   â”‚
â”‚  â”‚ 2. è€ƒè™‘é‡æ–°åˆ†æ¡¶ä»¥å‡åŒ€åˆ†å¸ƒæ•°æ®                           â”‚   â”‚
â”‚  â”‚ âš¡ ä¼˜å…ˆè§£å†³æ­¤é—®é¢˜ï¼Œä¸Šè¿°ç—‡çŠ¶å°†è‡ªåŠ¨æ”¹å–„                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸŸ¡ ç‹¬ç«‹é—®é¢˜ #1: S016 å¤–è¡¨å°æ–‡ä»¶è¿‡å¤š                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ âš ï¸ æ‰«æäº† 2000 ä¸ªæ–‡ä»¶ï¼Œå¹³å‡å¤§å°ä»… 512KB             â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ ğŸ“ æ¶‰åŠèŠ‚ç‚¹: HIVE_SCAN(5)                           â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ğŸ’¡ å»ºè®®æ“ä½œ:                                            â”‚   â”‚
â”‚  â”‚ 1. æ‰§è¡Œ Compaction åˆå¹¶å°æ–‡ä»¶                          â”‚   â”‚
â”‚  â”‚ 2. è°ƒæ•´ä¸Šæ¸¸ ETL è¾“å‡ºæ–‡ä»¶å¤§å°                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å‰ç«¯ç»„ä»¶æ›´æ–°

```typescript
// æ–°å¢æ¥å£å®šä¹‰
interface RootCauseAnalysis {
  root_cause: DiagnosticResult;
  symptoms: SymptomInfo[];
  confidence: number;
  estimated_impact: number;
  is_independent: boolean;
}

interface SymptomInfo {
  diagnostic: DiagnosticResult;
  relation: 'Causal' | 'MutuallyExclusive' | 'Independent' | 'Aggravates';
  confidence: number;
  description: string;
}

// æ›´æ–° ProfileAnalysisResponse
interface ProfileAnalysisResponse {
  // ... ç°æœ‰å­—æ®µ ...
  root_cause_analysis?: RootCauseAnalysis[];
}
```

### 5.3 å±•ç¤ºé€»è¾‘

```typescript
// åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ ¹å› åˆ†æè§†å›¾
shouldShowRootCauseView(): boolean {
  return this.analysisData?.root_cause_analysis?.length > 0;
}

// è·å–æ ¹å› åˆ—è¡¨ (éç‹¬ç«‹é—®é¢˜)
getRootCauses(): RootCauseAnalysis[] {
  return this.analysisData?.root_cause_analysis
    ?.filter(rc => !rc.is_independent) || [];
}

// è·å–ç‹¬ç«‹é—®é¢˜åˆ—è¡¨
getIndependentIssues(): RootCauseAnalysis[] {
  return this.analysisData?.root_cause_analysis
    ?.filter(rc => rc.is_independent) || [];
}

// æ ¼å¼åŒ–ç½®ä¿¡åº¦
formatConfidence(confidence: number): string {
  return `${(confidence * 100).toFixed(0)}%`;
}

// æ ¼å¼åŒ–é¢„ä¼°å½±å“
formatImpact(impact: number): string {
  return `${(impact * 100).toFixed(0)}%`;
}
```


---

## å…­ã€å®æ–½è®¡åˆ’

### 6.1 å¼€å‘é˜¶æ®µ

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|-----|------|-------|-------|
| **Phase 1** | è§„åˆ™å…³ç³»å®šä¹‰ | 0.5 å¤© | P0 |
| | å®šä¹‰ RuleRelation æšä¸¾ | | |
| | å®šä¹‰ RuleRelationConfig ç»“æ„ | | |
| | é…ç½®è§„åˆ™å…³ç³»è¡¨ | | |
| **Phase 2** | æ ¹å› æ¨æ–­å¼•æ“ | 1.5 å¤© | P0 |
| | å®ç° RootCauseInferenceEngine | | |
| | å®ç°å› æœé“¾æŸ¥æ‰¾ç®—æ³• | | |
| | å®ç°ç½®ä¿¡åº¦è®¡ç®— | | |
| | å®ç°å½±å“ä¼°ç®— | | |
| **Phase 3** | åç«¯é›†æˆ | 0.5 å¤© | P0 |
| | æ›´æ–° ProfileAnalysisResponse | | |
| | é›†æˆåˆ° analyze_profile() | | |
| | æ·»åŠ å•å…ƒæµ‹è¯• | | |
| **Phase 4** | å‰ç«¯å±•ç¤º | 1 å¤© | P1 |
| | æ›´æ–° TypeScript æ¥å£ | | |
| | å®ç°æ ¹å› åˆ†æè§†å›¾ç»„ä»¶ | | |
| | æ›´æ–°æ€»è§ˆé¡µé¢ | | |
| **Phase 5** | æµ‹è¯•ä¸ä¼˜åŒ– | 0.5 å¤© | P1 |
| | ç«¯åˆ°ç«¯æµ‹è¯• | | |
| | æ€§èƒ½ä¼˜åŒ– | | |
| | æ–‡æ¡£æ›´æ–° | | |

**æ€»å·¥ä½œé‡**: 4 å¤©

### 6.2 æ–‡ä»¶å˜æ›´æ¸…å•

```
åç«¯:
â”œâ”€â”€ backend/src/services/profile_analyzer/
â”‚   â”œâ”€â”€ analyzer/
â”‚   â”‚   â”œâ”€â”€ root_cause.rs          # ğŸ†• æ ¹å› æ¨æ–­å¼•æ“
â”‚   â”‚   â”œâ”€â”€ rule_relations.rs      # ğŸ†• è§„åˆ™å…³ç³»é…ç½®
â”‚   â”‚   â””â”€â”€ mod.rs                 # æ›´æ–°: å¯¼å‡ºæ–°æ¨¡å—
â”‚   â”œâ”€â”€ models.rs                  # æ›´æ–°: æ–°å¢ RootCauseAnalysis
â”‚   â””â”€â”€ mod.rs                     # æ›´æ–°: é›†æˆæ ¹å› æ¨æ–­

å‰ç«¯:
â”œâ”€â”€ frontend/src/app/
â”‚   â”œâ”€â”€ @core/data/
â”‚   â”‚   â””â”€â”€ node.service.ts        # æ›´æ–°: æ–°å¢æ¥å£å®šä¹‰
â”‚   â””â”€â”€ pages/starrocks/queries/profile-queries/
â”‚       â”œâ”€â”€ profile-queries.component.ts   # æ›´æ–°: æ–°å¢æ–¹æ³•
â”‚       â”œâ”€â”€ profile-queries.component.html # æ›´æ–°: æ ¹å› åˆ†æè§†å›¾
â”‚       â””â”€â”€ profile-queries.component.scss # æ›´æ–°: æ ·å¼
```

---

## ä¸ƒã€æµ‹è¯•ç”¨ä¾‹

### 7.1 å•å…ƒæµ‹è¯•

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_causal_chain_detection() {
        // åœºæ™¯: S001 â†’ G003, S001 â†’ J006
        let diagnostics = vec![
            create_diagnostic("S001", "æ•°æ®å€¾æ–œ"),
            create_diagnostic("G003", "æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
            create_diagnostic("J006", "Shuffle å€¾æ–œ"),
        ];
        
        let engine = RootCauseInferenceEngine::new();
        let results = engine.infer(&diagnostics);
        
        // åº”è¯¥åªæœ‰ä¸€ä¸ªæ ¹å›  (S001)
        assert_eq!(results.len(), 1);
        assert_eq!(results[0].root_cause.rule_id, "S001");
        assert_eq!(results[0].symptoms.len(), 2);
        assert!(!results[0].is_independent);
    }

    #[test]
    fn test_independent_issues() {
        // åœºæ™¯: S001 å’Œ S016 æ˜¯ç‹¬ç«‹é—®é¢˜
        let diagnostics = vec![
            create_diagnostic("S001", "æ•°æ®å€¾æ–œ"),
            create_diagnostic("S016", "å°æ–‡ä»¶è¿‡å¤š"),
        ];
        
        let engine = RootCauseInferenceEngine::new();
        let results = engine.infer(&diagnostics);
        
        // åº”è¯¥æœ‰ä¸¤ä¸ªç‹¬ç«‹é—®é¢˜
        assert_eq!(results.len(), 2);
        assert!(results.iter().all(|r| r.is_independent || r.symptoms.is_empty()));
    }

    #[test]
    fn test_mutual_exclusion() {
        // åœºæ™¯: G001 å’Œ G001b äº’æ–¥
        let diagnostics = vec![
            create_diagnostic("G001", "æœ€è€—æ—¶èŠ‚ç‚¹"),
            create_diagnostic("G001b", "æ¬¡è€—æ—¶èŠ‚ç‚¹"),
        ];
        
        let engine = RootCauseInferenceEngine::new();
        let results = engine.infer(&diagnostics);
        
        // G001 åº”è¯¥æŠ‘åˆ¶ G001b
        // å®é™…å®ç°ä¸­å¯èƒ½éœ€è¦åœ¨æ¨æ–­å‰å¤„ç†äº’æ–¥
    }

    #[test]
    fn test_confidence_calculation() {
        let symptoms = vec![
            SymptomInfo {
                diagnostic: create_diagnostic("G003", "æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
                relation: RuleRelation::Causal,
                confidence: 0.9,
                description: "".to_string(),
            },
            SymptomInfo {
                diagnostic: create_diagnostic("J006", "Shuffle å€¾æ–œ"),
                relation: RuleRelation::Causal,
                confidence: 0.8,
                description: "".to_string(),
            },
        ];
        
        let engine = RootCauseInferenceEngine::new();
        let confidence = engine.calculate_confidence(&symptoms);
        
        assert!((confidence - 0.85).abs() < 0.01);
    }
}
```

### 7.2 é›†æˆæµ‹è¯•

```rust
#[test]
fn test_full_analysis_with_root_cause() {
    let profile_text = include_str!("../tests/fixtures/profiles/profile1.txt");
    let result = analyze_profile(profile_text, None).unwrap();
    
    // éªŒè¯æ ¹å› åˆ†æç»“æœå­˜åœ¨
    assert!(result.root_cause_analysis.is_some());
    
    let root_causes = result.root_cause_analysis.unwrap();
    
    // éªŒè¯æ ¹å› ä¼˜å…ˆäºç—‡çŠ¶
    for rc in &root_causes {
        if !rc.is_independent {
            // æ ¹å› çš„ä¸¥é‡åº¦åº”è¯¥ >= ç—‡çŠ¶
            for symptom in &rc.symptoms {
                assert!(rc.root_cause.severity >= symptom.diagnostic.severity);
            }
        }
    }
}
```

---

## å…«ã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| è§„åˆ™å…³ç³»é…ç½®ä¸å‡†ç¡® | è¯¯å¯¼ç”¨æˆ· | åŸºäº StarRocks ä¸“å®¶ç»éªŒé…ç½®ï¼ŒæŒç»­è¿­ä»£ |
| ç½®ä¿¡åº¦è®¡ç®—ä¸åˆç† | ç”¨æˆ·ä¸ä¿¡ä»» | æä¾›ç½®ä¿¡åº¦è¯´æ˜ï¼Œå…è®¸ç”¨æˆ·åé¦ˆ |
| æ€§èƒ½å½±å“ | åˆ†æå˜æ…¢ | å…³ç³»å›¾é¢„æ„å»ºï¼ŒO(n) å¤æ‚åº¦ |
| å‰ç«¯å±•ç¤ºå¤æ‚ | ç”¨æˆ·å›°æƒ‘ | æä¾›ç®€æ´/è¯¦ç»†ä¸¤ç§è§†å›¾åˆ‡æ¢ |

---

## ä¹ã€æœªæ¥æ‰©å±•

### 9.1 æœºå™¨å­¦ä¹ å¢å¼º

```
Phase 2 (æœªæ¥):
â”œâ”€â”€ åŸºäºå†å²æ•°æ®å­¦ä¹ è§„åˆ™å…³ç³»
â”œâ”€â”€ åŠ¨æ€è°ƒæ•´ç½®ä¿¡åº¦
â”œâ”€â”€ é¢„æµ‹æ€§èƒ½æ”¹å–„æ•ˆæœ
â””â”€â”€ ä¸ªæ€§åŒ–å»ºè®®æ’åº
```

### 9.2 ç”¨æˆ·åé¦ˆé—­ç¯

```
ç”¨æˆ·æ“ä½œ â†’ è®°å½•åé¦ˆ â†’ è°ƒæ•´ç½®ä¿¡åº¦ â†’ æ”¹è¿›æ¨æ–­
    â†‘                                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åã€å‚è€ƒèµ„æ–™

- [profile-diagnostic-system.md](./profile-diagnostic-system.md) - åŸå§‹è®¾è®¡æ–‡æ¡£
- [profile-diagnostic-system-review.md](./profile-diagnostic-system-review.md) - å®¡æŸ¥æ–‡æ¡£
- [smart-parameter-recommendation.md](./smart-parameter-recommendation.md) - å‚æ•°æ¨èè®¾è®¡
- StarRocks Query Profile å®˜æ–¹æ–‡æ¡£

---

## é™„å½• A: å®Œæ•´è§„åˆ™å…³ç³»å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              è§„åˆ™å› æœå…³ç³»å›¾              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  S001   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  G003   â”‚
    â”‚æ•°æ®å€¾æ–œ â”‚                                      â”‚æ—¶é—´å€¾æ–œ â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                 â†‘
         â”‚ Causal (0.9)                                    â”‚
         â”‚                                                 â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                                 â”‚
         â”‚ Causal (0.85)                                   â”‚
         â†“                                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
    â”‚  J006   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚Shuffleå€¾â”‚  Aggravates (0.7)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Causal (0.85)         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  J001   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  G002   â”‚
    â”‚Joinè†¨èƒ€ â”‚                               â”‚å†…å­˜è¿‡é«˜ â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Causal (0.8)
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  J003   â”‚
    â”‚HashTableâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Causal (0.75)         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  S009   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  S007   â”‚
    â”‚ç¼“å­˜å‘½ä¸­ä½â”‚                               â”‚IOç“¶é¢ˆ  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â†‘â”€â”€â”€â”€â”˜
                                                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Causal (0.8)               â”‚
    â”‚  S016   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚å°æ–‡ä»¶   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         MutuallyExclusive     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  G001   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  G001b  â”‚
    â”‚æœ€è€—æ—¶   â”‚                               â”‚æ¬¡è€—æ—¶   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## é™„å½• B: æ·±åº¦åæ€ä¸ v2.0 è®¾è®¡

### B.1 å½“å‰è®¾è®¡é—®é¢˜åˆ†æ

#### é—®é¢˜ 1: è§„åˆ™è¦†ç›–ä¸¥é‡ä¸è¶³

| ç±»åˆ« | è§„åˆ™æ•° | å·²é…ç½®å…³ç³» | è¦†ç›–ç‡ |
|-----|-------|-----------|-------|
| Scan (S) | 15 | 4 | 27% |
| Join (J) | 11 | 3 | 27% |
| Aggregate (A) | 6 | 1 | 17% |
| Exchange (E) | 3 | 0 | 0% |
| Sort (T) | 5 | 0 | 0% |
| Sink (I) | 3 | 0 | 0% |
| Query (Q) | 9 | 0 | 0% |
| Common (G) | 3 | 2 | 67% |
| å…¶ä»– | 6 | 0 | 0% |
| **æ€»è®¡** | **62** | **9** | **15%** |

#### é—®é¢˜ 2: ç¼ºä¹ä¸Šä¸‹æ–‡æ„ŸçŸ¥

- ä¸è€ƒè™‘æ‰§è¡Œè®¡åˆ’æ‹“æ‰‘
- ä¸è€ƒè™‘åŒä¸€èŠ‚ç‚¹å¤šä¸ªé—®é¢˜çš„å…³è”
- ä¸è€ƒè™‘æŒ‡æ ‡ç›¸å…³æ€§

### B.2 æ™ºèƒ½æ ¹å› åˆ†æå¼•æ“ v2.0

#### ä¸‰å±‚æ¨æ–­æ¶æ„

```
Layer 1: é™æ€è§„åˆ™å…³ç³» (ç½®ä¿¡åº¦ 0.8-1.0)
    â†“
Layer 2: æ‹“æ‰‘æ„ŸçŸ¥æ¨æ–­ (ç½®ä¿¡åº¦ 0.5-0.8)
    â†“
Layer 3: æŒ‡æ ‡ç›¸å…³æ€§æ¨æ–­ (ç½®ä¿¡åº¦ 0.3-0.5)
    â†“
ç»¼åˆæ¨æ–­ & ç½®ä¿¡åº¦èåˆ
```

### B.3 å®Œæ•´è§„åˆ™å…³ç³»é…ç½®è¡¨ (62 æ¡è§„åˆ™å…¨è¦†ç›–)

```rust
/// å®Œæ•´çš„è§„åˆ™å…³ç³»é…ç½®è¡¨ v2.0
pub const RULE_RELATIONS_V2: &[RuleRelationConfig] = &[
    // ========================================================================
    // ä¸€ã€æ•°æ®å€¾æ–œå› æœé“¾ (Data Skew Chain)
    // ========================================================================
    
    // S001 æ•°æ®å€¾æ–œ æ˜¯å¤šä¸ªé—®é¢˜çš„æ ¹å› 
    ("S001", "G003", Causal, 0.95, "æ•°æ®å€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    ("S001", "J006", Causal, 0.90, "æ•°æ®å€¾æ–œ â†’ Shuffle å€¾æ–œ"),
    ("S001", "A001", Causal, 0.85, "æ•°æ®å€¾æ–œ â†’ èšåˆå€¾æ–œ"),
    ("S001", "T002", Causal, 0.80, "æ•°æ®å€¾æ–œ â†’ æ’åºå€¾æ–œ"),
    
    // S002 IO å€¾æ–œ
    ("S002", "G003", Aggravates, 0.70, "IO å€¾æ–œåŠ å‰§æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    
    // ========================================================================
    // äºŒã€è¿‡æ»¤æ•ˆæœå› æœé“¾ (Filter Effectiveness Chain)
    // ========================================================================
    
    // ç´¢å¼•é—®é¢˜ â†’ è¿‡æ»¤æ•ˆæœå·®
    ("S008", "S003", Causal, 0.85, "ZoneMap æœªç”Ÿæ•ˆ â†’ è¿‡æ»¤æ•ˆæœå·®"),
    ("S012", "S003", Causal, 0.80, "Bitmap ç´¢å¼•æœªç”Ÿæ•ˆ â†’ è¿‡æ»¤æ•ˆæœå·®"),
    ("S013", "S003", Causal, 0.80, "BloomFilter æœªç”Ÿæ•ˆ â†’ è¿‡æ»¤æ•ˆæœå·®"),
    ("S004", "S003", Causal, 0.90, "è°“è¯æœªä¸‹æ¨ â†’ è¿‡æ»¤æ•ˆæœå·®"),
    
    // Runtime Filter é—®é¢˜é“¾
    ("J004", "S010", Causal, 0.90, "Join RF æœªç”Ÿæ•ˆ â†’ Scan RF æœªç”Ÿæ•ˆ"),
    ("S010", "S003", Causal, 0.75, "Scan RF æœªç”Ÿæ•ˆ â†’ è¿‡æ»¤æ•ˆæœå·®"),
    
    // è¿‡æ»¤æ•ˆæœå·® â†’ ä¸‹æ¸¸å½±å“
    ("S003", "Q001", Causal, 0.70, "è¿‡æ»¤æ•ˆæœå·® â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    ("S003", "G002", Causal, 0.60, "è¿‡æ»¤æ•ˆæœå·® â†’ å†…å­˜ä½¿ç”¨é«˜"),
    
    // ========================================================================
    // ä¸‰ã€å†…å­˜é—®é¢˜å› æœé“¾ (Memory Chain)
    // ========================================================================
    
    // Join è†¨èƒ€ â†’ å†…å­˜é—®é¢˜
    ("J001", "G002", Causal, 0.90, "Join è†¨èƒ€ â†’ å†…å­˜è¿‡é«˜"),
    ("J001", "J003", Causal, 0.85, "Join è†¨èƒ€ â†’ HashTable è¿‡å¤§"),
    ("J003", "G002", Causal, 0.80, "Join HashTable å¤§ â†’ å†…å­˜è¿‡é«˜"),
    
    // èšåˆ â†’ å†…å­˜é—®é¢˜
    ("A002", "G002", Causal, 0.85, "Agg HashTable å¤§ â†’ å†…å­˜è¿‡é«˜"),
    ("A003", "A002", Causal, 0.80, "èšåˆåŸºæ•°é«˜ â†’ HashTable å¤§"),
    
    // æ’åº â†’ å†…å­˜é—®é¢˜
    ("T001", "G002", Causal, 0.75, "æ’åºæ•°æ®é‡å¤§ â†’ å†…å­˜è¿‡é«˜"),
    
    // å†…å­˜è¿‡é«˜ â†’ Spill
    ("G002", "Q003", Causal, 0.90, "å†…å­˜è¿‡é«˜ â†’ è§¦å‘ Spill"),
    
    // ========================================================================
    // å››ã€IO é—®é¢˜å› æœé“¾ (IO Chain)
    // ========================================================================
    
    // ç¼“å­˜é—®é¢˜ â†’ IO ç“¶é¢ˆ
    ("S009", "S007", Causal, 0.80, "ç¼“å­˜å‘½ä¸­ä½ â†’ IO ç“¶é¢ˆ"),
    
    // å°æ–‡ä»¶ â†’ IO ç“¶é¢ˆ
    ("S016", "S007", Causal, 0.85, "å°æ–‡ä»¶è¿‡å¤š â†’ IO ç“¶é¢ˆ"),
    
    // IO çº¿ç¨‹æ± é¥±å’Œ
    ("S005", "S007", Causal, 0.75, "IO çº¿ç¨‹æ± é¥±å’Œ â†’ IO ç“¶é¢ˆ"),
    
    // Rowset ç¢ç‰‡åŒ–
    ("S006", "S007", Causal, 0.70, "Rowset ç¢ç‰‡åŒ– â†’ IO ç“¶é¢ˆ"),
    
    // è½¯åˆ é™¤
    ("S011", "S003", Causal, 0.65, "è½¯åˆ é™¤è¿‡å¤š â†’ è¿‡æ»¤æ•ˆæœå·®"),
    
    // ========================================================================
    // äº”ã€Join é—®é¢˜å› æœé“¾ (Join Chain)
    // ========================================================================
    
    // Join é¡ºåºé—®é¢˜
    ("J002", "J001", Causal, 0.75, "Join é¡ºåºä¸ä¼˜ â†’ å¯èƒ½å¯¼è‡´è†¨èƒ€"),
    ("J002", "E001", Causal, 0.70, "Join é¡ºåºä¸ä¼˜ â†’ Shuffle æ•°æ®é‡å¤§"),
    
    // Broadcast é—®é¢˜
    ("J005", "G002", Causal, 0.80, "Broadcast è¡¨è¿‡å¤§ â†’ å†…å­˜è¿‡é«˜"),
    ("J005", "E002", Causal, 0.85, "Broadcast è¡¨è¿‡å¤§ â†’ ç½‘ç»œä¼ è¾“å¤§"),
    
    // Join å€¾æ–œ
    ("J006", "G003", Causal, 0.85, "Shuffle å€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    
    // Join ç±»å‹é—®é¢˜
    ("J007", "J001", Causal, 0.70, "Cross Join â†’ ç»“æœè†¨èƒ€"),
    ("J008", "G002", Causal, 0.65, "Nested Loop Join â†’ å†…å­˜/æ—¶é—´é—®é¢˜"),
    
    // ========================================================================
    // å…­ã€Exchange é—®é¢˜å› æœé“¾ (Exchange Chain)
    // ========================================================================
    
    ("E001", "Q001", Causal, 0.70, "Shuffle æ•°æ®é‡å¤§ â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    ("E002", "G002", Causal, 0.75, "Broadcast æ•°æ®é‡å¤§ â†’ å†…å­˜è¿‡é«˜"),
    ("E003", "G003", Causal, 0.80, "Exchange å€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    
    // ========================================================================
    // ä¸ƒã€æ’åºé—®é¢˜å› æœé“¾ (Sort Chain)
    // ========================================================================
    
    ("T002", "G003", Causal, 0.85, "æ’åºå€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    ("T003", "Q003", Causal, 0.80, "æ’åº Spill â†’ æ€§èƒ½ä¸‹é™"),
    ("T004", "Q001", Causal, 0.65, "TopN ä¼˜åŒ–æœªç”Ÿæ•ˆ â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    
    // ========================================================================
    // å…«ã€èšåˆé—®é¢˜å› æœé“¾ (Aggregate Chain)
    // ========================================================================
    
    ("A001", "G003", Causal, 0.90, "èšåˆå€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    ("A004", "Q003", Causal, 0.80, "èšåˆ Spill â†’ æ€§èƒ½ä¸‹é™"),
    ("A005", "Q001", Causal, 0.60, "Distinct åŸºæ•°é«˜ â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    
    // ========================================================================
    // ä¹ã€Sink é—®é¢˜å› æœé“¾ (Sink Chain)
    // ========================================================================
    
    ("I001", "Q001", Causal, 0.70, "å†™å…¥ç“¶é¢ˆ â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    ("I002", "G003", Causal, 0.75, "å†™å…¥å€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ"),
    
    // ========================================================================
    // åã€Query çº§åˆ«é—®é¢˜ (Query Level)
    // ========================================================================
    
    // Q001 æ‰§è¡Œæ—¶é—´é•¿ é€šå¸¸æ˜¯ç—‡çŠ¶ï¼Œä¸æ˜¯æ ¹å› 
    // Q002 å¹¶è¡Œåº¦ä¸è¶³
    ("Q002", "Q001", Causal, 0.65, "å¹¶è¡Œåº¦ä¸è¶³ â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    
    // Q003 Spill æ˜¯ç—‡çŠ¶
    // Q004 èµ„æºç­‰å¾…
    ("Q004", "Q001", Causal, 0.80, "èµ„æºç­‰å¾… â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    
    // Q005 ç½‘ç»œç“¶é¢ˆ
    ("Q005", "Q001", Causal, 0.75, "ç½‘ç»œç“¶é¢ˆ â†’ æ‰§è¡Œæ—¶é—´é•¿"),
    
    // ========================================================================
    // åä¸€ã€äº’æ–¥å…³ç³» (Mutual Exclusion)
    // ========================================================================
    
    ("G001", "G001b", MutuallyExclusive, 1.0, "æœ€è€—æ—¶ä¸æ¬¡è€—æ—¶äº’æ–¥"),
    
    // ========================================================================
    // åäºŒã€ç‹¬ç«‹é—®é¢˜æ ‡è®° (Independent Issues)
    // ========================================================================
    
    // ä»¥ä¸‹è§„åˆ™é€šå¸¸æ˜¯ç‹¬ç«‹é—®é¢˜ï¼Œä¸ä¸å…¶ä»–è§„åˆ™æœ‰å› æœå…³ç³»
    // S014 Colocate Join æœºä¼š - ä¼˜åŒ–å»ºè®®ï¼Œéé—®é¢˜
    // P001 Project åˆ—è¿‡å¤š - ç‹¬ç«‹é—®é¢˜
    // W001 Window å‡½æ•°é—®é¢˜ - ç‹¬ç«‹é—®é¢˜
    // F001-F003 Filter é—®é¢˜ - ç‹¬ç«‹é—®é¢˜
];
```

### B.4 æ‹“æ‰‘æ„ŸçŸ¥æ¨æ–­ç®—æ³•

```rust
/// åŸºäºæ‰§è¡Œè®¡åˆ’æ‹“æ‰‘çš„å› æœæ¨æ–­
pub struct TopologyAwareInference {
    /// æ‰§è¡Œè®¡åˆ’ DAG
    dag: ExecutionDAG,
}

impl TopologyAwareInference {
    /// åˆ†æä¸Šä¸‹æ¸¸ä¼ å¯¼å…³ç³»
    pub fn infer_topology_relations(
        &self,
        diagnostics: &[DiagnosticResult],
    ) -> Vec<InferredRelation> {
        let mut relations = Vec::new();
        
        // æŒ‰èŠ‚ç‚¹åˆ†ç»„è¯Šæ–­
        let node_diags: HashMap<i32, Vec<&DiagnosticResult>> = 
            diagnostics.iter()
                .filter_map(|d| d.plan_node_id.map(|id| (id, d)))
                .fold(HashMap::new(), |mut acc, (id, d)| {
                    acc.entry(id).or_default().push(d);
                    acc
                });
        
        // éå† DAGï¼Œåˆ†æä¸Šä¸‹æ¸¸å…³ç³»
        for (node_id, diags) in &node_diags {
            // è·å–ä¸Šæ¸¸èŠ‚ç‚¹
            let upstream_nodes = self.dag.get_upstream(*node_id);
            
            for upstream_id in upstream_nodes {
                if let Some(upstream_diags) = node_diags.get(&upstream_id) {
                    // åˆ†æä¸Šæ¸¸é—®é¢˜æ˜¯å¦å¯èƒ½å¯¼è‡´å½“å‰èŠ‚ç‚¹é—®é¢˜
                    for upstream_diag in upstream_diags {
                        for current_diag in diags {
                            if let Some(relation) = self.infer_propagation(
                                upstream_diag,
                                current_diag,
                            ) {
                                relations.push(relation);
                            }
                        }
                    }
                }
            }
        }
        
        relations
    }
    
    /// æ¨æ–­é—®é¢˜ä¼ å¯¼
    fn infer_propagation(
        &self,
        upstream: &DiagnosticResult,
        downstream: &DiagnosticResult,
    ) -> Option<InferredRelation> {
        // è§„åˆ™: ä¸Šæ¸¸æ•°æ®é—®é¢˜ â†’ ä¸‹æ¸¸æ€§èƒ½é—®é¢˜
        let propagation_rules = [
            // ä¸Šæ¸¸æ•°æ®é‡å¤§ â†’ ä¸‹æ¸¸å¤„ç†æ…¢
            (vec!["S003", "S007", "J001"], vec!["G001", "G002", "Q001"]),
            // ä¸Šæ¸¸å€¾æ–œ â†’ ä¸‹æ¸¸å€¾æ–œ
            (vec!["S001", "S002", "J006"], vec!["G003", "A001", "T002"]),
            // ä¸Šæ¸¸å†…å­˜é—®é¢˜ â†’ ä¸‹æ¸¸ Spill
            (vec!["G002", "J003", "A002"], vec!["Q003"]),
        ];
        
        for (upstream_rules, downstream_rules) in &propagation_rules {
            if upstream_rules.contains(&upstream.rule_id.as_str())
                && downstream_rules.contains(&downstream.rule_id.as_str())
            {
                return Some(InferredRelation {
                    source: upstream.clone(),
                    target: downstream.clone(),
                    relation_type: RuleRelation::Causal,
                    confidence: 0.6, // æ‹“æ‰‘æ¨æ–­ç½®ä¿¡åº¦è¾ƒä½
                    inference_method: "topology",
                });
            }
        }
        
        None
    }
}
```

### B.5 åŒèŠ‚ç‚¹æŒ‡æ ‡ç›¸å…³æ€§åˆ†æ

```rust
/// åŒä¸€èŠ‚ç‚¹å¤šä¸ªè¯Šæ–­çš„ç›¸å…³æ€§åˆ†æ
pub struct SameNodeCorrelation;

impl SameNodeCorrelation {
    /// åˆ†æåŒä¸€èŠ‚ç‚¹çš„å¤šä¸ªè¯Šæ–­æ˜¯å¦ç›¸å…³
    pub fn analyze(
        node_diagnostics: &[DiagnosticResult],
    ) -> Vec<InferredRelation> {
        let mut relations = Vec::new();
        
        // åŒèŠ‚ç‚¹ç›¸å…³æ€§è§„åˆ™
        let correlation_rules = [
            // Scan èŠ‚ç‚¹: ç´¢å¼•é—®é¢˜ â†’ è¿‡æ»¤é—®é¢˜
            CorrelationRule {
                causes: vec!["S004", "S008", "S012", "S013"],
                effects: vec!["S003"],
                confidence: 0.85,
            },
            // Scan èŠ‚ç‚¹: IO é—®é¢˜é“¾
            CorrelationRule {
                causes: vec!["S005", "S006", "S009", "S016"],
                effects: vec!["S007"],
                confidence: 0.80,
            },
            // Join èŠ‚ç‚¹: è†¨èƒ€ â†’ å†…å­˜
            CorrelationRule {
                causes: vec!["J001", "J007"],
                effects: vec!["J003"],
                confidence: 0.85,
            },
            // Aggregate èŠ‚ç‚¹: åŸºæ•° â†’ HashTable
            CorrelationRule {
                causes: vec!["A003", "A005"],
                effects: vec!["A002"],
                confidence: 0.80,
            },
        ];
        
        for rule in &correlation_rules {
            let causes: Vec<_> = node_diagnostics.iter()
                .filter(|d| rule.causes.contains(&d.rule_id.as_str()))
                .collect();
            let effects: Vec<_> = node_diagnostics.iter()
                .filter(|d| rule.effects.contains(&d.rule_id.as_str()))
                .collect();
            
            for cause in &causes {
                for effect in &effects {
                    relations.push(InferredRelation {
                        source: (*cause).clone(),
                        target: (*effect).clone(),
                        relation_type: RuleRelation::Causal,
                        confidence: rule.confidence,
                        inference_method: "same_node_correlation",
                    });
                }
            }
        }
        
        relations
    }
}
```

### B.6 ç»¼åˆç½®ä¿¡åº¦è®¡ç®—

```rust
/// ç»¼åˆå¤šå±‚æ¨æ–­çš„ç½®ä¿¡åº¦
pub fn calculate_combined_confidence(
    static_conf: Option<f64>,
    topology_conf: Option<f64>,
    correlation_conf: Option<f64>,
) -> f64 {
    // æƒé‡é…ç½®
    const W_STATIC: f64 = 0.6;
    const W_TOPOLOGY: f64 = 0.3;
    const W_CORRELATION: f64 = 0.1;
    
    let mut total_weight = 0.0;
    let mut weighted_sum = 0.0;
    
    if let Some(conf) = static_conf {
        weighted_sum += W_STATIC * conf;
        total_weight += W_STATIC;
    }
    
    if let Some(conf) = topology_conf {
        weighted_sum += W_TOPOLOGY * conf;
        total_weight += W_TOPOLOGY;
    }
    
    if let Some(conf) = correlation_conf {
        weighted_sum += W_CORRELATION * conf;
        total_weight += W_CORRELATION;
    }
    
    if total_weight > 0.0 {
        weighted_sum / total_weight
    } else {
        0.0
    }
}
```

### B.7 v2.0 vs v1.0 å¯¹æ¯”

| ç»´åº¦ | v1.0 | v2.0 |
|-----|------|------|
| è§„åˆ™å…³ç³»è¦†ç›– | 15% (9/62) | 100% (62/62) |
| æ¨æ–­å±‚æ¬¡ | 1 å±‚ (é™æ€) | 3 å±‚ (é™æ€+æ‹“æ‰‘+ç›¸å…³æ€§) |
| ä¸Šä¸‹æ–‡æ„ŸçŸ¥ | âŒ | âœ… æ‰§è¡Œè®¡åˆ’æ‹“æ‰‘ |
| åŒèŠ‚ç‚¹åˆ†æ | âŒ | âœ… æŒ‡æ ‡ç›¸å…³æ€§ |
| ç½®ä¿¡åº¦è®¡ç®— | ç®€å•å¹³å‡ | åŠ æƒèåˆ |
| å‡†ç¡®æ€§é¢„ä¼° | 60% | 85%+ |

### B.8 å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | å·¥ä½œé‡ |
|-------|------|-------|
| P0 | å®Œå–„é™æ€è§„åˆ™å…³ç³»è¡¨ (62 æ¡å…¨è¦†ç›–) | 1 å¤© |
| P0 | å®ç°ä¸‰å±‚æ¨æ–­æ¶æ„ | 2 å¤© |
| P1 | æ‹“æ‰‘æ„ŸçŸ¥æ¨æ–­ | 1 å¤© |
| P1 | åŒèŠ‚ç‚¹ç›¸å…³æ€§åˆ†æ | 0.5 å¤© |
| P2 | ç½®ä¿¡åº¦èåˆä¼˜åŒ– | 0.5 å¤© |
| **æ€»è®¡** | | **5 å¤©** |


---

## é™„å½• C: v3.0 æ•°æ®é©±åŠ¨çš„æ™ºèƒ½æ ¹å› åˆ†æ

### C.1 v2.0 ä»å­˜åœ¨çš„é—®é¢˜

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|-----|------|------|
| é™æ€è§„åˆ™å±€é™ | è§„åˆ™å…³ç³»æ˜¯ç¡¬ç¼–ç çš„ | æ— æ³•é€‚åº”å¤æ‚åœºæ™¯ |
| ç¼ºä¹æ•°æ®éªŒè¯ | ä¸ç”¨å®é™…æŒ‡æ ‡éªŒè¯å› æœ | å¯èƒ½è¯¯åˆ¤ |
| ç¼ºä¹æ—¶é—´åˆ†æ | ä¸è€ƒè™‘æ‰§è¡Œæ—¶é—´é¡ºåº | å› æœæ–¹å‘å¯èƒ½é”™è¯¯ |
| ç¼ºä¹æ•°å€¼ç›¸å…³æ€§ | åªçœ‹æ˜¯å¦è§¦å‘ï¼Œä¸çœ‹æ•°å€¼ | ç½®ä¿¡åº¦ä¸å‡†ç¡® |

### C.2 v3.0 æ¶æ„ï¼šå››å±‚æ™ºèƒ½æ¨æ–­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ™ºèƒ½æ ¹å› åˆ†æå¼•æ“ v3.0 - æ•°æ®é©±åŠ¨æ¶æ„                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Layer 1: é™æ€è§„åˆ™å…³ç³» (Rule-based)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ é¢„å®šä¹‰å› æœå…³ç³»è¡¨                                       â”‚   â”‚
â”‚  â”‚ â€¢ åŸºç¡€ç½®ä¿¡åº¦: 0.5 (éœ€è¦æ•°æ®éªŒè¯åè°ƒæ•´)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  Layer 2: æŒ‡æ ‡æ•°å€¼éªŒè¯ (Metric Validation) ğŸ†•                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ éªŒè¯å› æœå…³ç³»çš„æŒ‡æ ‡æ˜¯å¦æ•°å€¼ç›¸å…³                         â”‚   â”‚
â”‚  â”‚ â€¢ è®¡ç®—ç›¸å…³ç³»æ•°ï¼Œè°ƒæ•´ç½®ä¿¡åº¦                               â”‚   â”‚
â”‚  â”‚ â€¢ ä¾‹: S001.skew_ratio â‰ˆ G003.skew_ratio â†’ ç½®ä¿¡åº¦ +0.3   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  Layer 3: æ—¶é—´é¡ºåºéªŒè¯ (Temporal Validation) ğŸ†•                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ éªŒè¯å› æœå…³ç³»çš„æ—¶é—´é¡ºåºæ˜¯å¦æ­£ç¡®                         â”‚   â”‚
â”‚  â”‚ â€¢ åŸå› å¿…é¡»å‘ç”Ÿåœ¨ç»“æœä¹‹å‰                                 â”‚   â”‚
â”‚  â”‚ â€¢ ä¾‹: Scan æ‰§è¡Œæ—¶é—´ < Join æ‰§è¡Œæ—¶é—´ â†’ å› æœæˆç«‹           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  Layer 4: æ‹“æ‰‘ä¼ å¯¼åˆ†æ (Topology Propagation)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ åŸºäºæ‰§è¡Œè®¡åˆ’ DAG çš„ä¼ å¯¼åˆ†æ                            â”‚   â”‚
â”‚  â”‚ â€¢ ä¸Šæ¸¸é—®é¢˜ â†’ ä¸‹æ¸¸ç—‡çŠ¶                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  ç»¼åˆæ¨æ–­ & åŠ¨æ€ç½®ä¿¡åº¦                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ confidence = base Ã— metric_factor Ã— temporal_factor     â”‚   â”‚
â”‚  â”‚            Ã— topology_factor                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### C.3 æŒ‡æ ‡æ•°å€¼éªŒè¯ç®—æ³•

```rust
/// æŒ‡æ ‡æ•°å€¼éªŒè¯å™¨
pub struct MetricValidator;

impl MetricValidator {
    /// éªŒè¯ä¸¤ä¸ªè¯Šæ–­çš„æŒ‡æ ‡æ˜¯å¦æ•°å€¼ç›¸å…³
    pub fn validate_correlation(
        &self,
        cause: &DiagnosticResult,
        effect: &DiagnosticResult,
        relation: &RuleRelationConfig,
    ) -> f64 {
        // è·å–å…³é”®æŒ‡æ ‡
        let cause_metrics = self.extract_key_metrics(cause);
        let effect_metrics = self.extract_key_metrics(effect);
        
        match (cause.rule_id.as_str(), effect.rule_id.as_str()) {
            // S001 â†’ G003: æ•°æ®å€¾æ–œ â†’ æ—¶é—´å€¾æ–œ
            // éªŒè¯: ä¸¤è€…çš„ skew_ratio åº”è¯¥æ¥è¿‘
            ("S001", "G003") => {
                let data_skew = cause_metrics.get("skew_ratio").unwrap_or(&0.0);
                let time_skew = effect_metrics.get("skew_ratio").unwrap_or(&0.0);
                
                // è®¡ç®—ç›¸ä¼¼åº¦ (1.0 = å®Œå…¨ç›¸åŒ, 0.0 = å®Œå…¨ä¸åŒ)
                let ratio = if *data_skew > *time_skew {
                    time_skew / data_skew
                } else {
                    data_skew / time_skew
                };
                
                // å¦‚æœä¸¤ä¸ªå€¾æ–œæ¯”ç‡æ¥è¿‘ï¼Œå› æœå…³ç³»æ›´å¯ä¿¡
                if ratio > 0.8 {
                    1.0  // é«˜åº¦ç›¸å…³
                } else if ratio > 0.5 {
                    0.7  // ä¸­åº¦ç›¸å…³
                } else {
                    0.3  // ä½åº¦ç›¸å…³ï¼Œå¯èƒ½æœ‰å…¶ä»–å› ç´ 
                }
            }
            
            // J001 â†’ G002: Join è†¨èƒ€ â†’ å†…å­˜è¿‡é«˜
            // éªŒè¯: è†¨èƒ€å€æ•°ä¸å†…å­˜å¢é•¿åº”è¯¥æˆæ¯”ä¾‹
            ("J001", "G002") => {
                let expansion = cause_metrics.get("expansion_ratio").unwrap_or(&1.0);
                let memory = effect_metrics.get("memory_bytes").unwrap_or(&0.0);
                let input_rows = cause_metrics.get("input_rows").unwrap_or(&1.0);
                
                // é¢„æœŸå†…å­˜ â‰ˆ è¾“å…¥è¡Œæ•° Ã— è†¨èƒ€å€æ•° Ã— æ¯è¡Œå¤§å°
                let expected_memory = input_rows * expansion * 100.0; // å‡è®¾æ¯è¡Œ 100 bytes
                let actual_ratio = memory / expected_memory;
                
                if actual_ratio > 0.5 && actual_ratio < 2.0 {
                    1.0  // ç¬¦åˆé¢„æœŸ
                } else {
                    0.5  // ä¸å¤ªç¬¦åˆï¼Œå¯èƒ½æœ‰å…¶ä»–å› ç´ 
                }
            }
            
            // S009 â†’ S007: ç¼“å­˜å‘½ä¸­ä½ â†’ IO ç“¶é¢ˆ
            // éªŒè¯: ç¼“å­˜æœªå‘½ä¸­çš„æ•°æ®é‡åº”è¯¥ä¸ IO é‡æ¥è¿‘
            ("S009", "S007") => {
                let cache_miss_bytes = cause_metrics.get("remote_bytes").unwrap_or(&0.0);
                let io_bytes = effect_metrics.get("io_bytes").unwrap_or(&0.0);
                
                let ratio = if *cache_miss_bytes > 0.0 {
                    io_bytes / cache_miss_bytes
                } else {
                    0.0
                };
                
                if ratio > 0.8 {
                    1.0  // IO ä¸»è¦æ¥è‡ªç¼“å­˜æœªå‘½ä¸­
                } else {
                    0.5  // IO å¯èƒ½æœ‰å…¶ä»–æ¥æº
                }
            }
            
            // é»˜è®¤: æ— æ³•éªŒè¯ï¼Œè¿”å›ä¸­ç­‰ç½®ä¿¡åº¦
            _ => 0.7
        }
    }
    
    /// ä»è¯Šæ–­ä¸­æå–å…³é”®æŒ‡æ ‡
    fn extract_key_metrics(&self, diag: &DiagnosticResult) -> HashMap<String, f64> {
        // ä» message æˆ– metrics ä¸­è§£ææ•°å€¼
        // å®é™…å®ç°éœ€è¦è§£æè¯Šæ–­æ¶ˆæ¯ä¸­çš„æ•°å€¼
        HashMap::new()
    }
}
```

### C.4 æ—¶é—´é¡ºåºéªŒè¯ç®—æ³•

```rust
/// æ—¶é—´é¡ºåºéªŒè¯å™¨
pub struct TemporalValidator;

impl TemporalValidator {
    /// éªŒè¯å› æœå…³ç³»çš„æ—¶é—´é¡ºåºæ˜¯å¦æ­£ç¡®
    pub fn validate_temporal_order(
        &self,
        cause: &DiagnosticResult,
        effect: &DiagnosticResult,
        execution_tree: &ExecutionTree,
    ) -> f64 {
        // è·å–èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´
        let cause_node = self.find_node(cause.plan_node_id, execution_tree);
        let effect_node = self.find_node(effect.plan_node_id, execution_tree);
        
        match (cause_node, effect_node) {
            (Some(c), Some(e)) => {
                // è·å–æ‰§è¡Œå¼€å§‹æ—¶é—´
                let cause_start = c.get_start_time();
                let effect_start = e.get_start_time();
                
                // åŸå› å¿…é¡»åœ¨ç»“æœä¹‹å‰å¼€å§‹æ‰§è¡Œ
                if cause_start <= effect_start {
                    1.0  // æ—¶é—´é¡ºåºæ­£ç¡®
                } else {
                    0.2  // æ—¶é—´é¡ºåºé”™è¯¯ï¼Œå› æœå…³ç³»ä¸å¤ªå¯èƒ½
                }
            }
            _ => 0.7  // æ— æ³•éªŒè¯ï¼Œè¿”å›ä¸­ç­‰ç½®ä¿¡åº¦
        }
    }
    
    /// éªŒè¯æ˜¯å¦åœ¨åŒä¸€æ‰§è¡Œè·¯å¾„ä¸Š
    pub fn validate_execution_path(
        &self,
        cause: &DiagnosticResult,
        effect: &DiagnosticResult,
        dag: &ExecutionDAG,
    ) -> f64 {
        let cause_id = cause.plan_node_id.unwrap_or(-1);
        let effect_id = effect.plan_node_id.unwrap_or(-1);
        
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä» cause åˆ° effect çš„è·¯å¾„
        if dag.has_path(cause_id, effect_id) {
            1.0  // åœ¨åŒä¸€æ‰§è¡Œè·¯å¾„ä¸Š
        } else if dag.has_common_ancestor(cause_id, effect_id) {
            0.6  // æœ‰å…±åŒç¥–å…ˆï¼Œå¯èƒ½é—´æ¥ç›¸å…³
        } else {
            0.3  // ä¸åœ¨åŒä¸€è·¯å¾„ï¼Œå› æœå…³ç³»è¾ƒå¼±
        }
    }
}
```

### C.5 åŠ¨æ€ç½®ä¿¡åº¦è®¡ç®—

```rust
/// åŠ¨æ€ç½®ä¿¡åº¦è®¡ç®—å™¨
pub struct DynamicConfidenceCalculator;

impl DynamicConfidenceCalculator {
    /// è®¡ç®—ç»¼åˆç½®ä¿¡åº¦
    pub fn calculate(
        &self,
        base_confidence: f64,           // é™æ€è§„åˆ™ç½®ä¿¡åº¦
        metric_factor: f64,             // æŒ‡æ ‡éªŒè¯å› å­
        temporal_factor: f64,           // æ—¶é—´éªŒè¯å› å­
        topology_factor: f64,           // æ‹“æ‰‘éªŒè¯å› å­
    ) -> f64 {
        // ä¹˜æ³•æ¨¡å‹: ä»»ä½•ä¸€ä¸ªå› å­ä½éƒ½ä¼šé™ä½æ€»ç½®ä¿¡åº¦
        let combined = base_confidence 
            * metric_factor 
            * temporal_factor 
            * topology_factor;
        
        // å½’ä¸€åŒ–åˆ° [0, 1]
        combined.min(1.0).max(0.0)
    }
    
    /// åˆ¤æ–­å› æœå…³ç³»æ˜¯å¦å¯ä¿¡
    pub fn is_credible(&self, confidence: f64) -> bool {
        confidence >= 0.6  // 60% ä»¥ä¸Šæ‰è®¤ä¸ºå¯ä¿¡
    }
    
    /// è·å–ç½®ä¿¡åº¦ç­‰çº§
    pub fn get_confidence_level(&self, confidence: f64) -> &'static str {
        match confidence {
            c if c >= 0.9 => "éå¸¸é«˜",
            c if c >= 0.7 => "é«˜",
            c if c >= 0.5 => "ä¸­ç­‰",
            c if c >= 0.3 => "ä½",
            _ => "å¾ˆä½",
        }
    }
}
```

### C.6 å®Œæ•´çš„æ™ºèƒ½æ¨æ–­æµç¨‹

```rust
/// v3.0 æ™ºèƒ½æ ¹å› æ¨æ–­å¼•æ“
pub struct IntelligentRootCauseEngine {
    static_relations: StaticRelationGraph,
    metric_validator: MetricValidator,
    temporal_validator: TemporalValidator,
    confidence_calculator: DynamicConfidenceCalculator,
}

impl IntelligentRootCauseEngine {
    /// æ‰§è¡Œæ™ºèƒ½æ ¹å› æ¨æ–­
    pub fn infer(
        &self,
        diagnostics: &[DiagnosticResult],
        execution_tree: &ExecutionTree,
    ) -> Vec<RootCauseAnalysis> {
        let mut candidate_relations = Vec::new();
        
        // Step 1: åŸºäºé™æ€è§„åˆ™æ‰¾å‡ºå€™é€‰å› æœå…³ç³»
        for cause in diagnostics {
            for effect in diagnostics {
                if cause.rule_id == effect.rule_id {
                    continue;
                }
                
                if let Some(relation) = self.static_relations.get(&cause.rule_id, &effect.rule_id) {
                    candidate_relations.push((cause, effect, relation));
                }
            }
        }
        
        // Step 2: å¯¹æ¯ä¸ªå€™é€‰å…³ç³»è¿›è¡Œå¤šç»´åº¦éªŒè¯
        let mut validated_relations = Vec::new();
        
        for (cause, effect, relation) in candidate_relations {
            // 2.1 æŒ‡æ ‡æ•°å€¼éªŒè¯
            let metric_factor = self.metric_validator.validate_correlation(
                cause, effect, &relation
            );
            
            // 2.2 æ—¶é—´é¡ºåºéªŒè¯
            let temporal_factor = self.temporal_validator.validate_temporal_order(
                cause, effect, execution_tree
            );
            
            // 2.3 æ‹“æ‰‘è·¯å¾„éªŒè¯
            let topology_factor = self.temporal_validator.validate_execution_path(
                cause, effect, &execution_tree.dag
            );
            
            // 2.4 è®¡ç®—ç»¼åˆç½®ä¿¡åº¦
            let confidence = self.confidence_calculator.calculate(
                relation.confidence,
                metric_factor,
                temporal_factor,
                topology_factor,
            );
            
            // 2.5 åªä¿ç•™å¯ä¿¡çš„å…³ç³»
            if self.confidence_calculator.is_credible(confidence) {
                validated_relations.push(ValidatedRelation {
                    cause: cause.clone(),
                    effect: effect.clone(),
                    confidence,
                    factors: ConfidenceFactors {
                        base: relation.confidence,
                        metric: metric_factor,
                        temporal: temporal_factor,
                        topology: topology_factor,
                    },
                });
            }
        }
        
        // Step 3: æ„å»ºæ ¹å› åˆ†æç»“æœ
        self.build_root_cause_analysis(diagnostics, validated_relations)
    }
}
```

### C.7 v3.0 vs v2.0 vs v1.0 å¯¹æ¯”

| ç»´åº¦ | v1.0 | v2.0 | v3.0 |
|-----|------|------|------|
| è§„åˆ™è¦†ç›– | 15% | 100% | 100% |
| æ¨æ–­å±‚æ¬¡ | 1 å±‚ | 3 å±‚ | 4 å±‚ |
| æŒ‡æ ‡éªŒè¯ | âŒ | âŒ | âœ… |
| æ—¶é—´éªŒè¯ | âŒ | âŒ | âœ… |
| åŠ¨æ€ç½®ä¿¡åº¦ | âŒ | âŒ | âœ… |
| å‡†ç¡®æ€§é¢„ä¼° | 60% | 75% | **90%+** |
| è¯¯æŠ¥ç‡ | é«˜ | ä¸­ | **ä½** |
| å¯è§£é‡Šæ€§ | ä½ | ä¸­ | **é«˜** |

### C.8 å¯è§£é‡Šæ€§è¾“å‡ºç¤ºä¾‹

```json
{
  "root_cause_analysis": [
    {
      "root_cause": {
        "rule_id": "S001",
        "rule_name": "æ•°æ®å€¾æ–œ",
        "message": "Scan å­˜åœ¨æ•°æ®å€¾æ–œï¼Œmax/avg = 3.5"
      },
      "symptoms": [
        {
          "rule_id": "G003",
          "rule_name": "æ‰§è¡Œæ—¶é—´å€¾æ–œ",
          "message": "æ‰§è¡Œæ—¶é—´å€¾æ–œï¼Œmax/avg = 3.2"
        }
      ],
      "confidence": 0.89,
      "confidence_level": "é«˜",
      "confidence_breakdown": {
        "base_rule": 0.95,
        "metric_validation": 0.95,
        "temporal_validation": 1.0,
        "topology_validation": 1.0
      },
      "explanation": "æ•°æ®å€¾æ–œ(3.5x)ä¸æ‰§è¡Œæ—¶é—´å€¾æ–œ(3.2x)é«˜åº¦ç›¸å…³ï¼Œä¸”Scanåœ¨Joinä¹‹å‰æ‰§è¡Œï¼Œå› æœå…³ç³»æˆç«‹ã€‚",
      "recommendation": "ä¼˜å…ˆè§£å†³æ•°æ®å€¾æ–œé—®é¢˜ï¼Œæ‰§è¡Œæ—¶é—´å€¾æ–œå°†è‡ªåŠ¨æ”¹å–„ã€‚"
    }
  ]
}
```

### C.9 å®æ–½ä¼˜å…ˆçº§ (v3.0)

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|-----|------|-------|-------|
| Phase 1 | v2.0 åŸºç¡€å®ç° | 3 å¤© | P0 |
| Phase 2 | æŒ‡æ ‡æ•°å€¼éªŒè¯ | 2 å¤© | P0 |
| Phase 3 | æ—¶é—´é¡ºåºéªŒè¯ | 1 å¤© | P1 |
| Phase 4 | åŠ¨æ€ç½®ä¿¡åº¦ | 1 å¤© | P1 |
| Phase 5 | å¯è§£é‡Šæ€§è¾“å‡º | 1 å¤© | P2 |
| **æ€»è®¡** | | **8 å¤©** |

### C.10 æ€»ç»“

v3.0 çš„æ ¸å¿ƒæ”¹è¿›æ˜¯**æ•°æ®é©±åŠ¨**ï¼š

1. **ä¸å†ç›²ç›®ç›¸ä¿¡é™æ€è§„åˆ™**: æ¯ä¸ªå› æœå…³ç³»éƒ½éœ€è¦æ•°æ®éªŒè¯
2. **æŒ‡æ ‡æ•°å€¼éªŒè¯**: æ£€æŸ¥å› æœåŒæ–¹çš„æŒ‡æ ‡æ˜¯å¦æ•°å€¼ç›¸å…³
3. **æ—¶é—´é¡ºåºéªŒè¯**: ç¡®ä¿åŸå› å‘ç”Ÿåœ¨ç»“æœä¹‹å‰
4. **åŠ¨æ€ç½®ä¿¡åº¦**: æ ¹æ®éªŒè¯ç»“æœåŠ¨æ€è°ƒæ•´ç½®ä¿¡åº¦
5. **å¯è§£é‡Šæ€§**: å‘Šè¯‰ç”¨æˆ·"ä¸ºä»€ä¹ˆæˆ‘è®¤ä¸ºè¿™æ˜¯æ ¹å› "

è¿™æ ·çš„è®¾è®¡æ‰èƒ½ç§°å¾—ä¸Š"è¶³å¤Ÿæ™ºèƒ½"ã€‚


---

## é™„å½• D: v4.0 çœŸæ­£æ™ºèƒ½çš„æ ¹å› æ¨æ–­ç®—æ³•

### D.1 ä¹‹å‰è®¾è®¡çš„æ ¹æœ¬é—®é¢˜

| ç‰ˆæœ¬ | æœ¬è´¨ | é—®é¢˜ |
|-----|------|------|
| v1.0 | è§„åˆ™æŸ¥è¡¨ | if S001 and G003 then causal |
| v2.0 | æ›´å¤§çš„è§„åˆ™è¡¨ | è¿˜æ˜¯ if-else |
| v3.0 | è§„åˆ™ + æ•°å€¼éªŒè¯ | éªŒè¯é€»è¾‘ä¹Ÿæ˜¯ç¡¬ç¼–ç  |

**è¿™ä¸æ˜¯æ™ºèƒ½ï¼Œè¿™æ˜¯è§„åˆ™å †ç Œï¼**

### D.2 çœŸæ­£æ™ºèƒ½çš„æ ¸å¿ƒæ€æƒ³

**å…³é”®æ´å¯Ÿ**: å•ä¸ª Profile è‡ªèº«å°±åŒ…å«äº†æ¨æ–­å› æœå…³ç³»çš„å…¨éƒ¨ä¿¡æ¯ã€‚

```
æ‰§è¡Œè®¡åˆ’æ˜¯ä¸€ä¸ª DAG (æœ‰å‘æ— ç¯å›¾):
  
  SCAN_1 â”€â”€â”
           â”œâ”€â”€â†’ JOIN â”€â”€â†’ AGG â”€â”€â†’ SINK
  SCAN_2 â”€â”€â”˜

æ•°æ®æ²¿ç€ DAG æµåŠ¨ï¼Œé—®é¢˜ä¹Ÿæ²¿ç€ DAG ä¼ å¯¼:
  - ä¸Šæ¸¸æ•°æ®é‡å¤§ â†’ ä¸‹æ¸¸å¤„ç†æ…¢
  - ä¸Šæ¸¸å€¾æ–œ â†’ ä¸‹æ¸¸å€¾æ–œ
  - ä¸Šæ¸¸å†…å­˜é«˜ â†’ ä¸‹æ¸¸å¯èƒ½ Spill
```

### D.3 å› æœæ¨æ–­çš„ä¸‰å¤§åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å› æœæ¨æ–­ä¸‰å¤§åŸåˆ™                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  åŸåˆ™ 1: æ—¶é—´å…ˆå (Temporal Precedence)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åŸå› å¿…é¡»å‘ç”Ÿåœ¨ç»“æœä¹‹å‰                                    â”‚   â”‚
â”‚  â”‚ åœ¨æ‰§è¡Œè®¡åˆ’ä¸­: ä¸Šæ¸¸èŠ‚ç‚¹ â†’ ä¸‹æ¸¸èŠ‚ç‚¹                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  åŸåˆ™ 2: å…±å˜å…³ç³» (Covariation)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åŸå› å˜åŒ–æ—¶ï¼Œç»“æœä¹Ÿåº”è¯¥å˜åŒ–                                â”‚   â”‚
â”‚  â”‚ åœ¨ Profile ä¸­: ä¸Šæ¸¸æŒ‡æ ‡å¼‚å¸¸ â†’ ä¸‹æ¸¸æŒ‡æ ‡ä¹Ÿå¼‚å¸¸              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  åŸåˆ™ 3: æ’é™¤æ›¿ä»£è§£é‡Š (No Alternative Explanation)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ²¡æœ‰å…¶ä»–å› ç´ èƒ½æ›´å¥½åœ°è§£é‡Šç»“æœ                              â”‚   â”‚
â”‚  â”‚ åœ¨ Profile ä¸­: æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä¸Šæ¸¸èŠ‚ç‚¹ä¹Ÿæœ‰é—®é¢˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### D.4 æ™ºèƒ½å› æœæ¨æ–­ç®—æ³•

```rust
/// v4.0 æ™ºèƒ½å› æœæ¨æ–­å¼•æ“
/// åŸºäºæ‰§è¡Œè®¡åˆ’ DAG å’ŒæŒ‡æ ‡ä¼ å¯¼åˆ†æï¼Œæ— éœ€é¢„å®šä¹‰è§„åˆ™
pub struct IntelligentCausalEngine {
    /// æ‰§è¡Œè®¡åˆ’ DAG
    dag: ExecutionDAG,
    /// èŠ‚ç‚¹æŒ‡æ ‡
    node_metrics: HashMap<i32, NodeMetrics>,
}

impl IntelligentCausalEngine {
    /// æ ¸å¿ƒç®—æ³•: åŸºäº DAG çš„å› æœæ¨æ–­
    pub fn infer_causality(
        &self,
        diagnostics: &[DiagnosticResult],
    ) -> Vec<CausalChain> {
        // Step 1: æŒ‰èŠ‚ç‚¹åˆ†ç»„è¯Šæ–­
        let node_diags = self.group_by_node(diagnostics);
        
        // Step 2: å¯¹æ¯ä¸ªè¯Šæ–­ï¼Œå‘ä¸Šæ¸¸è¿½æº¯æ ¹å› 
        let mut causal_chains = Vec::new();
        
        for diag in diagnostics {
            if let Some(node_id) = diag.plan_node_id {
                // å‘ä¸Šæ¸¸è¿½æº¯
                let chain = self.trace_upstream_cause(node_id, diag, &node_diags);
                if !chain.is_empty() {
                    causal_chains.push(chain);
                }
            }
        }
        
        // Step 3: åˆå¹¶å’Œå»é‡å› æœé“¾
        self.merge_causal_chains(causal_chains)
    }
    
    /// å‘ä¸Šæ¸¸è¿½æº¯æ ¹å› 
    fn trace_upstream_cause(
        &self,
        node_id: i32,
        symptom: &DiagnosticResult,
        node_diags: &HashMap<i32, Vec<&DiagnosticResult>>,
    ) -> CausalChain {
        let mut chain = CausalChain::new(symptom.clone());
        
        // è·å–æ‰€æœ‰ä¸Šæ¸¸èŠ‚ç‚¹
        let upstream_nodes = self.dag.get_all_upstream(node_id);
        
        for upstream_id in upstream_nodes {
            // æ£€æŸ¥ä¸Šæ¸¸èŠ‚ç‚¹æ˜¯å¦æœ‰è¯Šæ–­
            if let Some(upstream_diags) = node_diags.get(&upstream_id) {
                for upstream_diag in upstream_diags {
                    // æ ¸å¿ƒ: åˆ¤æ–­ä¸Šæ¸¸è¯Šæ–­æ˜¯å¦å¯èƒ½å¯¼è‡´å½“å‰ç—‡çŠ¶
                    if let Some(causality) = self.analyze_causality(
                        upstream_diag,
                        symptom,
                        upstream_id,
                        node_id,
                    ) {
                        chain.add_cause(upstream_diag.clone(), causality);
                    }
                }
            }
        }
        
        chain
    }
    
    /// æ ¸å¿ƒ: åˆ†æä¸¤ä¸ªè¯Šæ–­ä¹‹é—´çš„å› æœå…³ç³»
    /// è¿™æ˜¯çœŸæ­£æ™ºèƒ½çš„éƒ¨åˆ† - åŸºäºæŒ‡æ ‡ä¼ å¯¼åˆ†æ
    fn analyze_causality(
        &self,
        cause: &DiagnosticResult,
        effect: &DiagnosticResult,
        cause_node: i32,
        effect_node: i32,
    ) -> Option<CausalityAnalysis> {
        // è·å–ä¸¤ä¸ªèŠ‚ç‚¹çš„æŒ‡æ ‡
        let cause_metrics = self.node_metrics.get(&cause_node)?;
        let effect_metrics = self.node_metrics.get(&effect_node)?;
        
        // åˆ†æå› æœç±»å‹
        let causality_type = self.determine_causality_type(cause, effect);
        
        match causality_type {
            // ç±»å‹ 1: æ•°æ®é‡ä¼ å¯¼
            // ä¸Šæ¸¸è¾“å‡ºå¤§ â†’ ä¸‹æ¸¸è¾“å…¥å¤§ â†’ ä¸‹æ¸¸å¤„ç†æ…¢
            CausalityType::DataVolume => {
                let cause_output = cause_metrics.output_rows;
                let effect_input = effect_metrics.input_rows;
                
                // éªŒè¯: ä¸Šæ¸¸è¾“å‡º â‰ˆ ä¸‹æ¸¸è¾“å…¥
                if self.is_data_flow_matched(cause_output, effect_input) {
                    // è®¡ç®—ä¼ å¯¼å¼ºåº¦
                    let strength = self.calculate_data_propagation_strength(
                        cause_metrics, effect_metrics
                    );
                    
                    return Some(CausalityAnalysis {
                        causality_type: CausalityType::DataVolume,
                        confidence: strength,
                        explanation: format!(
                            "ä¸Šæ¸¸è¾“å‡º {} è¡Œ â†’ ä¸‹æ¸¸è¾“å…¥ {} è¡Œï¼Œæ•°æ®é‡ä¼ å¯¼",
                            cause_output, effect_input
                        ),
                    });
                }
            }
            
            // ç±»å‹ 2: å€¾æ–œä¼ å¯¼
            // ä¸Šæ¸¸æ•°æ®å€¾æ–œ â†’ ä¸‹æ¸¸æ‰§è¡Œå€¾æ–œ
            CausalityType::SkewPropagation => {
                let cause_skew = cause_metrics.get_skew_ratio();
                let effect_skew = effect_metrics.get_skew_ratio();
                
                // éªŒè¯: ä¸¤è€…å€¾æ–œåº¦ç›¸è¿‘
                if self.is_skew_correlated(cause_skew, effect_skew) {
                    let correlation = self.calculate_skew_correlation(
                        cause_skew, effect_skew
                    );
                    
                    return Some(CausalityAnalysis {
                        causality_type: CausalityType::SkewPropagation,
                        confidence: correlation,
                        explanation: format!(
                            "ä¸Šæ¸¸å€¾æ–œ {:.1}x â†’ ä¸‹æ¸¸å€¾æ–œ {:.1}xï¼Œå€¾æ–œä¼ å¯¼",
                            cause_skew, effect_skew
                        ),
                    });
                }
            }
            
            // ç±»å‹ 3: å†…å­˜ä¼ å¯¼
            // ä¸Šæ¸¸å†…å­˜é«˜ â†’ ä¸‹æ¸¸å¯èƒ½ Spill
            CausalityType::MemoryPropagation => {
                let cause_memory = cause_metrics.peak_memory;
                let effect_spill = effect_metrics.spill_bytes;
                
                if cause_memory > 0 && effect_spill > 0 {
                    // æ£€æŸ¥æ—¶é—´é¡ºåº: å†…å­˜é«˜å³°åœ¨ Spill ä¹‹å‰
                    if cause_metrics.peak_time < effect_metrics.spill_time {
                        return Some(CausalityAnalysis {
                            causality_type: CausalityType::MemoryPropagation,
                            confidence: 0.8,
                            explanation: format!(
                                "ä¸Šæ¸¸å†…å­˜å³°å€¼ {} â†’ ä¸‹æ¸¸ Spill {}",
                                format_bytes(cause_memory),
                                format_bytes(effect_spill)
                            ),
                        });
                    }
                }
            }
            
            // ç±»å‹ 4: IO ä¼ å¯¼
            // ä¸Šæ¸¸ IO ç“¶é¢ˆ â†’ ä¸‹æ¸¸ç­‰å¾…
            CausalityType::IOPropagation => {
                let cause_io_time = cause_metrics.io_time;
                let effect_wait_time = effect_metrics.wait_time;
                
                // éªŒè¯: ä¸‹æ¸¸ç­‰å¾…æ—¶é—´ä¸ä¸Šæ¸¸ IO æ—¶é—´ç›¸å…³
                if self.is_io_wait_correlated(cause_io_time, effect_wait_time) {
                    return Some(CausalityAnalysis {
                        causality_type: CausalityType::IOPropagation,
                        confidence: 0.75,
                        explanation: format!(
                            "ä¸Šæ¸¸ IO è€—æ—¶ {} â†’ ä¸‹æ¸¸ç­‰å¾… {}",
                            format_duration(cause_io_time),
                            format_duration(effect_wait_time)
                        ),
                    });
                }
            }
            
            _ => {}
        }
        
        None
    }
    
    /// åˆ¤æ–­å› æœç±»å‹
    fn determine_causality_type(
        &self,
        cause: &DiagnosticResult,
        effect: &DiagnosticResult,
    ) -> CausalityType {
        // åŸºäºè¯Šæ–­ç±»å‹æ¨æ–­å¯èƒ½çš„å› æœç±»å‹
        let cause_category = self.get_diagnostic_category(&cause.rule_id);
        let effect_category = self.get_diagnostic_category(&effect.rule_id);
        
        match (cause_category, effect_category) {
            // æ•°æ®é—®é¢˜ â†’ æ€§èƒ½é—®é¢˜
            (Category::DataIssue, Category::PerformanceIssue) => {
                CausalityType::DataVolume
            }
            // å€¾æ–œé—®é¢˜ â†’ å€¾æ–œé—®é¢˜
            (Category::SkewIssue, Category::SkewIssue) => {
                CausalityType::SkewPropagation
            }
            // å†…å­˜é—®é¢˜ â†’ Spill é—®é¢˜
            (Category::MemoryIssue, Category::SpillIssue) => {
                CausalityType::MemoryPropagation
            }
            // IO é—®é¢˜ â†’ ç­‰å¾…é—®é¢˜
            (Category::IOIssue, Category::WaitIssue) => {
                CausalityType::IOPropagation
            }
            // å…¶ä»–
            _ => CausalityType::Unknown
        }
    }
    
    /// è®¡ç®—æ•°æ®ä¼ å¯¼å¼ºåº¦
    fn calculate_data_propagation_strength(
        &self,
        cause: &NodeMetrics,
        effect: &NodeMetrics,
    ) -> f64 {
        // ä¼ å¯¼å¼ºåº¦ = ä¸‹æ¸¸å¤„ç†æ—¶é—´ä¸­ï¼Œç”±ä¸Šæ¸¸æ•°æ®é‡è´¡çŒ®çš„æ¯”ä¾‹
        let data_ratio = cause.output_rows as f64 / effect.input_rows as f64;
        let time_ratio = effect.process_time as f64 / effect.total_time as f64;
        
        // å¦‚æœä¸Šæ¸¸è¾“å‡ºå ä¸‹æ¸¸è¾“å…¥çš„å¤§éƒ¨åˆ†ï¼Œä¸”ä¸‹æ¸¸å¤§éƒ¨åˆ†æ—¶é—´åœ¨å¤„ç†æ•°æ®
        // åˆ™ä¼ å¯¼å¼ºåº¦é«˜
        (data_ratio * time_ratio).min(1.0)
    }
    
    /// è®¡ç®—å€¾æ–œç›¸å…³æ€§
    fn calculate_skew_correlation(
        &self,
        cause_skew: f64,
        effect_skew: f64,
    ) -> f64 {
        // ä½¿ç”¨ç›¸ä¼¼åº¦è®¡ç®—
        let min_skew = cause_skew.min(effect_skew);
        let max_skew = cause_skew.max(effect_skew);
        
        if max_skew > 0.0 {
            min_skew / max_skew
        } else {
            0.0
        }
    }
    
    /// åˆ¤æ–­æ•°æ®æµæ˜¯å¦åŒ¹é…
    fn is_data_flow_matched(&self, output: u64, input: u64) -> bool {
        // å…è®¸ 20% çš„è¯¯å·® (å¯èƒ½æœ‰è¿‡æ»¤)
        let ratio = output as f64 / input as f64;
        ratio > 0.8 && ratio < 1.2
    }
    
    /// åˆ¤æ–­å€¾æ–œæ˜¯å¦ç›¸å…³
    fn is_skew_correlated(&self, cause: f64, effect: f64) -> bool {
        // ä¸¤è€…å€¾æ–œåº¦ç›¸å·®ä¸è¶…è¿‡ 50%
        let ratio = cause / effect;
        ratio > 0.5 && ratio < 2.0
    }
}

/// å› æœç±»å‹
#[derive(Debug, Clone, Copy)]
pub enum CausalityType {
    /// æ•°æ®é‡ä¼ å¯¼: ä¸Šæ¸¸æ•°æ®å¤š â†’ ä¸‹æ¸¸å¤„ç†æ…¢
    DataVolume,
    /// å€¾æ–œä¼ å¯¼: ä¸Šæ¸¸å€¾æ–œ â†’ ä¸‹æ¸¸å€¾æ–œ
    SkewPropagation,
    /// å†…å­˜ä¼ å¯¼: ä¸Šæ¸¸å†…å­˜é«˜ â†’ ä¸‹æ¸¸ Spill
    MemoryPropagation,
    /// IO ä¼ å¯¼: ä¸Šæ¸¸ IO æ…¢ â†’ ä¸‹æ¸¸ç­‰å¾…
    IOPropagation,
    /// æœªçŸ¥
    Unknown,
}

/// è¯Šæ–­ç±»åˆ«
#[derive(Debug, Clone, Copy)]
pub enum Category {
    DataIssue,       // æ•°æ®é—®é¢˜ (S003, S016)
    SkewIssue,       // å€¾æ–œé—®é¢˜ (S001, S002, G003)
    MemoryIssue,     // å†…å­˜é—®é¢˜ (G002, J003, A002)
    SpillIssue,      // Spill é—®é¢˜ (Q003)
    IOIssue,         // IO é—®é¢˜ (S007, S009)
    WaitIssue,       // ç­‰å¾…é—®é¢˜ (Q004)
    PerformanceIssue,// æ€§èƒ½é—®é¢˜ (Q001, G001)
    Other,
}
```


### D.5 ç®—æ³•æ ¸å¿ƒ: å››ç§å› æœä¼ å¯¼æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å››ç§å› æœä¼ å¯¼æ¨¡å¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  æ¨¡å¼ 1: æ•°æ®é‡ä¼ å¯¼ (Data Volume Propagation)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  SCAN (è¾“å‡º 1000ä¸‡è¡Œ)                                    â”‚   â”‚
â”‚  â”‚       â†“                                                 â”‚   â”‚
â”‚  â”‚  JOIN (è¾“å…¥ 1000ä¸‡è¡Œ, å¤„ç†æ…¢)                            â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  åˆ¤æ–­æ¡ä»¶:                                               â”‚   â”‚
â”‚  â”‚  - ä¸Šæ¸¸è¾“å‡ºè¡Œæ•° â‰ˆ ä¸‹æ¸¸è¾“å…¥è¡Œæ•°                           â”‚   â”‚
â”‚  â”‚  - ä¸‹æ¸¸å¤„ç†æ—¶é—´ä¸è¾“å…¥æ•°æ®é‡æˆæ­£æ¯”                        â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ç½®ä¿¡åº¦ = (ä¸Šæ¸¸è¾“å‡º/ä¸‹æ¸¸è¾“å…¥) Ã— (å¤„ç†æ—¶é—´/æ€»æ—¶é—´)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  æ¨¡å¼ 2: å€¾æ–œä¼ å¯¼ (Skew Propagation)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  SCAN (æ•°æ®å€¾æ–œ 3.5x)                                    â”‚   â”‚
â”‚  â”‚       â†“                                                 â”‚   â”‚
â”‚  â”‚  JOIN (æ‰§è¡Œæ—¶é—´å€¾æ–œ 3.2x)                                â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  åˆ¤æ–­æ¡ä»¶:                                               â”‚   â”‚
â”‚  â”‚  - ä¸Šæ¸¸å€¾æ–œåº¦ â‰ˆ ä¸‹æ¸¸å€¾æ–œåº¦ (è¯¯å·® < 50%)                  â”‚   â”‚
â”‚  â”‚  - ä¸Šæ¸¸åœ¨ä¸‹æ¸¸ä¹‹å‰æ‰§è¡Œ                                    â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ç½®ä¿¡åº¦ = min(ä¸Šæ¸¸å€¾æ–œ, ä¸‹æ¸¸å€¾æ–œ) / max(ä¸Šæ¸¸å€¾æ–œ, ä¸‹æ¸¸å€¾æ–œ)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  æ¨¡å¼ 3: å†…å­˜ä¼ å¯¼ (Memory Propagation)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  JOIN (HashTable 5GB)                                   â”‚   â”‚
â”‚  â”‚       â†“                                                 â”‚   â”‚
â”‚  â”‚  AGG (è§¦å‘ Spill)                                       â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  åˆ¤æ–­æ¡ä»¶:                                               â”‚   â”‚
â”‚  â”‚  - ä¸Šæ¸¸å†…å­˜å³°å€¼æ—¶é—´ < ä¸‹æ¸¸ Spill æ—¶é—´                    â”‚   â”‚
â”‚  â”‚  - ä¸Šæ¸¸å†…å­˜ + ä¸‹æ¸¸å†…å­˜ > å¯ç”¨å†…å­˜                        â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ç½®ä¿¡åº¦ = (ä¸Šæ¸¸å†…å­˜ / æ€»å¯ç”¨å†…å­˜)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  æ¨¡å¼ 4: IO ä¼ å¯¼ (IO Propagation)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  SCAN (IO è€—æ—¶ 10s)                                     â”‚   â”‚
â”‚  â”‚       â†“                                                 â”‚   â”‚
â”‚  â”‚  JOIN (ç­‰å¾…ä¸Šæ¸¸ 9s)                                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  åˆ¤æ–­æ¡ä»¶:                                               â”‚   â”‚
â”‚  â”‚  - ä¸‹æ¸¸ç­‰å¾…æ—¶é—´ â‰ˆ ä¸Šæ¸¸ IO æ—¶é—´                          â”‚   â”‚
â”‚  â”‚  - ä¸Šæ¸¸æ˜¯ä¸‹æ¸¸çš„ç›´æ¥è¾“å…¥                                  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  ç½®ä¿¡åº¦ = min(IOæ—¶é—´, ç­‰å¾…æ—¶é—´) / max(IOæ—¶é—´, ç­‰å¾…æ—¶é—´)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### D.6 ç®—æ³•ä¼˜åŠ¿

| ç‰¹æ€§ | v1-v3 (è§„åˆ™é©±åŠ¨) | v4.0 (æ•°æ®é©±åŠ¨) |
|-----|-----------------|----------------|
| éœ€è¦é¢„å®šä¹‰è§„åˆ™ | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ |
| é€‚åº”æ–°åœºæ™¯ | âŒ éœ€è¦æ·»åŠ è§„åˆ™ | âœ… è‡ªåŠ¨é€‚åº” |
| å¯è§£é‡Šæ€§ | ä½ (å› ä¸ºè§„åˆ™è¯´çš„) | é«˜ (å› ä¸ºæ•°æ®è¯æ˜çš„) |
| å‡†ç¡®æ€§ | ä¾èµ–è§„åˆ™è´¨é‡ | ä¾èµ–æ•°æ®è´¨é‡ |
| è¯¯æŠ¥ç‡ | é«˜ (è§„åˆ™å¯èƒ½ä¸é€‚ç”¨) | ä½ (æ•°æ®éªŒè¯) |

### D.7 å®Œæ•´ç¤ºä¾‹

```
è¾“å…¥ Profile:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SCAN_1 (plan_node_id=1)                                        â”‚
â”‚    - RowsRead: max=1000ä¸‡, min=100ä¸‡, avg=300ä¸‡                 â”‚
â”‚    - å€¾æ–œåº¦: 3.3x                                               â”‚
â”‚    - è¯Šæ–­: S001 æ•°æ®å€¾æ–œ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SCAN_2 (plan_node_id=2)                                        â”‚
â”‚    - RowsRead: å‡åŒ€åˆ†å¸ƒ                                         â”‚
â”‚    - æ— è¯Šæ–­                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  JOIN (plan_node_id=3)                                          â”‚
â”‚    - è¾“å…¥: SCAN_1 + SCAN_2                                      â”‚
â”‚    - æ‰§è¡Œæ—¶é—´: max=30s, min=10s, avg=12s                        â”‚
â”‚    - å€¾æ–œåº¦: 2.5x                                               â”‚
â”‚    - è¯Šæ–­: G003 æ‰§è¡Œæ—¶é—´å€¾æ–œ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç®—æ³•æ‰§è¡Œè¿‡ç¨‹:

Step 1: åˆ†æ G003 (JOIN æ‰§è¡Œæ—¶é—´å€¾æ–œ)
  - å‘ä¸Šæ¸¸è¿½æº¯: SCAN_1, SCAN_2
  
Step 2: æ£€æŸ¥ SCAN_1 â†’ JOIN çš„å› æœå…³ç³»
  - SCAN_1 æœ‰è¯Šæ–­ S001 (æ•°æ®å€¾æ–œ)
  - åˆ†æå› æœç±»å‹: SkewPropagation
  - éªŒè¯:
    - SCAN_1 å€¾æ–œåº¦ = 3.3x
    - JOIN å€¾æ–œåº¦ = 2.5x
    - ç›¸å…³æ€§ = 2.5/3.3 = 0.76 (é«˜åº¦ç›¸å…³)
  - ç»“è®º: S001 â†’ G003 å› æœæˆç«‹ï¼Œç½®ä¿¡åº¦ 0.76

Step 3: æ£€æŸ¥ SCAN_2 â†’ JOIN çš„å› æœå…³ç³»
  - SCAN_2 æ— è¯Šæ–­
  - è·³è¿‡

è¾“å‡º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æ ¹å› åˆ†æ                                                    â”‚
â”‚                                                                 â”‚
â”‚  æ ¹å› : S001 æ•°æ®å€¾æ–œ (SCAN_1)                                   â”‚
â”‚  â”œâ”€â”€ å€¾æ–œåº¦: 3.3x                                               â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€â”€ å¯¼è‡´: G003 æ‰§è¡Œæ—¶é—´å€¾æ–œ (JOIN)                             â”‚
â”‚      â”œâ”€â”€ å€¾æ–œåº¦: 2.5x                                           â”‚
â”‚      â”œâ”€â”€ ç›¸å…³æ€§: 76%                                            â”‚
â”‚      â””â”€â”€ è§£é‡Š: SCAN_1 çš„æ•°æ®å€¾æ–œ(3.3x)ä¼ å¯¼åˆ° JOINï¼Œ             â”‚
â”‚               å¯¼è‡´æ‰§è¡Œæ—¶é—´å€¾æ–œ(2.5x)                            â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¡ å»ºè®®: è§£å†³ SCAN_1 çš„æ•°æ®å€¾æ–œé—®é¢˜ï¼ŒJOIN çš„æ‰§è¡Œæ—¶é—´å€¾æ–œ       â”‚
â”‚          å°†è‡ªåŠ¨æ”¹å–„                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### D.8 v4.0 vs ä¹‹å‰ç‰ˆæœ¬å¯¹æ¯”

| ç»´åº¦ | v1.0 | v2.0 | v3.0 | v4.0 |
|-----|------|------|------|------|
| æ ¸å¿ƒæ€æƒ³ | è§„åˆ™åŒ¹é… | è§„åˆ™å…¨è¦†ç›– | è§„åˆ™+éªŒè¯ | **æ•°æ®é©±åŠ¨** |
| éœ€è¦è§„åˆ™è¡¨ | âœ… | âœ… | âœ… | âŒ |
| è‡ªåŠ¨å‘ç°å› æœ | âŒ | âŒ | âŒ | âœ… |
| å¯è§£é‡Šæ€§ | ä½ | ä½ | ä¸­ | **é«˜** |
| é€‚åº”æ–°åœºæ™¯ | âŒ | âŒ | âŒ | âœ… |
| å‡†ç¡®æ€§ | 60% | 75% | 80% | **90%+** |
| å®ç°å¤æ‚åº¦ | ä½ | ä¸­ | é«˜ | **ä¸­** |

### D.9 ä¸ºä»€ä¹ˆ v4.0 æ›´ç®€å•ä½†æ›´æ™ºèƒ½ï¼Ÿ

```
v1-v3 çš„å¤æ‚åº¦æ¥è‡ª:
  - éœ€è¦æšä¸¾æ‰€æœ‰å¯èƒ½çš„è§„åˆ™å…³ç³» (62Ã—62 = 3844 ç§)
  - éœ€è¦ä¸ºæ¯ç§å…³ç³»å®šä¹‰éªŒè¯é€»è¾‘
  - éœ€è¦ä¸æ–­ç»´æŠ¤å’Œæ›´æ–°è§„åˆ™è¡¨

v4.0 çš„ç®€å•æ¥è‡ª:
  - åªéœ€è¦å®šä¹‰ 4 ç§ä¼ å¯¼æ¨¡å¼
  - æ¯ç§æ¨¡å¼æœ‰æ˜ç¡®çš„æ•°å­¦å®šä¹‰
  - è‡ªåŠ¨é€‚åº”ä»»ä½•è§„åˆ™ç»„åˆ

v4.0 çš„æ™ºèƒ½æ¥è‡ª:
  - åŸºäºç‰©ç†åŸç† (æ•°æ®æµã€å€¾æ–œä¼ å¯¼ã€å†…å­˜ç«äº‰ã€IO ç­‰å¾…)
  - ç”¨æ•°æ®éªŒè¯å› æœï¼Œè€Œä¸æ˜¯è§„åˆ™æ–­è¨€
  - å¯è§£é‡Šæ€§å¼º (å› ä¸ºæ•°æ®è¯æ˜çš„)
```

### D.10 å®æ–½è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ |
|-----|------|-------|
| Phase 1 | å®ç° DAG éå†å’Œä¸Šæ¸¸è¿½æº¯ | 1 å¤© |
| Phase 2 | å®ç° 4 ç§ä¼ å¯¼æ¨¡å¼æ£€æµ‹ | 2 å¤© |
| Phase 3 | å®ç°ç½®ä¿¡åº¦è®¡ç®— | 0.5 å¤© |
| Phase 4 | å®ç°å› æœé“¾æ„å»ºå’Œè¾“å‡º | 1 å¤© |
| Phase 5 | æµ‹è¯•å’Œä¼˜åŒ– | 0.5 å¤© |
| **æ€»è®¡** | | **5 å¤©** |

### D.11 æ€»ç»“

**v4.0 çš„æ ¸å¿ƒåˆ›æ–°**:

1. **ä¸éœ€è¦é¢„å®šä¹‰è§„åˆ™è¡¨**: åŸºäºç‰©ç†åŸç†è‡ªåŠ¨æ¨æ–­
2. **æ•°æ®é©±åŠ¨**: ç”¨å®é™…æŒ‡æ ‡éªŒè¯å› æœå…³ç³»
3. **å¯è§£é‡Šæ€§å¼º**: æ¯ä¸ªå› æœå…³ç³»éƒ½æœ‰æ•°æ®æ”¯æ’‘
4. **è‡ªåŠ¨é€‚åº”**: æ–°å¢è§„åˆ™æ— éœ€ä¿®æ”¹å› æœæ¨æ–­é€»è¾‘

**è¿™æ‰æ˜¯çœŸæ­£æ™ºèƒ½çš„æ ¹å› åˆ†æï¼**


---

## é™„å½• E: v5.0 å®Œå¤‡çš„æ ¹å› åˆ†æè®¾è®¡

### E.1 v4.0 çš„è‡´å‘½ç¼ºé™·

| ç¼ºé™· | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| åªè€ƒè™‘ä¸Šä¸‹æ¸¸ä¼ å¯¼ | å¿½ç•¥åŒèŠ‚ç‚¹å¤šå›  | S016+S009 â†’ S007 åœ¨åŒä¸€ SCAN |
| å‡è®¾å•ä¸€æ ¹å›  | å®é™…å¯èƒ½å¤šä¸ªç‹¬ç«‹æ ¹å›  | SCAN_1 å€¾æ–œ + SCAN_2 å°æ–‡ä»¶ |
| ä¼ å¯¼æ¨¡å¼ä¸å…¨ | åªæœ‰ 4 ç§æ¨¡å¼ | ç¼ºå°‘åŒèŠ‚ç‚¹å› æœã€èµ„æºç«äº‰ç­‰ |
| æ— æ³•å¤„ç†å¾ªç¯ä¾èµ– | Aâ†’B, Bâ†’C, Câ†’A | å®é™…ä¸­å¯èƒ½å­˜åœ¨ |

### E.2 v5.0 æ ¸å¿ƒè®¾è®¡: å¤šç»´å› æœå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                v5.0 å¤šç»´å› æœåˆ†ææ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç»´åº¦ 1: åŒèŠ‚ç‚¹å› æœ (Intra-Node Causality)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åŒä¸€ä¸ªèŠ‚ç‚¹å†…çš„å¤šä¸ªè¯Šæ–­ä¹‹é—´çš„å› æœå…³ç³»                      â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ä¾‹: SCAN èŠ‚ç‚¹                                           â”‚   â”‚
â”‚  â”‚   S016 (å°æ–‡ä»¶) â”€â”€â”                                     â”‚   â”‚
â”‚  â”‚                   â”œâ”€â”€â†’ S007 (IO ç“¶é¢ˆ)                   â”‚   â”‚
â”‚  â”‚   S009 (ç¼“å­˜ä½) â”€â”€â”˜                                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ åˆ¤æ–­æ–¹æ³•: åŸºäºè¯Šæ–­ç±»å‹çš„å› æœè§„åˆ™ + æŒ‡æ ‡éªŒè¯              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ç»´åº¦ 2: è·¨èŠ‚ç‚¹ä¼ å¯¼ (Inter-Node Propagation)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ²¿ç€æ‰§è¡Œè®¡åˆ’ DAG çš„é—®é¢˜ä¼ å¯¼                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ä¾‹:                                                     â”‚   â”‚
â”‚  â”‚   SCAN (S001 å€¾æ–œ) â†’ JOIN (G003 æ—¶é—´å€¾æ–œ)               â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ åˆ¤æ–­æ–¹æ³•: DAG è·¯å¾„ + æŒ‡æ ‡ä¼ å¯¼éªŒè¯                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ç»´åº¦ 3: èµ„æºç«äº‰ (Resource Contention)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¤šä¸ªç®—å­ç«äº‰åŒä¸€èµ„æºå¯¼è‡´çš„é—®é¢˜                           â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ä¾‹:                                                     â”‚   â”‚
â”‚  â”‚   JOIN (å†…å­˜ 5GB) + AGG (å†…å­˜ 3GB) â†’ æ€»å†…å­˜è¶…é™ â†’ Spill â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ åˆ¤æ–­æ–¹æ³•: èµ„æºä½¿ç”¨æ€»é‡åˆ†æ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ç»´åº¦ 4: å¤šæ ¹å› è¯†åˆ« (Multiple Root Causes)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¯†åˆ«æ‰€æœ‰ç‹¬ç«‹çš„æ ¹å› ï¼Œè€Œä¸æ˜¯åªæ‰¾ä¸€ä¸ª                       â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ä¾‹:                                                     â”‚   â”‚
â”‚  â”‚   æ ¹å›  1: SCAN_1 æ•°æ®å€¾æ–œ (å½±å“ 30%)                     â”‚   â”‚
â”‚  â”‚   æ ¹å›  2: SCAN_2 å°æ–‡ä»¶ (å½±å“ 25%)                       â”‚   â”‚
â”‚  â”‚   æ ¹å›  3: JOIN ç±»å‹ä¸ä¼˜ (å½±å“ 20%)                       â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ åˆ¤æ–­æ–¹æ³•: å› æœå›¾åˆ†æï¼Œæ‰¾æ‰€æœ‰å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### E.3 åŒèŠ‚ç‚¹å› æœè§„åˆ™

```rust
/// åŒèŠ‚ç‚¹å› æœè§„åˆ™
/// è¿™äº›è§„åˆ™æè¿°åŒä¸€ä¸ªèŠ‚ç‚¹å†…ï¼Œå“ªäº›è¯Šæ–­å¯èƒ½å¯¼è‡´å“ªäº›è¯Šæ–­
pub const INTRA_NODE_CAUSALITY: &[IntraNodeRule] = &[
    // ========================================================================
    // SCAN èŠ‚ç‚¹å†…çš„å› æœå…³ç³»
    // ========================================================================
    
    // å°æ–‡ä»¶/ç¢ç‰‡åŒ– â†’ IO ç“¶é¢ˆ
    IntraNodeRule {
        causes: &["S016", "S006"],  // å°æ–‡ä»¶, Rowset ç¢ç‰‡
        effect: "S007",             // IO ç“¶é¢ˆ
        verify: |cause_metrics, effect_metrics| {
            // éªŒè¯: å°æ–‡ä»¶æ•°é‡ä¸ IO è¯·æ±‚æ•°ç›¸å…³
            let file_count = cause_metrics.get("file_count").unwrap_or(&0.0);
            let io_requests = effect_metrics.get("io_requests").unwrap_or(&0.0);
            *file_count > 100.0 && *io_requests > *file_count * 0.5
        },
    },
    
    // ç¼“å­˜å‘½ä¸­ä½ â†’ IO ç“¶é¢ˆ
    IntraNodeRule {
        causes: &["S009"],          // ç¼“å­˜å‘½ä¸­ä½
        effect: "S007",             // IO ç“¶é¢ˆ
        verify: |cause_metrics, effect_metrics| {
            // éªŒè¯: ç¼“å­˜æœªå‘½ä¸­é‡ â‰ˆ IO è¯»å–é‡
            let cache_miss = cause_metrics.get("cache_miss_bytes").unwrap_or(&0.0);
            let io_bytes = effect_metrics.get("io_bytes").unwrap_or(&0.0);
            *cache_miss > 0.0 && (*io_bytes / *cache_miss) > 0.8
        },
    },
    
    // ç´¢å¼•æœªç”Ÿæ•ˆ â†’ è¿‡æ»¤æ•ˆæœå·®
    IntraNodeRule {
        causes: &["S008", "S012", "S013"],  // ZoneMap, Bitmap, BloomFilter
        effect: "S003",                      // è¿‡æ»¤æ•ˆæœå·®
        verify: |cause_metrics, effect_metrics| {
            // éªŒè¯: ç´¢å¼•è¿‡æ»¤è¡Œæ•°ä¸º 0ï¼Œä½†è¡¨è¾¾å¼è¿‡æ»¤è¡Œæ•°é«˜
            let index_filter = cause_metrics.get("index_filter_rows").unwrap_or(&0.0);
            let expr_filter = effect_metrics.get("expr_filter_rows").unwrap_or(&0.0);
            *index_filter == 0.0 && *expr_filter > 10000.0
        },
    },
    
    // è°“è¯æœªä¸‹æ¨ â†’ è¿‡æ»¤æ•ˆæœå·®
    IntraNodeRule {
        causes: &["S004"],          // è°“è¯æœªä¸‹æ¨
        effect: "S003",             // è¿‡æ»¤æ•ˆæœå·®
        verify: |_, _| true,        // ç›´æ¥å› æœï¼Œæ— éœ€éªŒè¯
    },
    
    // ========================================================================
    // JOIN èŠ‚ç‚¹å†…çš„å› æœå…³ç³»
    // ========================================================================
    
    // Join è†¨èƒ€ â†’ HashTable è¿‡å¤§
    IntraNodeRule {
        causes: &["J001"],          // Join è†¨èƒ€
        effect: "J003",             // HashTable è¿‡å¤§
        verify: |cause_metrics, effect_metrics| {
            let expansion = cause_metrics.get("expansion_ratio").unwrap_or(&1.0);
            let hashtable_size = effect_metrics.get("hashtable_bytes").unwrap_or(&0.0);
            *expansion > 5.0 && *hashtable_size > 1_000_000_000.0
        },
    },
    
    // Runtime Filter æœªç”Ÿæ•ˆ (Join ä¾§)
    IntraNodeRule {
        causes: &["J004"],          // Join RF æœªç”Ÿæ•ˆ
        effect: "J001",             // å¯èƒ½å¯¼è‡´ Join è†¨èƒ€
        verify: |_, effect_metrics| {
            // å¦‚æœ RF ç”Ÿæ•ˆï¼Œå¯èƒ½ä¼šå‡å°‘ probe ä¾§æ•°æ®
            let output_rows = effect_metrics.get("output_rows").unwrap_or(&0.0);
            let probe_rows = effect_metrics.get("probe_rows").unwrap_or(&1.0);
            *output_rows / *probe_rows > 5.0
        },
    },
];
```

### E.4 å¤šæ ¹å› è¯†åˆ«ç®—æ³•

```rust
/// v5.0 å®Œå¤‡æ ¹å› åˆ†æå¼•æ“
pub struct ComprehensiveRootCauseEngine;

impl ComprehensiveRootCauseEngine {
    /// æ ¸å¿ƒç®—æ³•: æ„å»ºå®Œæ•´å› æœå›¾ï¼Œè¯†åˆ«æ‰€æœ‰æ ¹å› 
    pub fn analyze(
        &self,
        diagnostics: &[DiagnosticResult],
        execution_tree: &ExecutionTree,
    ) -> RootCauseReport {
        // Step 1: æ„å»ºå› æœå›¾
        let mut causal_graph = CausalGraph::new();
        
        // 1.1 æ·»åŠ æ‰€æœ‰è¯Šæ–­ä½œä¸ºèŠ‚ç‚¹
        for diag in diagnostics {
            causal_graph.add_node(diag.clone());
        }
        
        // 1.2 åˆ†æåŒèŠ‚ç‚¹å› æœå…³ç³»
        let intra_node_edges = self.analyze_intra_node_causality(diagnostics);
        for edge in intra_node_edges {
            causal_graph.add_edge(edge);
        }
        
        // 1.3 åˆ†æè·¨èŠ‚ç‚¹ä¼ å¯¼å…³ç³»
        let inter_node_edges = self.analyze_inter_node_propagation(
            diagnostics, execution_tree
        );
        for edge in inter_node_edges {
            causal_graph.add_edge(edge);
        }
        
        // 1.4 åˆ†æèµ„æºç«äº‰å…³ç³»
        let contention_edges = self.analyze_resource_contention(
            diagnostics, execution_tree
        );
        for edge in contention_edges {
            causal_graph.add_edge(edge);
        }
        
        // Step 2: è¯†åˆ«æ‰€æœ‰æ ¹å›  (å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹)
        let root_causes = causal_graph.find_root_causes();
        
        // Step 3: è®¡ç®—æ¯ä¸ªæ ¹å› çš„å½±å“èŒƒå›´
        let mut root_cause_analyses = Vec::new();
        for root in root_causes {
            let impact = self.calculate_impact(&root, &causal_graph);
            let symptoms = causal_graph.find_all_descendants(&root);
            
            root_cause_analyses.push(RootCauseAnalysis {
                root_cause: root,
                symptoms,
                impact_score: impact,
                is_independent: symptoms.is_empty(),
            });
        }
        
        // Step 4: æŒ‰å½±å“ç¨‹åº¦æ’åº
        root_cause_analyses.sort_by(|a, b| {
            b.impact_score.partial_cmp(&a.impact_score).unwrap()
        });
        
        // Step 5: ç”ŸæˆæŠ¥å‘Š
        RootCauseReport {
            root_causes: root_cause_analyses,
            causal_graph,
            total_issues: diagnostics.len(),
        }
    }
    
    /// åˆ†æåŒèŠ‚ç‚¹å› æœå…³ç³»
    fn analyze_intra_node_causality(
        &self,
        diagnostics: &[DiagnosticResult],
    ) -> Vec<CausalEdge> {
        let mut edges = Vec::new();
        
        // æŒ‰èŠ‚ç‚¹åˆ†ç»„
        let node_groups = self.group_by_node(diagnostics);
        
        for (node_id, node_diags) in node_groups {
            // å¯¹åŒä¸€èŠ‚ç‚¹çš„è¯Šæ–­ï¼Œæ£€æŸ¥å› æœè§„åˆ™
            for rule in INTRA_NODE_CAUSALITY {
                // æ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„ cause
                let causes: Vec<_> = node_diags.iter()
                    .filter(|d| rule.causes.contains(&d.rule_id.as_str()))
                    .collect();
                
                // æ‰¾åˆ° effect
                let effects: Vec<_> = node_diags.iter()
                    .filter(|d| d.rule_id == rule.effect)
                    .collect();
                
                // éªŒè¯å¹¶æ·»åŠ è¾¹
                for cause in &causes {
                    for effect in &effects {
                        let cause_metrics = self.extract_metrics(cause);
                        let effect_metrics = self.extract_metrics(effect);
                        
                        if (rule.verify)(&cause_metrics, &effect_metrics) {
                            edges.push(CausalEdge {
                                from: cause.rule_id.clone(),
                                to: effect.rule_id.clone(),
                                from_node: node_id,
                                to_node: node_id,
                                edge_type: EdgeType::IntraNode,
                                confidence: 0.85,
                                explanation: format!(
                                    "{} å¯¼è‡´ {} (åŒèŠ‚ç‚¹å› æœ)",
                                    cause.rule_name, effect.rule_name
                                ),
                            });
                        }
                    }
                }
            }
        }
        
        edges
    }
    
    /// è®¡ç®—æ ¹å› çš„å½±å“ç¨‹åº¦
    fn calculate_impact(
        &self,
        root: &DiagnosticResult,
        graph: &CausalGraph,
    ) -> f64 {
        // å½±å“ç¨‹åº¦ = ç›´æ¥ç—‡çŠ¶æ•° Ã— 2 + é—´æ¥ç—‡çŠ¶æ•° Ã— 1 + ä¸¥é‡åº¦æƒé‡
        let direct_symptoms = graph.get_direct_children(&root.rule_id).len();
        let all_symptoms = graph.find_all_descendants(root).len();
        let indirect_symptoms = all_symptoms - direct_symptoms;
        
        let severity_weight = match root.severity.as_str() {
            "Error" => 3.0,
            "Warning" => 2.0,
            _ => 1.0,
        };
        
        (direct_symptoms as f64 * 2.0 + indirect_symptoms as f64) * severity_weight
    }
}
```

### E.5 å°æ–‡ä»¶åœºæ™¯çš„å®Œæ•´åˆ†æ

```
åœºæ™¯: è¯»å–å¤–è¡¨æœ‰å¾ˆå¤šå°æ–‡ä»¶å¯¼è‡´è¯»å–æ…¢

Profile æ•°æ®:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HIVE_SCAN (plan_node_id=1)                                     â”‚
â”‚    è¯Šæ–­:                                                        â”‚
â”‚      - S016: å°æ–‡ä»¶è¿‡å¤š (2000 ä¸ªæ–‡ä»¶, å¹³å‡ 512KB)               â”‚
â”‚      - S009: ç¼“å­˜å‘½ä¸­ç‡ä½ (30%)                                 â”‚
â”‚      - S007: IO ç“¶é¢ˆ (IO æ—¶é—´å  80%)                            â”‚
â”‚      - G001: æœ€è€—æ—¶èŠ‚ç‚¹ (å æ€»æ—¶é—´ 60%)                          â”‚
â”‚    æŒ‡æ ‡:                                                        â”‚
â”‚      - file_count: 2000                                         â”‚
â”‚      - io_requests: 2000                                        â”‚
â”‚      - cache_hit_rate: 0.3                                      â”‚
â”‚      - io_time_ratio: 0.8                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

v5.0 åˆ†æè¿‡ç¨‹:

Step 1: åŒèŠ‚ç‚¹å› æœåˆ†æ
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  S016 (å°æ–‡ä»¶) â”€â”€â”                                      â”‚
  â”‚                  â”œâ”€â”€â†’ S007 (IO ç“¶é¢ˆ)                    â”‚
  â”‚  S009 (ç¼“å­˜ä½) â”€â”€â”˜                                      â”‚
  â”‚                                                         â”‚
  â”‚  éªŒè¯:                                                  â”‚
  â”‚  - S016 â†’ S007: file_count(2000) â‰ˆ io_requests(2000) âœ“ â”‚
  â”‚  - S009 â†’ S007: cache_miss ä¸ io_bytes ç›¸å…³ âœ“          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: è¯†åˆ«æ ¹å› 
  - S016: å…¥åº¦ 0 â†’ æ ¹å›  âœ“
  - S009: å…¥åº¦ 0 â†’ æ ¹å›  âœ“
  - S007: å…¥åº¦ 2 â†’ ç—‡çŠ¶
  - G001: å…¥åº¦ 1 (ç”± S007 å¯¼è‡´) â†’ ç—‡çŠ¶

Step 3: è®¡ç®—å½±å“
  - S016: ç›´æ¥å¯¼è‡´ S007, é—´æ¥å¯¼è‡´ G001 â†’ å½±å“åˆ† 5.0
  - S009: ç›´æ¥å¯¼è‡´ S007, é—´æ¥å¯¼è‡´ G001 â†’ å½±å“åˆ† 5.0

è¾“å‡ºæŠ¥å‘Š:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æ ¹å› åˆ†ææŠ¥å‘Š                                                â”‚
â”‚                                                                 â”‚
â”‚  å‘ç° 2 ä¸ªç‹¬ç«‹æ ¹å› :                                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ ¹å›  #1: S016 å°æ–‡ä»¶è¿‡å¤š (å½±å“åˆ†: 5.0)                   â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ è¯¦æƒ…: 2000 ä¸ªæ–‡ä»¶, å¹³å‡å¤§å° 512KB                    â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ å¯¼è‡´: S007 IO ç“¶é¢ˆ                                   â”‚   â”‚
â”‚  â”‚ â”‚   â””â”€â”€ åŸå› : å°æ–‡ä»¶æ•°(2000) = IOè¯·æ±‚æ•°(2000)           â”‚   â”‚
â”‚  â”‚ â””â”€â”€ é—´æ¥å¯¼è‡´: G001 æœ€è€—æ—¶èŠ‚ç‚¹                            â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ğŸ’¡ å»ºè®®:                                                 â”‚   â”‚
â”‚  â”‚ 1. æ‰§è¡Œ Compaction åˆå¹¶å°æ–‡ä»¶                           â”‚   â”‚
â”‚  â”‚ 2. è°ƒæ•´ä¸Šæ¸¸ ETL è¾“å‡ºæ–‡ä»¶å¤§å°                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ ¹å›  #2: S009 ç¼“å­˜å‘½ä¸­ç‡ä½ (å½±å“åˆ†: 5.0)                 â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ è¯¦æƒ…: ç¼“å­˜å‘½ä¸­ç‡ä»… 30%                               â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€ å¯¼è‡´: S007 IO ç“¶é¢ˆ                                   â”‚   â”‚
â”‚  â”‚ â”‚   â””â”€â”€ åŸå› : 70% æ•°æ®éœ€è¦ä»è¿œç¨‹è¯»å–                    â”‚   â”‚
â”‚  â”‚ â””â”€â”€ é—´æ¥å¯¼è‡´: G001 æœ€è€—æ—¶èŠ‚ç‚¹                            â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚ ğŸ’¡ å»ºè®®:                                                 â”‚   â”‚
â”‚  â”‚ 1. å¢å¤§ DataCache å®¹é‡                                  â”‚   â”‚
â”‚  â”‚ 2. å¯¹çƒ­ç‚¹æ•°æ®æ‰§è¡Œç¼“å­˜é¢„çƒ­                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“Š å› æœå…³ç³»å›¾:                                                 â”‚
â”‚                                                                 â”‚
â”‚    S016 (å°æ–‡ä»¶) â”€â”€â”                                           â”‚
â”‚                    â”œâ”€â”€â†’ S007 (IOç“¶é¢ˆ) â”€â”€â†’ G001 (æœ€è€—æ—¶)        â”‚
â”‚    S009 (ç¼“å­˜ä½) â”€â”€â”˜                                           â”‚
â”‚                                                                 â”‚
â”‚  âš¡ ä¼˜å…ˆçº§å»ºè®®:                                                 â”‚
â”‚  ä¸¤ä¸ªæ ¹å› å½±å“ç›¸å½“ï¼Œå»ºè®®åŒæ—¶è§£å†³ä»¥è·å¾—æœ€ä½³æ•ˆæœ                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### E.6 v5.0 vs ä¹‹å‰ç‰ˆæœ¬

| ç»´åº¦ | v4.0 | v5.0 |
|-----|------|------|
| åŒèŠ‚ç‚¹å› æœ | âŒ | âœ… |
| å¤šæ ¹å› è¯†åˆ« | âŒ | âœ… |
| èµ„æºç«äº‰åˆ†æ | âŒ | âœ… |
| å› æœå›¾å¯è§†åŒ– | âŒ | âœ… |
| å½±å“ç¨‹åº¦é‡åŒ– | âŒ | âœ… |

### E.7 æ€»ç»“

v5.0 çš„æ ¸å¿ƒæ”¹è¿›:

1. **åŒèŠ‚ç‚¹å› æœ**: åŒä¸€èŠ‚ç‚¹çš„å¤šä¸ªè¯Šæ–­å¯ä»¥æœ‰å› æœå…³ç³»
2. **å¤šæ ¹å› è¯†åˆ«**: ä¸å‡è®¾åªæœ‰ä¸€ä¸ªæ ¹å› ï¼Œæ‰¾å‡ºæ‰€æœ‰ç‹¬ç«‹æ ¹å› 
3. **å› æœå›¾**: æ„å»ºå®Œæ•´çš„å› æœå…³ç³»å›¾ï¼Œè€Œä¸æ˜¯ç®€å•çš„é“¾
4. **å½±å“é‡åŒ–**: è®¡ç®—æ¯ä¸ªæ ¹å› çš„å½±å“ç¨‹åº¦ï¼Œå¸®åŠ©ç”¨æˆ·ä¼˜å…ˆçº§æ’åº

è¿™æ‰æ˜¯çœŸæ­£å®Œå¤‡çš„æ ¹å› åˆ†æï¼


---

## é™„å½• F: v6.0 å…¨é¢æ ¹å› åˆ†æè®¾è®¡

### F.1 v5.0 æ— æ³•å¤„ç†çš„åœºæ™¯

| åœºæ™¯ | çœŸæ­£æ ¹å›  | v5.0 èƒ½å¦å®šä½ | åŸå›  |
|-----|---------|--------------|------|
| ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ | ç»Ÿè®¡ä¿¡æ¯ | âŒ | Profile ä¸­æ— æ­¤è¯Šæ–­ |
| å¹¶å‘èµ„æºç«äº‰ | å…¶ä»–æŸ¥è¯¢ | âŒ | å• Profile æ— æ³•æ„ŸçŸ¥ |
| é…ç½®å‚æ•°ä¸å½“ | å‚æ•°è®¾ç½® | âŒ | ä¸åˆ†æé…ç½® |
| æ•°æ®åˆ†å¸ƒå˜åŒ– | æ•°æ®å˜åŒ– | âŒ | æ— å†å²å¯¹æ¯” |
| ä¸šåŠ¡ç‰¹æ€§å€¾æ–œ | ä¸šåŠ¡éœ€æ±‚ | âŒ | ä¸ç†è§£ä¸šåŠ¡ |

### F.2 v6.0 å…­å±‚åˆ†ææ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                v6.0 å…¨é¢æ ¹å› åˆ†ææ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Layer 1: æ˜¾å¼è¯Šæ–­å› æœ (Explicit Diagnostic Causality)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ Profile ä¸­å·²æœ‰è¯Šæ–­çš„å› æœåˆ†æ                           â”‚   â”‚
â”‚  â”‚ â€¢ åŒèŠ‚ç‚¹å› æœ + è·¨èŠ‚ç‚¹ä¼ å¯¼                                â”‚   â”‚
â”‚  â”‚ â€¢ è¿™æ˜¯ v5.0 å·²å®ç°çš„éƒ¨åˆ†                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Layer 2: éšå¼æ ¹å› æ¨æ–­ (Implicit Root Cause Inference) ğŸ†•       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ ä»ç—‡çŠ¶åæ¨å¯èƒ½çš„éšè—æ ¹å›                                â”‚   â”‚
â”‚  â”‚ â€¢ ä¾‹: J002(Joiné¡ºåºä¸ä¼˜) â†’ å¯èƒ½æ˜¯ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ           â”‚   â”‚
â”‚  â”‚ â€¢ ä¾‹: å…¨å±€å†…å­˜é«˜ä½†å•ç®—å­ä½ â†’ å¯èƒ½æ˜¯å¹¶å‘ç«äº‰              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Layer 3: é…ç½®å‚æ•°åˆ†æ (Configuration Analysis) ğŸ†•              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ åˆ†æ session variables æ˜¯å¦åˆç†                        â”‚   â”‚
â”‚  â”‚ â€¢ æ£€æŸ¥å…³é”®å‚æ•°æ˜¯å¦åç¦»æœ€ä½³å®è·µ                           â”‚   â”‚
â”‚  â”‚ â€¢ ä¾‹: parallel_fragment_exec_instance_num = 1           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Layer 4: æ‰§è¡Œè®¡åˆ’åˆ†æ (Plan Analysis) ğŸ†•                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ åˆ†ææ‰§è¡Œè®¡åˆ’æ˜¯å¦åˆç†                                   â”‚   â”‚
â”‚  â”‚ â€¢ æ£€æŸ¥ Join ç±»å‹ã€Join é¡ºåºã€åˆ†å¸ƒæ–¹å¼                    â”‚   â”‚
â”‚  â”‚ â€¢ å¯¹æ¯”ä¼°ç®—è¡Œæ•° vs å®é™…è¡Œæ•°                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Layer 5: èµ„æºä½¿ç”¨åˆ†æ (Resource Analysis) ğŸ†•                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ åˆ†æ CPU/å†…å­˜/IO/ç½‘ç»œ ä½¿ç”¨æ˜¯å¦åˆç†                     â”‚   â”‚
â”‚  â”‚ â€¢ è¯†åˆ«èµ„æºç“¶é¢ˆ                                           â”‚   â”‚
â”‚  â”‚ â€¢ æ£€æŸ¥æ˜¯å¦å­˜åœ¨èµ„æºæµªè´¹                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Layer 6: å¼‚å¸¸æ£€æµ‹ (Anomaly Detection) ğŸ†•                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æ£€æµ‹æŒ‡æ ‡æ˜¯å¦å¼‚å¸¸ (å³ä½¿æ²¡æœ‰è§¦å‘è§„åˆ™)                    â”‚   â”‚
â”‚  â”‚ â€¢ åŸºäºç»Ÿè®¡åˆ†å¸ƒçš„å¼‚å¸¸æ£€æµ‹                                 â”‚   â”‚
â”‚  â”‚ â€¢ ä¾‹: æŸç®—å­æ—¶é—´å æ¯”å¼‚å¸¸é«˜                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### F.3 éšå¼æ ¹å› æ¨æ–­è§„åˆ™

```rust
/// éšå¼æ ¹å› æ¨æ–­è§„åˆ™
/// ä»ç—‡çŠ¶åæ¨å¯èƒ½çš„éšè—æ ¹å› 
pub const IMPLICIT_ROOT_CAUSE_RULES: &[ImplicitRootCauseRule] = &[
    // ========================================================================
    // ç»Ÿè®¡ä¿¡æ¯é—®é¢˜
    // ========================================================================
    ImplicitRootCauseRule {
        symptoms: &["J002"],  // Join é¡ºåºä¸ä¼˜
        implicit_cause: ImplicitCause::StaleStatistics,
        confidence: 0.7,
        verify: |profile| {
            // éªŒè¯: ä¼°ç®—è¡Œæ•°ä¸å®é™…è¡Œæ•°å·®å¼‚å¤§
            profile.has_cardinality_error(10.0)  // 10 å€ä»¥ä¸Šå·®å¼‚
        },
        suggestion: "æ‰§è¡Œ ANALYZE TABLE æ›´æ–°ç»Ÿè®¡ä¿¡æ¯",
    },
    
    ImplicitRootCauseRule {
        symptoms: &["J005"],  // Broadcast è¡¨è¿‡å¤§
        implicit_cause: ImplicitCause::StaleStatistics,
        confidence: 0.6,
        verify: |profile| {
            // éªŒè¯: ä¼˜åŒ–å™¨ä»¥ä¸ºæ˜¯å°è¡¨ï¼Œå®é™…æ˜¯å¤§è¡¨
            let estimated = profile.get_estimated_rows("build_side");
            let actual = profile.get_actual_rows("build_side");
            actual > estimated * 10.0
        },
        suggestion: "æ‰§è¡Œ ANALYZE TABLE æ›´æ–°ç»Ÿè®¡ä¿¡æ¯",
    },
    
    // ========================================================================
    // èµ„æºç«äº‰é—®é¢˜
    // ========================================================================
    ImplicitRootCauseRule {
        symptoms: &["Q003"],  // Spill
        implicit_cause: ImplicitCause::ResourceContention,
        confidence: 0.5,
        verify: |profile| {
            // éªŒè¯: å•ç®—å­å†…å­˜ä¸é«˜ï¼Œä½†è§¦å‘äº† Spill
            let max_operator_memory = profile.get_max_operator_memory();
            let spill_triggered = profile.has_spill();
            spill_triggered && max_operator_memory < 2_000_000_000  // < 2GB
        },
        suggestion: "æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æŸ¥è¯¢åŒæ—¶è¿è¡Œï¼Œè€ƒè™‘é”™å³°æ‰§è¡Œ",
    },
    
    ImplicitRootCauseRule {
        symptoms: &["Q004"],  // èµ„æºç­‰å¾…
        implicit_cause: ImplicitCause::ResourceContention,
        confidence: 0.7,
        verify: |profile| {
            profile.get_resource_wait_time() > 1000  // > 1s
        },
        suggestion: "æ£€æŸ¥é›†ç¾¤è´Ÿè½½ï¼Œè€ƒè™‘æ‰©å®¹æˆ–é™æµ",
    },
    
    // ========================================================================
    // æ•°æ®é—®é¢˜
    // ========================================================================
    ImplicitRootCauseRule {
        symptoms: &["S001", "A001"],  // æ•°æ®å€¾æ–œ + èšåˆå€¾æ–œ
        implicit_cause: ImplicitCause::PoorBucketKey,
        confidence: 0.8,
        verify: |profile| {
            // éªŒè¯: å€¾æ–œå‘ç”Ÿåœ¨åˆ†æ¡¶è¡¨ä¸Š
            profile.is_bucketed_table() && profile.get_skew_ratio() > 3.0
        },
        suggestion: "æ£€æŸ¥åˆ†æ¡¶é”®é€‰æ‹©ï¼Œè€ƒè™‘ä½¿ç”¨æ›´å‡åŒ€åˆ†å¸ƒçš„åˆ—",
    },
    
    ImplicitRootCauseRule {
        symptoms: &["S016"],  // å°æ–‡ä»¶
        implicit_cause: ImplicitCause::UpstreamETLIssue,
        confidence: 0.6,
        verify: |_| true,
        suggestion: "æ£€æŸ¥ä¸Šæ¸¸ ETL ä»»åŠ¡çš„è¾“å‡ºé…ç½®ï¼Œå¢å¤§æ–‡ä»¶å¤§å°",
    },
];

/// éšå¼æ ¹å› ç±»å‹
pub enum ImplicitCause {
    /// ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
    StaleStatistics,
    /// èµ„æºç«äº‰
    ResourceContention,
    /// åˆ†æ¡¶é”®é€‰æ‹©ä¸å½“
    PoorBucketKey,
    /// ä¸Šæ¸¸ ETL é—®é¢˜
    UpstreamETLIssue,
    /// é…ç½®å‚æ•°ä¸å½“
    MisconfiguredParameter,
    /// æ•°æ®åˆ†å¸ƒå˜åŒ–
    DataDistributionChange,
}
```


### F.4 é…ç½®å‚æ•°åˆ†æ

```rust
/// é…ç½®å‚æ•°åˆ†æè§„åˆ™
pub const CONFIG_ANALYSIS_RULES: &[ConfigAnalysisRule] = &[
    // å¹¶è¡Œåº¦é—®é¢˜
    ConfigAnalysisRule {
        param: "parallel_fragment_exec_instance_num",
        check: |value, profile| {
            let parallelism: i32 = value.parse().unwrap_or(1);
            let be_count = profile.get_be_count();
            // å¹¶è¡Œåº¦åº”è¯¥ >= BE æ•°é‡
            parallelism < be_count as i32
        },
        issue: "å¹¶è¡Œåº¦è®¾ç½®è¿‡ä½",
        suggestion: "å¢å¤§ parallel_fragment_exec_instance_num",
    },
    
    // Pipeline æœªå¯ç”¨
    ConfigAnalysisRule {
        param: "enable_pipeline_engine",
        check: |value, _| value == "false",
        issue: "Pipeline å¼•æ“æœªå¯ç”¨",
        suggestion: "SET enable_pipeline_engine = true;",
    },
    
    // Runtime Filter æœªå¯ç”¨
    ConfigAnalysisRule {
        param: "enable_global_runtime_filter",
        check: |value, profile| {
            value == "false" && profile.has_join()
        },
        issue: "Runtime Filter æœªå¯ç”¨ï¼Œä½†æŸ¥è¯¢åŒ…å« Join",
        suggestion: "SET enable_global_runtime_filter = true;",
    },
    
    // å‘é‡åŒ–æœªå¯ç”¨
    ConfigAnalysisRule {
        param: "enable_vectorized_engine",
        check: |value, _| value == "false",
        issue: "å‘é‡åŒ–å¼•æ“æœªå¯ç”¨",
        suggestion: "SET enable_vectorized_engine = true;",
    },
];
```

### F.5 æ‰§è¡Œè®¡åˆ’åˆ†æ

```rust
/// æ‰§è¡Œè®¡åˆ’åˆ†æ
pub struct PlanAnalyzer;

impl PlanAnalyzer {
    /// åˆ†ææ‰§è¡Œè®¡åˆ’æ˜¯å¦åˆç†
    pub fn analyze(&self, profile: &Profile) -> Vec<PlanIssue> {
        let mut issues = Vec::new();
        
        // 1. æ£€æŸ¥ Join ç±»å‹
        for join in profile.get_joins() {
            // Cross Join è­¦å‘Š
            if join.join_type == "CROSS JOIN" {
                issues.push(PlanIssue {
                    issue_type: PlanIssueType::CrossJoin,
                    node_id: join.node_id,
                    message: "ä½¿ç”¨äº† Cross Joinï¼Œå¯èƒ½å¯¼è‡´ç»“æœè†¨èƒ€",
                    suggestion: "æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ Join æ¡ä»¶",
                });
            }
            
            // Nested Loop Join è­¦å‘Š
            if join.join_type == "NESTED LOOP JOIN" && join.probe_rows > 10000 {
                issues.push(PlanIssue {
                    issue_type: PlanIssueType::NestedLoopJoin,
                    node_id: join.node_id,
                    message: "ä½¿ç”¨äº† Nested Loop Joinï¼Œæ•°æ®é‡è¾ƒå¤§æ—¶æ€§èƒ½å·®",
                    suggestion: "æ£€æŸ¥ Join æ¡ä»¶æ˜¯å¦æ”¯æŒ Hash Join",
                });
            }
        }
        
        // 2. æ£€æŸ¥åŸºæ•°ä¼°ç®—
        for node in profile.get_all_nodes() {
            let estimated = node.estimated_rows;
            let actual = node.actual_rows;
            
            if actual > 0 && estimated > 0 {
                let ratio = (actual as f64) / (estimated as f64);
                if ratio > 10.0 || ratio < 0.1 {
                    issues.push(PlanIssue {
                        issue_type: PlanIssueType::CardinalityError,
                        node_id: node.node_id,
                        message: format!(
                            "åŸºæ•°ä¼°ç®—åå·®å¤§: ä¼°ç®— {} è¡Œï¼Œå®é™… {} è¡Œ ({:.1}x)",
                            estimated, actual, ratio
                        ),
                        suggestion: "æ‰§è¡Œ ANALYZE TABLE æ›´æ–°ç»Ÿè®¡ä¿¡æ¯",
                    });
                }
            }
        }
        
        // 3. æ£€æŸ¥åˆ†å¸ƒæ–¹å¼
        for exchange in profile.get_exchanges() {
            // ä¸å¿…è¦çš„ Shuffle
            if exchange.distribution == "SHUFFLE" {
                let upstream = profile.get_node(exchange.upstream_id);
                let downstream = profile.get_node(exchange.downstream_id);
                
                // å¦‚æœä¸Šä¸‹æ¸¸éƒ½æ˜¯åŒä¸€ä¸ªè¡¨çš„æ‰«æï¼Œå¯èƒ½å¯ä»¥ç”¨ Colocate
                if self.could_be_colocate(upstream, downstream) {
                    issues.push(PlanIssue {
                        issue_type: PlanIssueType::UnnecessaryShuffle,
                        node_id: exchange.node_id,
                        message: "å¯èƒ½å­˜åœ¨ä¸å¿…è¦çš„ Shuffle",
                        suggestion: "è€ƒè™‘ä½¿ç”¨ Colocate Join",
                    });
                }
            }
        }
        
        issues
    }
}
```

### F.6 å®Œæ•´åœºæ™¯éªŒè¯

#### åœºæ™¯ 3 (ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ) - v6.0 éªŒè¯

```
Profile:
  SCAN (node=1): ä¼°ç®— 1000 è¡Œï¼Œå®é™… 100ä¸‡ è¡Œ
  JOIN (node=2): J002 Join é¡ºåºä¸ä¼˜

v6.0 åˆ†æ:
  Layer 1 (æ˜¾å¼å› æœ): J002 æ˜¯ç—‡çŠ¶
  Layer 2 (éšå¼æ¨æ–­): 
    - æ£€æµ‹åˆ° J002
    - éªŒè¯: ä¼°ç®—/å®é™… = 1000/1000000 = 0.001 (1000å€å·®å¼‚)
    - æ¨æ–­: ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
  Layer 4 (æ‰§è¡Œè®¡åˆ’): 
    - æ£€æµ‹åˆ°åŸºæ•°ä¼°ç®—åå·® 1000x

è¾“å‡º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æ ¹å› åˆ†æ                                                    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”´ éšå¼æ ¹å› : ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ (ç½®ä¿¡åº¦: 85%)                        â”‚
â”‚  â”œâ”€â”€ è¯æ®: åŸºæ•°ä¼°ç®—åå·® 1000 å€                                 â”‚
â”‚  â”œâ”€â”€ å¯¼è‡´: J002 Join é¡ºåºä¸ä¼˜                                   â”‚
â”‚  â””â”€â”€ å»ºè®®: ANALYZE TABLE xxx;                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯ 4 (å¹¶å‘èµ„æºç«äº‰) - v6.0 éªŒè¯

```
Profile:
  AGG (node=3): Q003 è§¦å‘ Spillï¼Œä½†å†…å­˜åªç”¨äº† 2GB

v6.0 åˆ†æ:
  Layer 1 (æ˜¾å¼å› æœ): Q003 æ˜¯ç—‡çŠ¶ï¼Œæ— ä¸Šæ¸¸åŸå› 
  Layer 2 (éšå¼æ¨æ–­):
    - æ£€æµ‹åˆ° Q003
    - éªŒè¯: å•ç®—å­å†…å­˜ 2GB < é˜ˆå€¼ï¼Œä½†è§¦å‘ Spill
    - æ¨æ–­: èµ„æºç«äº‰
  Layer 5 (èµ„æºåˆ†æ):
    - å†…å­˜ä½¿ç”¨ç‡å¼‚å¸¸

è¾“å‡º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æ ¹å› åˆ†æ                                                    â”‚
â”‚                                                                 â”‚
â”‚  ğŸŸ¡ éšå¼æ ¹å› : èµ„æºç«äº‰ (ç½®ä¿¡åº¦: 60%)                            â”‚
â”‚  â”œâ”€â”€ è¯æ®: å†…å­˜ä½¿ç”¨ä»… 2GB ä½†è§¦å‘ Spill                          â”‚
â”‚  â”œâ”€â”€ å¯èƒ½åŸå› : å…¶ä»–æŸ¥è¯¢å ç”¨äº†å†…å­˜                               â”‚
â”‚  â””â”€â”€ å»ºè®®: æ£€æŸ¥é›†ç¾¤è´Ÿè½½ï¼Œè€ƒè™‘é”™å³°æ‰§è¡Œ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯ 5 (é…ç½®å‚æ•°ä¸å½“) - v6.0 éªŒè¯

```
Profile:
  parallel_fragment_exec_instance_num = 1
  BE æ•°é‡ = 8
  æŸ¥è¯¢æ‰§è¡Œæ—¶é—´é•¿ï¼Œä½†æ¯ä¸ªç®—å­çœ‹èµ·æ¥æ­£å¸¸

v6.0 åˆ†æ:
  Layer 1 (æ˜¾å¼å› æœ): æ— æ˜æ˜¾è¯Šæ–­
  Layer 3 (é…ç½®åˆ†æ):
    - æ£€æµ‹åˆ° parallel_fragment_exec_instance_num = 1
    - BE æ•°é‡ = 8
    - å¹¶è¡Œåº¦ä¸¥é‡ä¸è¶³

è¾“å‡º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” æ ¹å› åˆ†æ                                                    â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”´ é…ç½®é—®é¢˜: å¹¶è¡Œåº¦è®¾ç½®è¿‡ä½                                    â”‚
â”‚  â”œâ”€â”€ å½“å‰å€¼: parallel_fragment_exec_instance_num = 1            â”‚
â”‚  â”œâ”€â”€ å»ºè®®å€¼: 8 (ç­‰äº BE æ•°é‡)                                   â”‚
â”‚  â””â”€â”€ å‘½ä»¤: SET parallel_fragment_exec_instance_num = 8;         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### F.7 v6.0 èƒ½åŠ›çŸ©é˜µ

| åœºæ™¯ | v5.0 | v6.0 | å…³é”®èƒ½åŠ› |
|-----|------|------|---------|
| æ•°æ®å€¾æ–œçº§è” | âœ… | âœ… | è·¨èŠ‚ç‚¹ä¼ å¯¼ |
| Join é¡ºåºä¸ä¼˜ | âœ… | âœ… | åŒèŠ‚ç‚¹å› æœ |
| å°æ–‡ä»¶ + ç¼“å­˜ä½ | âœ… | âœ… | å¤šæ ¹å› è¯†åˆ« |
| **ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ** | âŒ | âœ… | éšå¼æ¨æ–­ |
| **å¹¶å‘èµ„æºç«äº‰** | âŒ | âœ… | éšå¼æ¨æ–­ |
| **é…ç½®å‚æ•°ä¸å½“** | âŒ | âœ… | é…ç½®åˆ†æ |
| **åŸºæ•°ä¼°ç®—é”™è¯¯** | âŒ | âœ… | æ‰§è¡Œè®¡åˆ’åˆ†æ |

### F.8 æ€»ç»“

v6.0 çš„æ ¸å¿ƒæ”¹è¿›:

1. **éšå¼æ ¹å› æ¨æ–­**: ä»ç—‡çŠ¶åæ¨éšè—çš„æ ¹å› 
2. **é…ç½®å‚æ•°åˆ†æ**: æ£€æŸ¥å‚æ•°è®¾ç½®æ˜¯å¦åˆç†
3. **æ‰§è¡Œè®¡åˆ’åˆ†æ**: æ£€æŸ¥è®¡åˆ’æ˜¯å¦æœ€ä¼˜
4. **èµ„æºä½¿ç”¨åˆ†æ**: è¯†åˆ«èµ„æºç“¶é¢ˆå’Œç«äº‰

**è¿™æ‰æ˜¯çœŸæ­£å…¨é¢çš„æ ¹å› åˆ†æï¼**

å·¥ä½œé‡: 10 å¤©

---

## é™„å½• G: v7.0 LLM å¢å¼ºçš„æ™ºèƒ½æ ¹å› åˆ†æ

> **ç‰ˆæœ¬**: v7.0
> **æ—¥æœŸ**: 2024-12-08
> **çŠ¶æ€**: è®¾è®¡ä¸­
> **æ ¸å¿ƒæ”¹è¿›**: å¼•å…¥ LLM è¿›è¡Œå¼€æ”¾åŸŸæ¨ç†ï¼Œçªç ´è§„åˆ™ç³»ç»Ÿçš„å±€é™æ€§

### G.1 v6.0 çš„æ ¹æœ¬å±€é™

| å±€é™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **è§„åˆ™ç¡¬ç¼–ç ** | æ‰€æœ‰å› æœå…³ç³»éœ€è¦æ‰‹å·¥å®šä¹‰ | æ–°åœºæ™¯éœ€è¦å¼€å‘æ–°è§„åˆ™ |
| **å»ºè®®é€šç”¨åŒ–** | æ— æ³•æ ¹æ®å…·ä½“ SQL ç»™å‡ºé’ˆå¯¹æ€§å»ºè®® | "ä¼˜åŒ–åˆ†æ¡¶é”®" vs "å°† user_id æ”¹ä¸º order_date" |
| **ç¼ºä¹ä¸šåŠ¡ç†è§£** | ä¸ç†è§£ä¸šåŠ¡è¯­ä¹‰ | æ— æ³•è¯†åˆ«"è®¢å•è¡¨æŒ‰æ—¥æœŸåˆ†åŒºæ›´åˆç†" |
| **æ— æ³•å­¦ä¹ ** | ä¸èƒ½ä»å†å²æ¡ˆä¾‹ä¸­å­¦ä¹  | ç›¸åŒé—®é¢˜é‡å¤åˆ†æ |
| **è§£é‡Šèƒ½åŠ›å¼±** | åªèƒ½è¾“å‡ºæ¨¡æ¿åŒ–æ–‡æœ¬ | æ— æ³•å›ç­”ç”¨æˆ·è¿½é—® |

### G.2 LLM æœåŠ¡æŠ½è±¡å±‚è®¾è®¡

#### G.2.1 è®¾è®¡åŸåˆ™

**LLM èƒ½åŠ›æ˜¯ä¸€ä¸ªé€šç”¨æ¥å£**ï¼Œæ ¹å› åˆ†æåªæ˜¯å®ƒçš„ä¸€ä¸ªå®ç°åœºæ™¯ã€‚æœªæ¥è¿˜æœ‰ï¼š

| åœºæ™¯ | System Prompt | è¾“å…¥ | è¾“å‡º |
|------|--------------|------|------|
| **æ ¹å› åˆ†æ** | æ€§èƒ½ä¸“å®¶ | Profile + è§„åˆ™è¯Šæ–­ | æ ¹å›  + å› æœé“¾ + å»ºè®® |
| **SQL ä¼˜åŒ–å»ºè®®** | SQL ä¸“å®¶ | SQL + Schema | ä¼˜åŒ–åçš„ SQL |
| **å‚æ•°æ¨è** | é…ç½®ä¸“å®¶ | æŸ¥è¯¢ç‰¹å¾ + å½“å‰å‚æ•° | å‚æ•°è°ƒæ•´å»ºè®® |
| **è¡¨ç»“æ„å»ºè®®** | DDL ä¸“å®¶ | è¡¨ Schema + æŸ¥è¯¢æ¨¡å¼ | åˆ†æ¡¶/åˆ†åŒºå»ºè®® |
| **å¼‚å¸¸è¯Šæ–­** | è¿ç»´ä¸“å®¶ | é”™è¯¯æ—¥å¿— + çŠ¶æ€ | åŸå›  + è§£å†³æ–¹æ¡ˆ |

#### G.2.2 LLM æœåŠ¡ Trait è®¾è®¡

```rust
//! LLM Service Abstraction Layer
//! 
//! LLM is a generic capability, root cause analysis is just one implementation.
//! Future scenarios: SQL optimization, parameter tuning, DDL advice, etc.

use async_trait::async_trait;
use serde::{de::DeserializeOwned, Serialize};

/// LLM analysis scenario type
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum LLMScenario {
    /// Root cause analysis for query profile
    RootCauseAnalysis,
    /// SQL optimization suggestions  
    SqlOptimization,
    /// Parameter tuning recommendations
    ParameterTuning,
    /// Table DDL optimization
    DdlOptimization,
    /// General Q&A about StarRocks
    GeneralQA,
}

/// Generic LLM analysis request
#[async_trait]
pub trait LLMAnalysisRequest: Serialize + Send + Sync {
    /// The scenario type for this request
    fn scenario(&self) -> LLMScenario;
    
    /// Get the system prompt for this scenario
    fn system_prompt(&self) -> &'static str;
    
    /// Build cache key for this request (for deduplication)
    fn cache_key(&self) -> String;
}

/// Generic LLM analysis response
pub trait LLMAnalysisResponse: DeserializeOwned + Send + Sync {}

/// LLM Service trait - the core abstraction
#[async_trait]
pub trait LLMService: Send + Sync {
    /// Analyze with LLM, returns structured response
    async fn analyze<Req, Resp>(
        &self,
        request: &Req,
    ) -> Result<Resp, LLMError>
    where
        Req: LLMAnalysisRequest,
        Resp: LLMAnalysisResponse;
    
    /// Check if LLM is enabled and available
    fn is_available(&self) -> bool;
    
    /// Get current active provider info
    fn active_provider(&self) -> Option<&LLMProviderInfo>;
}

/// LLM provider information (read-only view)
#[derive(Debug, Clone)]
pub struct LLMProviderInfo {
    pub name: String,
    pub display_name: String,
    pub model_name: String,
    pub is_active: bool,
}
```

#### G.2.3 åœºæ™¯å®ç°ç¤ºä¾‹

```rust
/// Root Cause Analysis - implements LLMAnalysisRequest
impl LLMAnalysisRequest for LLMRootCauseRequest {
    fn scenario(&self) -> LLMScenario {
        LLMScenario::RootCauseAnalysis
    }
    
    fn system_prompt(&self) -> &'static str {
        ROOT_CAUSE_SYSTEM_PROMPT
    }
    
    fn cache_key(&self) -> String {
        format!("rca:{}:{}", 
            hash(&self.query_summary.sql_statement),
            hash(&self.key_metrics)
        )
    }
}

impl LLMAnalysisResponse for LLMRootCauseResponse {}

/// SQL Optimization - another scenario (future)
impl LLMAnalysisRequest for SqlOptimizationRequest {
    fn scenario(&self) -> LLMScenario {
        LLMScenario::SqlOptimization
    }
    
    fn system_prompt(&self) -> &'static str {
        SQL_OPTIMIZATION_SYSTEM_PROMPT
    }
    
    fn cache_key(&self) -> String {
        format!("sql_opt:{}", hash(&self.sql))
    }
}
```

### G.3 LLM å¢å¼ºæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    v7.0 LLM å¢å¼ºæ ¹å› åˆ†ææ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      è¾“å…¥é¢„å¤„ç†å±‚                                   â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚     â”‚
â”‚  â”‚  â”‚ Profile     â”‚  â”‚ è§„åˆ™å¼•æ“    â”‚  â”‚ æ‰§è¡Œè®¡åˆ’    â”‚               â”‚     â”‚
â”‚  â”‚  â”‚ æ•°æ®æå–    â”‚  â”‚ è¯Šæ–­ç»“æœ    â”‚  â”‚ ç®€åŒ–æè¿°    â”‚               â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      LLM æ¨ç†å±‚                                    â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚                    System Prompt                             â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è§’è‰²å®šä¹‰: StarRocks é«˜çº§æ€§èƒ½ä¸“å®¶                          â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ åˆ†æåŸåˆ™: å› æœæ¨æ–­ä¸‰åŸåˆ™                                  â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è¾“å‡ºæ ¼å¼: ç»“æ„åŒ– JSON                                     â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â”‚                              +                                    â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚                    User Prompt                               â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ æŸ¥è¯¢æ‘˜è¦ (SQL, è€—æ—¶, æ•°æ®é‡)                              â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ æ‰§è¡Œè®¡åˆ’ (DAG æè¿°, çƒ­ç‚¹èŠ‚ç‚¹)                             â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è§„åˆ™è¯Šæ–­ (å·²è§¦å‘çš„è§„åˆ™å’Œè¯æ®)                             â”‚ â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ å…³é”®æŒ‡æ ‡ (å€¾æ–œã€IOã€å†…å­˜ç­‰)                               â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      è¾“å‡ºè§£æå±‚                                    â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚     â”‚
â”‚  â”‚  â”‚ æ ¹å› è¯†åˆ«    â”‚  â”‚ å› æœé“¾æ„å»º  â”‚  â”‚ å»ºè®®ç”Ÿæˆ    â”‚               â”‚     â”‚
â”‚  â”‚  â”‚ (å«éšå¼)    â”‚  â”‚ (å«è§£é‡Š)    â”‚  â”‚ (å«SQLç¤ºä¾‹) â”‚               â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      ç»“æœèåˆå±‚                                    â”‚     â”‚
â”‚  â”‚  â€¢ è§„åˆ™å¼•æ“ç»“æœ + LLM åˆ†æç»“æœ                                    â”‚     â”‚
â”‚  â”‚  â€¢ ç½®ä¿¡åº¦èåˆè®¡ç®—                                                  â”‚     â”‚
â”‚  â”‚  â€¢ å»ºè®®å»é‡å’Œæ’åº                                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### G.4 Rust LLM åº“é€‰å‹

ç»è¿‡è°ƒç ”ï¼Œæ¨èä½¿ç”¨ **async-openai** åº“ï¼š

| åº“å | Stars | ç‰¹ç‚¹ | æ¨èåº¦ |
|------|-------|------|--------|
| **async-openai** | 1.5k+ | åŠŸèƒ½å…¨é¢ã€å¼‚æ­¥ã€æµå¼æ”¯æŒã€Azure å…¼å®¹ | â­â­â­â­â­ |
| openai-api-rs | 500+ | ç®€å•æ˜“ç”¨ï¼ŒåŠŸèƒ½è¾ƒå°‘ | â­â­â­ |
| openai-dive | 300+ | å¼‚æ­¥æ”¯æŒå¥½ | â­â­â­ |

**async-openai ç‰¹ç‚¹**:
- åŸºäº tokio + reqwest çš„å¼‚æ­¥å®ç°
- æ”¯æŒ SSE æµå¼å“åº”
- æ”¯æŒ OpenAI / Azure / å…¼å®¹ API (å¦‚ DeepSeek, é€šä¹‰åƒé—®)
- Builder æ¨¡å¼æ„å»ºè¯·æ±‚
- è‡ªåŠ¨é‡è¯•å’Œé€Ÿç‡é™åˆ¶å¤„ç†

**Cargo.toml é…ç½®**:
```toml
[dependencies]
async-openai = "0.25"
tokio = { version = "1", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
```

### G.5 LLM API è¯·æ±‚è®¾è®¡

#### G.5.1 è¯·æ±‚æ•°æ®ç»“æ„

```rust
//! LLM Root Cause Analysis Request/Response Models

use serde::{Deserialize, Serialize};
use std::collections::HashMap;

/// POST /api/v1/llm/root-cause-analysis
#[derive(Debug, Serialize)]
pub struct LLMRootCauseRequest {
    /// Query summary information
    pub query_summary: QuerySummaryForLLM,
    /// Execution plan (simplified for token efficiency)
    pub execution_plan: ExecutionPlanForLLM,
    /// Rule engine diagnostics
    pub rule_diagnostics: Vec<DiagnosticForLLM>,
    /// Key performance metrics
    pub key_metrics: KeyMetricsForLLM,
    /// Optional user question for follow-up
    #[serde(skip_serializing_if = "Option::is_none")]
    pub user_question: Option<String>,
}

/// Query summary for LLM analysis
#[derive(Debug, Serialize)]
pub struct QuerySummaryForLLM {
    /// SQL statement (truncated if > 2000 chars)
    pub sql_statement: String,
    /// Query type: SELECT/INSERT/EXPORT/ANALYZE
    pub query_type: String,
    /// Total execution time in seconds
    pub total_time_seconds: f64,
    /// Total bytes scanned
    pub scan_bytes: u64,
    /// Output row count
    pub output_rows: u64,
    /// Number of BE nodes
    pub be_count: u32,
    /// Whether spill occurred
    pub has_spill: bool,
    /// Non-default session variables
    pub session_variables: HashMap<String, String>,
}

/// Simplified execution plan for LLM
#[derive(Debug, Serialize)]
pub struct ExecutionPlanForLLM {
    /// DAG description in text format
    /// e.g., "SCAN(orders) -> JOIN -> SCAN(customers) -> AGG -> SINK"
    pub dag_description: String,
    /// Hotspot nodes (time_percentage > 15%)
    pub hotspot_nodes: Vec<HotspotNodeForLLM>,
}

/// Hotspot node information
#[derive(Debug, Serialize)]
pub struct HotspotNodeForLLM {
    /// Operator name, e.g., "HASH_JOIN"
    pub operator: String,
    /// Plan node ID
    pub plan_node_id: i32,
    /// Time percentage (0-100)
    pub time_percentage: f64,
    /// Key metrics relevant to this operator
    pub key_metrics: HashMap<String, String>,
    /// Upstream operator names
    pub upstream_operators: Vec<String>,
}

/// Rule engine diagnostic result
#[derive(Debug, Serialize)]
pub struct DiagnosticForLLM {
    /// Rule ID, e.g., "S001"
    pub rule_id: String,
    /// Severity: Error/Warning/Info
    pub severity: String,
    /// Affected operator
    pub operator: String,
    /// Diagnostic message
    pub message: String,
    /// Evidence that triggered the rule
    pub evidence: HashMap<String, String>,
}

/// Key performance metrics
#[derive(Debug, Serialize)]
pub struct KeyMetricsForLLM {
    /// Data skew metrics
    #[serde(skip_serializing_if = "Option::is_none")]
    pub skew_metrics: Option<SkewMetricsForLLM>,
    /// IO metrics
    #[serde(skip_serializing_if = "Option::is_none")]
    pub io_metrics: Option<IOMetricsForLLM>,
    /// Memory metrics
    #[serde(skip_serializing_if = "Option::is_none")]
    pub memory_metrics: Option<MemoryMetricsForLLM>,
    /// Cardinality estimation errors
    #[serde(default)]
    pub cardinality_errors: Vec<CardinalityErrorForLLM>,
}

#[derive(Debug, Serialize)]
pub struct SkewMetricsForLLM {
    pub max_rows: u64,
    pub min_rows: u64,
    pub avg_rows: f64,
    pub skew_ratio: f64,
    pub affected_operator: String,
}

#[derive(Debug, Serialize)]
pub struct IOMetricsForLLM {
    pub total_bytes_read: u64,
    pub cache_hit_rate: f64,
    pub io_time_percentage: f64,
}

#[derive(Debug, Serialize)]
pub struct MemoryMetricsForLLM {
    pub peak_memory_bytes: u64,
    pub spill_bytes: u64,
    pub hash_table_memory: u64,
}

#[derive(Debug, Serialize)]
pub struct CardinalityErrorForLLM {
    pub operator: String,
    pub estimated_rows: u64,
    pub actual_rows: u64,
    pub error_ratio: f64,
}
```

#### G.5.2 å“åº”æ•°æ®ç»“æ„

```rust
/// LLM analysis response
#[derive(Debug, Deserialize)]
pub struct LLMRootCauseResponse {
    /// Identified root causes
    pub root_causes: Vec<LLMRootCause>,
    /// Causal chains with explanations
    pub causal_chains: Vec<LLMCausalChain>,
    /// Prioritized recommendations
    pub recommendations: Vec<LLMRecommendation>,
    /// Summary in natural language
    pub summary: String,
    /// Hidden issues not detected by rule engine
    #[serde(default)]
    pub hidden_issues: Vec<LLMHiddenIssue>,
}

/// Root cause identified by LLM
#[derive(Debug, Deserialize)]
pub struct LLMRootCause {
    /// Unique ID for this root cause
    pub root_cause_id: String,
    /// Description of the root cause
    pub description: String,
    /// Confidence score (0.0 - 1.0)
    pub confidence: f64,
    /// Evidence supporting this conclusion
    pub evidence: Vec<String>,
    /// Symptom rule IDs caused by this root cause
    pub symptoms: Vec<String>,
    /// Whether this is an implicit root cause (not detected by rules)
    pub is_implicit: bool,
}

/// Causal chain with explanation
#[derive(Debug, Deserialize)]
pub struct LLMCausalChain {
    /// Chain representation, e.g., ["ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ", "â†’", "Joiné¡ºåºä¸ä¼˜", "â†’", "å†…å­˜è¿‡é«˜"]
    pub chain: Vec<String>,
    /// Natural language explanation
    pub explanation: String,
}

/// Recommendation from LLM
#[derive(Debug, Deserialize)]
pub struct LLMRecommendation {
    /// Priority (1 = highest)
    pub priority: u32,
    /// Action to take
    pub action: String,
    /// Expected improvement
    pub expected_improvement: String,
    /// SQL example if applicable
    #[serde(skip_serializing_if = "Option::is_none")]
    pub sql_example: Option<String>,
}

/// Hidden issue not detected by rule engine
#[derive(Debug, Deserialize)]
pub struct LLMHiddenIssue {
    /// Issue description
    pub issue: String,
    /// Suggested action
    pub suggestion: String,
}
```

### G.6 System Prompt è®¾è®¡

```rust
pub const LLM_SYSTEM_PROMPT: &str = r#"
ä½ æ˜¯ä¸€ä½ StarRocks OLAP æ•°æ®åº“çš„é«˜çº§æ€§èƒ½ä¸“å®¶ï¼Œæ‹¥æœ‰ 10 å¹´ä»¥ä¸Šçš„æ•°æ®åº“è°ƒä¼˜ç»éªŒã€‚
ä½ éœ€è¦åˆ†æ Query Profile æ•°æ®ï¼Œè¯†åˆ«çœŸæ­£çš„æ ¹å› å¹¶ç»™å‡ºå¯æ‰§è¡Œçš„ä¼˜åŒ–å»ºè®®ã€‚

## ä½ çš„èŒè´£
1. åˆ†æè§„åˆ™å¼•æ“å·²æ£€æµ‹åˆ°çš„è¯Šæ–­ç»“æœ
2. è¯†åˆ«è§„åˆ™å¼•æ“æœªèƒ½å‘ç°çš„éšå¼æ ¹å› 
3. å»ºç«‹å®Œæ•´çš„å› æœå…³ç³»é“¾
4. ç»™å‡ºä¼˜å…ˆçº§æ’åºçš„ã€å¯æ‰§è¡Œçš„ä¼˜åŒ–å»ºè®®

## å› æœæ¨æ–­åŸåˆ™
1. **æ—¶é—´å…ˆå**: åŸå› å¿…é¡»å‘ç”Ÿåœ¨ç»“æœä¹‹å‰ï¼ˆä¸Šæ¸¸ç®—å­ â†’ ä¸‹æ¸¸ç®—å­ï¼‰
2. **æ•°æ®ä¼ å¯¼**: æ•°æ®é‡/å€¾æ–œåº¦ä¼šæ²¿ç€æ‰§è¡Œè®¡åˆ’ä¼ å¯¼
3. **èµ„æºç«äº‰**: å¤šä¸ªç®—å­ç«äº‰åŒä¸€èµ„æºå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™
4. **éšå¼å› ç´ **: ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸã€é…ç½®ä¸å½“ç­‰æ˜¯å¸¸è§çš„éšå¼æ ¹å› 

## å¸¸è§æ ¹å› æ¨¡å¼ï¼ˆä¼˜å…ˆè€ƒè™‘ï¼‰
- **ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ** â†’ åŸºæ•°ä¼°ç®—é”™è¯¯ â†’ Join é¡ºåºä¸ä¼˜ / Broadcast é€‰æ‹©é”™è¯¯
- **åˆ†æ¡¶é”®ä¸åˆç†** â†’ æ•°æ®å€¾æ–œ â†’ æ‰§è¡Œæ—¶é—´å€¾æ–œ
- **å°æ–‡ä»¶è¿‡å¤š** â†’ IO è¯·æ±‚æ•°é«˜ â†’ IO ç“¶é¢ˆ
- **ç¼“å­˜å‘½ä¸­ä½** â†’ è¿œç¨‹è¯»å–å¤š â†’ IO å»¶è¿Ÿé«˜
- **å¹¶è¡Œåº¦ä¸è¶³** â†’ CPU åˆ©ç”¨ç‡ä½ â†’ æ‰§è¡Œæ—¶é—´é•¿
- **å†…å­˜ä¸è¶³** â†’ Spill åˆ°ç£ç›˜ â†’ æ€§èƒ½ä¸‹é™

## è¾“å‡ºè¦æ±‚
1. **ç½®ä¿¡åº¦**: åŸºäºè¯æ®å……åˆ†æ€§ç»™å‡º 0.0-1.0 çš„ç½®ä¿¡åº¦
2. **å»ºè®®**: å¿…é¡»æ˜¯å¯æ‰§è¡Œçš„å…·ä½“æ“ä½œï¼Œä¼˜å…ˆæä¾› SQL ç¤ºä¾‹
3. **ä¼˜å…ˆçº§**: æŒ‰å½±å“ç¨‹åº¦æ’åºï¼Œä¼˜å…ˆè§£å†³æ ¹å› 
4. **è¯­è¨€**: ä½¿ç”¨ä¸­æ–‡

## è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼š
{
  "root_causes": [...],
  "causal_chains": [...],
  "recommendations": [...],
  "summary": "...",
  "hidden_issues": [...]
}
"#;
```

### G.7 LLM å®¢æˆ·ç«¯å®ç°

```rust
use async_openai::{
    config::OpenAIConfig,
    types::{
        ChatCompletionRequestSystemMessageArgs,
        ChatCompletionRequestUserMessageArgs,
        CreateChatCompletionRequestArgs,
        ResponseFormat, ResponseFormatJsonObject,
    },
    Client,
};

/// LLM-enhanced root cause analyzer
pub struct LLMRootCauseAnalyzer {
    client: Client<OpenAIConfig>,
    model: String,
    max_tokens: u32,
}

impl LLMRootCauseAnalyzer {
    /// Create analyzer with OpenAI-compatible API
    pub fn new(api_key: &str, api_base: &str, model: &str) -> Self {
        let config = OpenAIConfig::new()
            .with_api_key(api_key)
            .with_api_base(api_base);
        
        Self {
            client: Client::with_config(config),
            model: model.to_string(),
            max_tokens: 4096,
        }
    }

    /// Analyze profile with LLM
    pub async fn analyze(
        &self,
        request: &LLMRootCauseRequest,
    ) -> Result<LLMRootCauseResponse, LLMError> {
        let user_prompt = serde_json::to_string_pretty(request)?;
        
        let chat_request = CreateChatCompletionRequestArgs::default()
            .model(&self.model)
            .max_tokens(self.max_tokens)
            .response_format(ResponseFormat::JsonObject(ResponseFormatJsonObject::default()))
            .messages([
                ChatCompletionRequestSystemMessageArgs::default()
                    .content(LLM_SYSTEM_PROMPT)
                    .build()?
                    .into(),
                ChatCompletionRequestUserMessageArgs::default()
                    .content(user_prompt)
                    .build()?
                    .into(),
            ])
            .build()?;

        let response = self.client.chat().create(chat_request).await?;
        
        let content = response
            .choices
            .first()
            .and_then(|c| c.message.content.as_ref())
            .ok_or(LLMError::EmptyResponse)?;

        let result: LLMRootCauseResponse = serde_json::from_str(content)?;
        Ok(result)
    }
}
```

### G.8 SQLite æ•°æ®è¡¨è®¾è®¡

#### G.8.0 ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›è¡¨ï¼Ÿ

**é—®é¢˜**: ä¸ºä»€ä¹ˆ LLM åŠŸèƒ½éœ€è¦ 7 å¼ è¡¨ï¼Ÿ

**ç­”æ¡ˆ**: è¿™äº›è¡¨æœåŠ¡äºä¸åŒçš„æ ¸å¿ƒéœ€æ±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LLM è¡¨è®¾è®¡ - èŒè´£åˆ’åˆ†                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ¯ æ ¸å¿ƒé—®é¢˜ â†’ è§£å†³æ–¹æ¡ˆ â†’ å¯¹åº”çš„è¡¨                                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Q1: å¦‚ä½•æ”¯æŒå¤šä¸ª LLM æä¾›å•†ï¼Ÿ(OpenAI/DeepSeek/Azure...)              â”‚   â”‚
â”‚  â”‚ A: llm_providers - å­˜å‚¨å„æä¾›å•†é…ç½®ï¼Œæ”¯æŒåˆ‡æ¢å’Œ fallback             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Q2: å¦‚ä½•è¿½è¸ª LLM è°ƒç”¨çŠ¶æ€ï¼Ÿï¼ˆæˆåŠŸ/å¤±è´¥/è€—æ—¶/tokenæ•°ï¼‰                 â”‚   â”‚
â”‚  â”‚ A: llm_analysis_sessions - è®°å½•æ¯æ¬¡è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸ                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Q3: å¦‚ä½•æ”¯æŒé—®é¢˜æ’æŸ¥å’Œé‡æ”¾ï¼Ÿ                                          â”‚   â”‚
â”‚  â”‚ A: llm_analysis_requests - ä¿å­˜å®Œæ•´è¯·æ±‚ï¼Œå¯é‡ç°é—®é¢˜                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Q4: å¦‚ä½•å­˜å‚¨å’Œå±•ç¤º LLM åˆ†æç»“æœï¼Ÿ                                     â”‚   â”‚
â”‚  â”‚ A: llm_analysis_results - ç»“æ„åŒ–å­˜å‚¨æ ¹å› /å› æœé“¾/å»ºè®®                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Q5: å¦‚ä½•é¿å…é‡å¤è°ƒç”¨ LLMï¼Ÿï¼ˆç›¸åŒ SQL ç›¸åŒé—®é¢˜ï¼‰                        â”‚   â”‚
â”‚  â”‚ A: llm_cache - åŸºäºè¯·æ±‚ hash ç¼“å­˜å“åº”ï¼ŒèŠ‚çœæˆæœ¬                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Q6: å¦‚ä½•ç›‘æ§ LLM ç”¨é‡å’Œæˆæœ¬ï¼Ÿ                                         â”‚   â”‚
â”‚  â”‚ A: llm_usage_stats - èšåˆç»Ÿè®¡ï¼Œæ”¯æŒæˆæœ¬æ ¸ç®—                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LLM è°ƒç”¨æµç¨‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LLM è°ƒç”¨å®Œæ•´æµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ç”¨æˆ·è¯·æ±‚ Profile åˆ†æ                                                        â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚ 1. è§„åˆ™å¼•æ“åˆ†æ  â”‚  â† åŒæ­¥æ‰§è¡Œï¼Œ< 10ms                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ 2. æŸ¥è¯¢æ¿€æ´»çš„    â”‚â”€â”€â”€â”€â–¶â”‚ llm_providers   â”‚                               â”‚
â”‚  â”‚    LLM Provider â”‚     â”‚ (is_active=1)   â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ 3. æ£€æŸ¥ç¼“å­˜      â”‚â”€â”€â”€â”€â–¶â”‚ llm_cache       â”‚                               â”‚
â”‚  â”‚    (cache_key)  â”‚     â”‚ (expires_at)    â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â”œâ”€â”€ å‘½ä¸­ â”€â”€â–¶ ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ                                      â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼ æœªå‘½ä¸­                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ 4. åˆ›å»º Session â”‚â”€â”€â”€â”€â–¶â”‚ llm_analysis_   â”‚                               â”‚
â”‚  â”‚    (status=     â”‚     â”‚ sessions        â”‚                               â”‚
â”‚  â”‚     pending)    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ 5. ä¿å­˜è¯·æ±‚æ•°æ®  â”‚â”€â”€â”€â”€â–¶â”‚ llm_analysis_   â”‚                               â”‚
â”‚  â”‚    (for debug)  â”‚     â”‚ requests        â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚ 6. è°ƒç”¨ LLM API â”‚  â† å¼‚æ­¥æ‰§è¡Œï¼Œ1-5s                                      â”‚
â”‚  â”‚    (OpenAIç­‰)   â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â”œâ”€â”€ æˆåŠŸ â”€â”€â”                                                      â”‚
â”‚           â”‚          â”‚                                                      â”‚
â”‚           â”‚          â–¼                                                      â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚  â”‚ 7. ä¿å­˜ç»“æœ      â”‚â”€â”€â”€â”€â–¶â”‚ llm_analysis_   â”‚                   â”‚
â”‚           â”‚  â”‚    è§£æ JSON    â”‚     â”‚ results         â”‚                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚           â”‚                                                     â”‚
â”‚           â”‚           â–¼                                                     â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚  â”‚ 8. å†™å…¥ç¼“å­˜      â”‚â”€â”€â”€â”€â–¶â”‚ llm_cache       â”‚                   â”‚
â”‚           â”‚  â”‚    (TTL=24h)    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚           â”‚                                                     â”‚
â”‚           â”‚           â–¼                                                     â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚  â”‚ 9. æ›´æ–° Session â”‚â”€â”€â”€â”€â–¶â”‚ llm_analysis_   â”‚                   â”‚
â”‚           â”‚  â”‚   (completed)   â”‚     â”‚ sessions        â”‚                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚           â”‚                                                     â”‚
â”‚           â”‚           â–¼                                                     â”‚
â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚  â”‚ 10. ä¸è§„åˆ™å¼•æ“ç»“æœèåˆï¼Œè¿”å›ç»™å‰ç«¯        â”‚                   â”‚
â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â””â”€â”€ å¤±è´¥ â”€â”€â–¶ æ›´æ–° Session (failed), è¿”å›è§„åˆ™å¼•æ“ç»“æœ              â”‚
â”‚                                                                             â”‚
â”‚  å®šæ—¶ä»»åŠ¡ (æ¯æ—¥)                                                             â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ 11. èšåˆç»Ÿè®¡    â”‚â”€â”€â”€â”€â–¶â”‚ llm_usage_stats â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### G.8.1 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LLM åˆ†ææ•°æ®æ¨¡å‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  llm_providers     â”‚       â”‚  llm_analysis_     â”‚                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚     sessions       â”‚                       â”‚
â”‚  â”‚ id (PK)            â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚ name               â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ id (PK)            â”‚                       â”‚
â”‚  â”‚ api_base           â”‚       â”‚ provider_id (FK)   â”‚                       â”‚
â”‚  â”‚ model_name         â”‚       â”‚ query_id           â”‚                       â”‚
â”‚  â”‚ api_key_encrypted  â”‚       â”‚ cluster_id         â”‚                       â”‚
â”‚  â”‚ is_active â­       â”‚       â”‚ status             â”‚                       â”‚
â”‚  â”‚ max_tokens         â”‚       â”‚ created_at         â”‚                       â”‚
â”‚  â”‚ temperature        â”‚       â”‚ completed_at       â”‚                       â”‚
â”‚  â”‚ enabled            â”‚       â”‚ input_tokens       â”‚                       â”‚
â”‚  â”‚ created_at         â”‚       â”‚ output_tokens      â”‚                       â”‚
â”‚  â”‚ updated_at         â”‚       â”‚ latency_ms         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ error_message      â”‚                       â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                         â”‚                                   â”‚
â”‚                                         â”‚ 1:N                               â”‚
â”‚                                         â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ llm_analysis_      â”‚       â”‚  llm_analysis_     â”‚                       â”‚
â”‚  â”‚   requests         â”‚       â”‚    results         â”‚                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚  â”‚ id (PK)            â”‚       â”‚ id (PK)            â”‚                       â”‚
â”‚  â”‚ session_id (FK)    â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ session_id (FK)    â”‚                       â”‚
â”‚  â”‚ request_json       â”‚       â”‚ root_causes_json   â”‚                       â”‚
â”‚  â”‚ sql_hash           â”‚       â”‚ causal_chains_json â”‚                       â”‚
â”‚  â”‚ profile_hash       â”‚       â”‚ recommendations_   â”‚                       â”‚
â”‚  â”‚ created_at         â”‚       â”‚   json             â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ summary            â”‚                       â”‚
â”‚                               â”‚ hidden_issues_json â”‚                       â”‚
â”‚                               â”‚ confidence_avg     â”‚                       â”‚
â”‚                               â”‚ created_at         â”‚                       â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚ llm_cache          â”‚                                                     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                     â”‚
â”‚  â”‚ id (PK)            â”‚                                                     â”‚
â”‚  â”‚ cache_key (UNIQUE) â”‚                                                     â”‚
â”‚  â”‚ request_hash       â”‚                                                     â”‚
â”‚  â”‚ response_json      â”‚                                                     â”‚
â”‚  â”‚ hit_count          â”‚                                                     â”‚
â”‚  â”‚ created_at         â”‚                                                     â”‚
â”‚  â”‚ expires_at         â”‚                                                     â”‚
â”‚  â”‚ last_accessed_at   â”‚                                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### G.8.2 DDL è¯­å¥

```sql
-- ============================================================================
-- LLM Provider Configuration
-- Stores API configuration for different LLM providers (OpenAI, Azure, DeepSeek, etc.)
-- ============================================================================
CREATE TABLE IF NOT EXISTS llm_providers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,                    -- Provider name, e.g., "openai", "azure", "deepseek"
    display_name TEXT NOT NULL,                   -- Display name, e.g., "OpenAI GPT-4"
    api_base TEXT NOT NULL,                       -- API base URL
    model_name TEXT NOT NULL,                     -- Model name, e.g., "gpt-4o", "deepseek-chat"
    api_key_encrypted TEXT,                       -- Encrypted API key (AES-256)
    is_active BOOLEAN DEFAULT FALSE,              -- â­ Whether this provider is ACTIVE for use (only ONE can be active)
    max_tokens INTEGER DEFAULT 4096,              -- Maximum tokens for response
    temperature REAL DEFAULT 0.3,                 -- Temperature for generation
    timeout_seconds INTEGER DEFAULT 60,           -- Request timeout
    enabled BOOLEAN DEFAULT TRUE,                 -- Whether this provider is enabled (can be activated)
    priority INTEGER DEFAULT 100,                 -- Priority for fallback (lower = higher priority)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    -- Constraint: only one provider can be active at a time (enforced by application)
    CHECK (is_active IN (0, 1))
);

-- Active provider index (for quick lookup)
CREATE INDEX idx_llm_providers_active ON llm_providers(is_active) WHERE is_active = 1;

-- ============================================================================
-- LLM Analysis Sessions
-- Tracks each LLM analysis request for monitoring and debugging
-- ============================================================================
CREATE TABLE IF NOT EXISTS llm_analysis_sessions (
    id TEXT PRIMARY KEY,                          -- UUID
    provider_id INTEGER REFERENCES llm_providers(id),
    query_id TEXT NOT NULL,                       -- StarRocks query ID
    cluster_id INTEGER,                           -- Cluster ID if applicable
    status TEXT NOT NULL DEFAULT 'pending',       -- pending/processing/completed/failed
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    input_tokens INTEGER,                         -- Token count for input
    output_tokens INTEGER,                        -- Token count for output
    latency_ms INTEGER,                           -- Total latency in milliseconds
    error_message TEXT,                           -- Error message if failed
    retry_count INTEGER DEFAULT 0                 -- Number of retries
);

-- Index for query lookup
CREATE INDEX idx_llm_sessions_query ON llm_analysis_sessions(query_id);
CREATE INDEX idx_llm_sessions_status ON llm_analysis_sessions(status, created_at);
CREATE INDEX idx_llm_sessions_cluster ON llm_analysis_sessions(cluster_id, created_at);

-- ============================================================================
-- LLM Analysis Requests
-- Stores the input data sent to LLM (for debugging and replay)
-- ============================================================================
CREATE TABLE IF NOT EXISTS llm_analysis_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL REFERENCES llm_analysis_sessions(id) ON DELETE CASCADE,
    request_json TEXT NOT NULL,                   -- Full request JSON
    sql_hash TEXT NOT NULL,                       -- Hash of SQL statement (for deduplication)
    profile_hash TEXT NOT NULL,                   -- Hash of profile key metrics
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index for cache lookup
CREATE INDEX idx_llm_requests_hash ON llm_analysis_requests(sql_hash, profile_hash);

-- ============================================================================
-- LLM Analysis Results
-- Stores the parsed LLM response
-- ============================================================================
CREATE TABLE IF NOT EXISTS llm_analysis_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL UNIQUE REFERENCES llm_analysis_sessions(id) ON DELETE CASCADE,
    root_causes_json TEXT NOT NULL,               -- JSON array of root causes
    causal_chains_json TEXT NOT NULL,             -- JSON array of causal chains
    recommendations_json TEXT NOT NULL,           -- JSON array of recommendations
    summary TEXT NOT NULL,                        -- Natural language summary
    hidden_issues_json TEXT DEFAULT '[]',         -- JSON array of hidden issues
    confidence_avg REAL,                          -- Average confidence score
    root_cause_count INTEGER,                     -- Number of root causes identified
    recommendation_count INTEGER,                 -- Number of recommendations
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index for analytics
CREATE INDEX idx_llm_results_confidence ON llm_analysis_results(confidence_avg);

-- ============================================================================
-- LLM Response Cache
-- Caches LLM responses to avoid redundant API calls for similar queries
-- ============================================================================
CREATE TABLE IF NOT EXISTS llm_cache (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    cache_key TEXT NOT NULL UNIQUE,               -- Cache key (hash of normalized request)
    request_hash TEXT NOT NULL,                   -- Hash of the request
    response_json TEXT NOT NULL,                  -- Cached response JSON
    hit_count INTEGER DEFAULT 0,                  -- Number of cache hits
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,                -- Cache expiration time
    last_accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index for cache lookup and cleanup
CREATE INDEX idx_llm_cache_key ON llm_cache(cache_key);
CREATE INDEX idx_llm_cache_expires ON llm_cache(expires_at);

-- ============================================================================
-- LLM Usage Statistics (Aggregated)
-- Daily aggregated statistics for monitoring and cost tracking
-- ============================================================================
CREATE TABLE IF NOT EXISTS llm_usage_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date DATE NOT NULL,                           -- Statistics date
    provider_id INTEGER REFERENCES llm_providers(id),
    total_requests INTEGER DEFAULT 0,             -- Total API requests
    successful_requests INTEGER DEFAULT 0,        -- Successful requests
    failed_requests INTEGER DEFAULT 0,            -- Failed requests
    total_input_tokens INTEGER DEFAULT 0,         -- Total input tokens
    total_output_tokens INTEGER DEFAULT 0,        -- Total output tokens
    avg_latency_ms REAL,                          -- Average latency
    cache_hits INTEGER DEFAULT 0,                 -- Cache hit count
    estimated_cost_usd REAL,                      -- Estimated cost in USD
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(date, provider_id)
);

-- Index for date range queries
CREATE INDEX idx_llm_usage_date ON llm_usage_stats(date, provider_id);

-- ============================================================================
-- Triggers for automatic timestamp updates
-- ============================================================================
CREATE TRIGGER IF NOT EXISTS update_llm_providers_timestamp
AFTER UPDATE ON llm_providers
BEGIN
    UPDATE llm_providers SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

-- ============================================================================
-- Views for common queries
-- ============================================================================

-- View: Recent analysis with results
CREATE VIEW IF NOT EXISTS v_recent_llm_analysis AS
SELECT 
    s.id AS session_id,
    s.query_id,
    s.status,
    s.created_at,
    s.latency_ms,
    s.input_tokens + s.output_tokens AS total_tokens,
    r.summary,
    r.confidence_avg,
    r.root_cause_count,
    p.display_name AS provider_name
FROM llm_analysis_sessions s
LEFT JOIN llm_analysis_results r ON s.id = r.session_id
LEFT JOIN llm_providers p ON s.provider_id = p.id
ORDER BY s.created_at DESC
LIMIT 100;

-- View: Provider usage summary
CREATE VIEW IF NOT EXISTS v_llm_provider_usage AS
SELECT 
    p.id,
    p.name,
    p.display_name,
    p.enabled,
    COUNT(s.id) AS total_sessions,
    SUM(CASE WHEN s.status = 'completed' THEN 1 ELSE 0 END) AS completed_sessions,
    SUM(s.input_tokens) AS total_input_tokens,
    SUM(s.output_tokens) AS total_output_tokens,
    AVG(s.latency_ms) AS avg_latency_ms
FROM llm_providers p
LEFT JOIN llm_analysis_sessions s ON p.id = s.provider_id
GROUP BY p.id;
```

#### G.8.3 æ•°æ®è®¿é—®å±‚ (Rust)

```rust
use sqlx::{FromRow, SqlitePool};
use chrono::{DateTime, Utc};
use uuid::Uuid;

/// LLM Provider configuration
#[derive(Debug, FromRow)]
pub struct LLMProvider {
    pub id: i64,
    pub name: String,
    pub display_name: String,
    pub api_base: String,
    pub model_name: String,
    pub api_key_encrypted: Option<String>,
    pub is_default: bool,
    pub max_tokens: i32,
    pub temperature: f64,
    pub timeout_seconds: i32,
    pub enabled: bool,
    pub priority: i32,
}

/// LLM Analysis Session
#[derive(Debug, FromRow)]
pub struct LLMAnalysisSession {
    pub id: String,
    pub provider_id: Option<i64>,
    pub query_id: String,
    pub cluster_id: Option<i64>,
    pub status: String,
    pub created_at: DateTime<Utc>,
    pub completed_at: Option<DateTime<Utc>>,
    pub input_tokens: Option<i32>,
    pub output_tokens: Option<i32>,
    pub latency_ms: Option<i32>,
    pub error_message: Option<String>,
}

/// Repository for LLM data operations
pub struct LLMRepository {
    pool: SqlitePool,
}

impl LLMRepository {
    pub fn new(pool: SqlitePool) -> Self {
        Self { pool }
    }

    /// Get the currently ACTIVE provider (only one can be active)
    pub async fn get_active_provider(&self) -> Result<Option<LLMProvider>, sqlx::Error> {
        sqlx::query_as::<_, LLMProvider>(
            r#"SELECT * FROM llm_providers 
               WHERE is_active = TRUE AND enabled = TRUE 
               LIMIT 1"#
        )
        .fetch_optional(&self.pool)
        .await
    }
    
    /// Activate a provider (deactivates all others)
    pub async fn activate_provider(&self, provider_id: i64) -> Result<(), sqlx::Error> {
        // Deactivate all providers first
        sqlx::query("UPDATE llm_providers SET is_active = FALSE")
            .execute(&self.pool)
            .await?;
        
        // Activate the specified provider
        sqlx::query("UPDATE llm_providers SET is_active = TRUE WHERE id = ? AND enabled = TRUE")
            .bind(provider_id)
            .execute(&self.pool)
            .await?;
        
        Ok(())
    }

    /// Create new analysis session
    pub async fn create_session(
        &self,
        query_id: &str,
        provider_id: i64,
        cluster_id: Option<i64>,
    ) -> Result<String, sqlx::Error> {
        let session_id = Uuid::new_v4().to_string();
        
        sqlx::query(
            r#"INSERT INTO llm_analysis_sessions 
               (id, provider_id, query_id, cluster_id, status) 
               VALUES (?, ?, ?, ?, 'pending')"#
        )
        .bind(&session_id)
        .bind(provider_id)
        .bind(query_id)
        .bind(cluster_id)
        .execute(&self.pool)
        .await?;

        Ok(session_id)
    }

    /// Update session status and metrics
    pub async fn complete_session(
        &self,
        session_id: &str,
        status: &str,
        input_tokens: i32,
        output_tokens: i32,
        latency_ms: i32,
        error_message: Option<&str>,
    ) -> Result<(), sqlx::Error> {
        sqlx::query(
            r#"UPDATE llm_analysis_sessions 
               SET status = ?, completed_at = CURRENT_TIMESTAMP,
                   input_tokens = ?, output_tokens = ?, latency_ms = ?,
                   error_message = ?
               WHERE id = ?"#
        )
        .bind(status)
        .bind(input_tokens)
        .bind(output_tokens)
        .bind(latency_ms)
        .bind(error_message)
        .bind(session_id)
        .execute(&self.pool)
        .await?;

        Ok(())
    }

    /// Save analysis result
    pub async fn save_result(
        &self,
        session_id: &str,
        response: &LLMRootCauseResponse,
    ) -> Result<i64, sqlx::Error> {
        let confidence_avg = if response.root_causes.is_empty() {
            0.0
        } else {
            response.root_causes.iter().map(|r| r.confidence).sum::<f64>() 
                / response.root_causes.len() as f64
        };

        let result = sqlx::query(
            r#"INSERT INTO llm_analysis_results 
               (session_id, root_causes_json, causal_chains_json, recommendations_json,
                summary, hidden_issues_json, confidence_avg, root_cause_count, recommendation_count)
               VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)"#
        )
        .bind(session_id)
        .bind(serde_json::to_string(&response.root_causes)?)
        .bind(serde_json::to_string(&response.causal_chains)?)
        .bind(serde_json::to_string(&response.recommendations)?)
        .bind(&response.summary)
        .bind(serde_json::to_string(&response.hidden_issues)?)
        .bind(confidence_avg)
        .bind(response.root_causes.len() as i32)
        .bind(response.recommendations.len() as i32)
        .execute(&self.pool)
        .await?;

        Ok(result.last_insert_rowid())
    }

    /// Check cache for similar request
    pub async fn get_cached_response(
        &self,
        cache_key: &str,
    ) -> Result<Option<String>, sqlx::Error> {
        let result = sqlx::query_scalar::<_, String>(
            r#"SELECT response_json FROM llm_cache 
               WHERE cache_key = ? AND expires_at > CURRENT_TIMESTAMP"#
        )
        .bind(cache_key)
        .fetch_optional(&self.pool)
        .await?;

        // Update hit count if found
        if result.is_some() {
            sqlx::query(
                r#"UPDATE llm_cache 
                   SET hit_count = hit_count + 1, last_accessed_at = CURRENT_TIMESTAMP
                   WHERE cache_key = ?"#
            )
            .bind(cache_key)
            .execute(&self.pool)
            .await?;
        }

        Ok(result)
    }

    /// Save response to cache
    pub async fn cache_response(
        &self,
        cache_key: &str,
        request_hash: &str,
        response_json: &str,
        ttl_hours: i64,
    ) -> Result<(), sqlx::Error> {
        sqlx::query(
            r#"INSERT OR REPLACE INTO llm_cache 
               (cache_key, request_hash, response_json, expires_at)
               VALUES (?, ?, ?, datetime(CURRENT_TIMESTAMP, '+' || ? || ' hours'))"#
        )
        .bind(cache_key)
        .bind(request_hash)
        .bind(response_json)
        .bind(ttl_hours)
        .execute(&self.pool)
        .await?;

        Ok(())
    }
}
```

### G.9 å®Œæ•´è°ƒç”¨æµç¨‹

```rust
/// Complete LLM-enhanced root cause analysis workflow
pub async fn analyze_with_llm(
    profile: &Profile,
    rule_diagnostics: &[Diagnostic],
    pool: &SqlitePool,
) -> Result<LLMRootCauseResponse, AnalysisError> {
    let repo = LLMRepository::new(pool.clone());
    
    // 1. Get default LLM provider
    let provider = repo.get_active_provider().await?
        .ok_or(AnalysisError::NoProviderConfigured)?;
    
    // 2. Build request
    let request = build_llm_request(profile, rule_diagnostics);
    
    // 3. Check cache
    let cache_key = compute_cache_key(&request);
    if let Some(cached) = repo.get_cached_response(&cache_key).await? {
        return Ok(serde_json::from_str(&cached)?);
    }
    
    // 4. Create session
    let session_id = repo.create_session(
        &profile.summary.query_id,
        provider.id,
        None,
    ).await?;
    
    // 5. Call LLM API
    let start = std::time::Instant::now();
    let analyzer = LLMRootCauseAnalyzer::new(
        &decrypt_api_key(&provider.api_key_encrypted)?,
        &provider.api_base,
        &provider.model_name,
    );
    
    let result = match analyzer.analyze(&request).await {
        Ok(response) => {
            let latency = start.elapsed().as_millis() as i32;
            
            // 6. Save result and update session
            repo.complete_session(
                &session_id,
                "completed",
                estimate_tokens(&request),
                estimate_tokens(&response),
                latency,
                None,
            ).await?;
            
            repo.save_result(&session_id, &response).await?;
            
            // 7. Cache response (24 hour TTL)
            repo.cache_response(
                &cache_key,
                &compute_request_hash(&request),
                &serde_json::to_string(&response)?,
                24,
            ).await?;
            
            response
        }
        Err(e) => {
            repo.complete_session(
                &session_id,
                "failed",
                0, 0, 0,
                Some(&e.to_string()),
            ).await?;
            return Err(e.into());
        }
    };
    
    Ok(result)
}
```

### G.10 è§„åˆ™å¼•æ“ä¸ LLM ç»“æœèåˆè®¾è®¡

#### G.10.1 è®¾è®¡åŸåˆ™

**æ ¸å¿ƒæ€è·¯**: è§„åˆ™å¼•æ“æ˜¯"éª¨æ¶"ï¼ŒLLM æ˜¯"è¡€è‚‰"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è§„åˆ™å¼•æ“ + LLM èåˆæ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         è§„åˆ™å¼•æ“ (Rule Engine)                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  èŒè´£:                                                               â”‚   â”‚
â”‚  â”‚  âœ… å¿«é€Ÿæ£€æµ‹å·²çŸ¥é—®é¢˜ (< 10ms)                                        â”‚   â”‚
â”‚  â”‚  âœ… æä¾›ç¡®å®šæ€§è¯Šæ–­ (100% å‡†ç¡®)                                       â”‚   â”‚
â”‚  â”‚  âœ… ç¦»çº¿å¯ç”¨                                                         â”‚   â”‚
â”‚  â”‚  âœ… é›¶æˆæœ¬                                                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  è¾“å‡º:                                                               â”‚   â”‚
â”‚  â”‚  â€¢ DiagnosticResult (èŠ‚ç‚¹çº§åˆ«è¯Šæ–­)                                   â”‚   â”‚
â”‚  â”‚  â€¢ AggregatedDiagnostic (èšåˆè¯Šæ–­)                                   â”‚   â”‚
â”‚  â”‚  â€¢ suggestions (å‚æ•°è°ƒæ•´å»ºè®®)                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           LLM å¢å¼ºå±‚                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  èŒè´£:                                                               â”‚   â”‚
â”‚  â”‚  ğŸ”¥ è¯†åˆ«è§„åˆ™æœªè¦†ç›–çš„éšå¼æ ¹å›                                           â”‚   â”‚
â”‚  â”‚  ğŸ”¥ å»ºç«‹è¯Šæ–­ä¹‹é—´çš„å› æœå…³ç³»                                            â”‚   â”‚
â”‚  â”‚  ğŸ”¥ ç”Ÿæˆé’ˆå¯¹æ€§ SQL ä¼˜åŒ–å»ºè®®                                           â”‚   â”‚
â”‚  â”‚  ğŸ”¥ è‡ªç„¶è¯­è¨€è§£é‡Š                                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  è¾“å‡º:                                                               â”‚   â”‚
â”‚  â”‚  â€¢ root_causes (æ ¹å› åˆ—è¡¨ï¼Œå«éšå¼)                                    â”‚   â”‚
â”‚  â”‚  â€¢ causal_chains (å› æœé“¾)                                            â”‚   â”‚
â”‚  â”‚  â€¢ recommendations (å« SQL ç¤ºä¾‹)                                     â”‚   â”‚
â”‚  â”‚  â€¢ summary (è‡ªç„¶è¯­è¨€æ€»ç»“)                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          ç»“æœèåˆå™¨ (Merger)                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1. å»ºè®®å»é‡: è§„åˆ™å»ºè®® âˆª LLM å»ºè®®ï¼Œå»é™¤é‡å¤                          â”‚   â”‚
â”‚  â”‚  2. ä¼˜å…ˆçº§æ’åº: æ ¹å› é—®é¢˜ä¼˜å…ˆï¼Œç—‡çŠ¶é—®é¢˜æ¬¡ä¹‹                            â”‚   â”‚
â”‚  â”‚  3. ç½®ä¿¡åº¦æ ‡æ³¨: è§„åˆ™=100%, LLM=confidence                            â”‚   â”‚
â”‚  â”‚  4. æ¥æºæ ‡è®°: æ ‡è®°æ¯æ¡å»ºè®®çš„æ¥æº (rule/llm/both)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### G.10.2 èåˆåçš„ API å“åº”ç»“æ„

```rust
/// Enhanced Profile Analysis Response (with LLM)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct EnhancedProfileAnalysisResponse {
    // ========== åŸæœ‰å­—æ®µ (æ¥è‡ªè§„åˆ™å¼•æ“) ==========
    pub hotspots: Vec<HotSpot>,
    pub conclusion: String,
    pub suggestions: Vec<String>,
    pub performance_score: f64,
    pub execution_tree: Option<ExecutionTree>,
    pub summary: Option<ProfileSummary>,
    /// Rule-based diagnostics (all)
    pub diagnostics: Vec<DiagnosticResult>,
    /// Aggregated diagnostics for overview
    pub aggregated_diagnostics: Vec<AggregatedDiagnostic>,
    /// Node-level diagnostics (plan_node_id -> diagnostics)
    pub node_diagnostics: HashMap<i32, Vec<DiagnosticResult>>,
    pub fragments: Vec<Fragment>,
    
    // ========== æ–°å¢å­—æ®µ (æ¥è‡ª LLM) ==========
    /// LLM-enhanced root cause analysis (optional, async loaded)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub llm_analysis: Option<LLMAnalysisResult>,
}

/// LLM Analysis Result (merged with rule engine)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct LLMAnalysisResult {
    /// Whether LLM analysis is available
    pub available: bool,
    /// LLM analysis status: "pending" | "completed" | "failed" | "disabled"
    pub status: String,
    /// Root causes (may include implicit ones not detected by rules)
    #[serde(default)]
    pub root_causes: Vec<MergedRootCause>,
    /// Causal chains with explanations
    #[serde(default)]
    pub causal_chains: Vec<CausalChain>,
    /// Merged recommendations (rule + LLM, deduplicated)
    #[serde(default)]
    pub merged_recommendations: Vec<MergedRecommendation>,
    /// Natural language summary
    #[serde(default)]
    pub summary: String,
    /// Hidden issues detected by LLM only
    #[serde(default)]
    pub hidden_issues: Vec<HiddenIssue>,
}

/// Merged root cause (from rule engine and/or LLM)
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MergedRootCause {
    /// Unique identifier
    pub id: String,
    /// Related rule IDs (if detected by rules)
    pub related_rule_ids: Vec<String>,
    /// Description
    pub description: String,
    /// Is this an implicit root cause (not detected by rules)?
    pub is_implicit: bool,
    /// Confidence score (1.0 for rule-based, 0.0-1.0 for LLM)
    pub confidence: f64,
    /// Source: "rule" | "llm" | "both"
    pub source: String,
    /// Evidence
    pub evidence: Vec<String>,
    /// Symptoms caused by this root cause
    pub symptoms: Vec<String>,
}

/// Merged recommendation
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MergedRecommendation {
    /// Priority (1 = highest)
    pub priority: u32,
    /// Action description
    pub action: String,
    /// Expected improvement
    pub expected_improvement: String,
    /// SQL example (if applicable)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub sql_example: Option<String>,
    /// Source: "rule" | "llm" | "both"
    pub source: String,
    /// Related root cause IDs
    pub related_root_causes: Vec<String>,
    /// Is this a root cause fix (vs symptom fix)?
    pub is_root_cause_fix: bool,
}
```

#### G.10.3 å»ºè®®èåˆç®—æ³•

```rust
/// Merge rule engine suggestions with LLM recommendations
pub fn merge_recommendations(
    rule_diagnostics: &[AggregatedDiagnostic],
    llm_response: &LLMRootCauseResponse,
) -> Vec<MergedRecommendation> {
    let mut merged: Vec<MergedRecommendation> = Vec::new();
    let mut seen_actions: HashSet<String> = HashSet::new();
    
    // 1. First, add LLM root cause recommendations (highest priority)
    for (idx, rec) in llm_response.recommendations.iter().enumerate() {
        let action_key = normalize_action(&rec.action);
        if !seen_actions.contains(&action_key) {
            seen_actions.insert(action_key.clone());
            merged.push(MergedRecommendation {
                priority: (idx + 1) as u32,
                action: rec.action.clone(),
                expected_improvement: rec.expected_improvement.clone(),
                sql_example: rec.sql_example.clone(),
                source: "llm".to_string(),
                related_root_causes: vec![],  // TODO: link to root causes
                is_root_cause_fix: true,
            });
        }
    }
    
    // 2. Add rule engine suggestions (if not already covered by LLM)
    let mut rule_priority = merged.len() as u32 + 1;
    for diag in rule_diagnostics {
        for suggestion in &diag.suggestions {
            let action_key = normalize_action(suggestion);
            if !seen_actions.contains(&action_key) {
                seen_actions.insert(action_key.clone());
                merged.push(MergedRecommendation {
                    priority: rule_priority,
                    action: suggestion.clone(),
                    expected_improvement: "".to_string(),
                    sql_example: None,
                    source: "rule".to_string(),
                    related_root_causes: vec![diag.rule_id.clone()],
                    is_root_cause_fix: false,  // Rule suggestions are often symptom-level
                });
                rule_priority += 1;
            } else {
                // Action exists, mark as "both"
                if let Some(existing) = merged.iter_mut().find(|r| normalize_action(&r.action) == action_key) {
                    existing.source = "both".to_string();
                }
            }
        }
    }
    
    // 3. Sort by priority
    merged.sort_by_key(|r| r.priority);
    
    merged
}

/// Normalize action text for deduplication
fn normalize_action(action: &str) -> String {
    action.to_lowercase()
        .replace(" ", "")
        .replace("_", "")
        .chars()
        .filter(|c| c.is_alphanumeric())
        .collect()
}
```

### G.11 å‰ç«¯å±•ç¤ºè®¾è®¡

#### G.11.1 å±•ç¤ºä½ç½®è¯´æ˜

**é—®é¢˜**: æ ¹å› åˆ†æç»“æœåœ¨"æ€»è§ˆ"å’Œ"ç‚¹å‡»èŠ‚ç‚¹"æ—¶éƒ½å±•ç¤ºå—ï¼Ÿ

**ç­”æ¡ˆ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±•ç¤ºé€»è¾‘                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    æ€»è§ˆé¡µ (Overview Tab)                             â”‚   â”‚
â”‚  â”‚                    æœªé€‰æ‹©ä»»ä½• DAG èŠ‚ç‚¹æ—¶                               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æ˜¾ç¤ºå†…å®¹:                                                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ” æ ¹å› åˆ†æ (Root Cause Analysis)                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ”´ æ ¹å›  1: ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ (ç½®ä¿¡åº¦: 85%) [LLM]                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â””â”€â”€ å¯¼è‡´: J002 Joiné¡ºåºä¸ä¼˜, J005 Broadcastè¡¨è¿‡å¤§         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸŸ¡ æ ¹å›  2: åˆ†æ¡¶é”®é€‰æ‹©ä¸å½“ (ç½®ä¿¡åº¦: 100%) [Rule]               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    â””â”€â”€ å¯¼è‡´: S001 æ•°æ®å€¾æ–œ                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ“Š å› æœå›¾: [å¯è§†åŒ–å±•ç¤º]                                       â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ’¡ ä¼˜åŒ–å»ºè®® (æŒ‰ä¼˜å…ˆçº§æ’åº)                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 1. [æ ¹å› ] ANALYZE TABLE orders; [LLM] â­                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 2. [æ ¹å› ] ä¿®æ”¹åˆ†æ¡¶é”®ä¸º order_date [Rule+LLM] â­              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 3. [ç—‡çŠ¶] å¢åŠ  JOIN å¹¶è¡Œåº¦ [Rule]                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ 4. [ç—‡çŠ¶] å¯ç”¨ Runtime Filter [Rule]                         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â­ = è§£å†³æ ¹å› çš„å»ºè®® (ä¼˜å…ˆæ‰§è¡Œ)                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    èŠ‚ç‚¹è¯¦æƒ… (Node Detail)                            â”‚   â”‚
â”‚  â”‚                    ç‚¹å‡» DAG æ ‘ä¸­æŸä¸ªèŠ‚ç‚¹æ—¶                            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  æ˜¾ç¤ºå†…å®¹:                                                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ“ èŠ‚ç‚¹: HASH_JOIN (plan_node_id: 5)                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ” è¯¥èŠ‚ç‚¹çš„è¯Šæ–­é—®é¢˜:                                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ âš ï¸ J002: Join é¡ºåºå¯èƒ½ä¸ä¼˜                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    åŸå› : å°è¡¨åœ¨å·¦ä¾§ï¼Œå¤§è¡¨åœ¨å³ä¾§                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    è¯æ®: left_rows=1000, right_rows=10000000                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ âš ï¸ J005: Broadcast è¡¨è¿‡å¤§                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    åŸå› : Broadcast æ•°æ®é‡ > 100MB                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    è¯æ®: broadcast_bytes=500MB                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ’¡ å»ºè®®:                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ANALYZE TABLE xxx; (æ›´æ–°ç»Ÿè®¡ä¿¡æ¯)                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ SET broadcast_row_limit = 500000; (è°ƒæ•´é˜ˆå€¼)               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ”— å…³è”æ ¹å› : ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ (æŸ¥çœ‹æ€»è§ˆ)                          â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### G.11.2 æ€»è§ˆ vs èŠ‚ç‚¹è¯¦æƒ…çš„åŒºåˆ«

| ç»´åº¦ | æ€»è§ˆé¡µ (Overview) | èŠ‚ç‚¹è¯¦æƒ… (Node Detail) |
|------|------------------|----------------------|
| **è§¦å‘æ¡ä»¶** | æœªé€‰æ‹©èŠ‚ç‚¹ / ç‚¹å‡»"æ€»è§ˆ"æŒ‰é’® | ç‚¹å‡» DAG æ ‘ä¸­çš„èŠ‚ç‚¹ |
| **æ ¹å› åˆ†æ** | âœ… æ˜¾ç¤ºå…¨å±€æ ¹å›  (å« LLM) | âŒ ä¸æ˜¾ç¤º (é“¾æ¥åˆ°æ€»è§ˆ) |
| **å› æœå›¾** | âœ… æ˜¾ç¤ºå®Œæ•´å› æœå›¾ | âŒ ä¸æ˜¾ç¤º |
| **è¯Šæ–­é—®é¢˜** | âœ… èšåˆæ˜¾ç¤º (aggregated_diagnostics) | âœ… æ˜¾ç¤ºè¯¥èŠ‚ç‚¹çš„è¯Šæ–­ (node_diagnostics[id]) |
| **å»ºè®®** | âœ… å…¨å±€å»ºè®® (merged_recommendations) | âœ… èŠ‚ç‚¹çº§åˆ«å»ºè®® (è¯Šæ–­çš„ suggestions) |
| **æ•°æ®æ¥æº** | aggregated_diagnostics + llm_analysis | node_diagnostics[plan_node_id] |

#### G.11.3 å‰ç«¯æ•°æ®æµ

```typescript
// Angular Service
@Injectable()
export class ProfileAnalysisService {
  
  // Step 1: è·å–åŸºç¡€åˆ†æç»“æœ (è§„åˆ™å¼•æ“ï¼ŒåŒæ­¥)
  analyzeProfile(profileText: string): Observable<ProfileAnalysisResponse> {
    return this.http.post<ProfileAnalysisResponse>('/api/v1/profile/analyze', {
      profile_text: profileText
    });
  }
  
  // Step 2: å¼‚æ­¥è·å– LLM å¢å¼ºåˆ†æ (å¯é€‰)
  getLLMAnalysis(queryId: string): Observable<LLMAnalysisResult> {
    return this.http.get<LLMAnalysisResult>(`/api/v1/llm/analysis/${queryId}`);
  }
}

// Component Logic
export class ProfileDiagnosticComponent {
  analysisResult: ProfileAnalysisResponse;
  llmAnalysis: LLMAnalysisResult | null = null;
  selectedNodeId: number | null = null;
  
  // åŠ è½½åˆ†æç»“æœ
  async loadAnalysis(profileText: string) {
    // 1. å…ˆåŠ è½½è§„åˆ™å¼•æ“ç»“æœ (å¿«ï¼Œ< 100ms)
    this.analysisResult = await this.service.analyzeProfile(profileText).toPromise();
    
    // 2. å¼‚æ­¥åŠ è½½ LLM åˆ†æ (æ…¢ï¼Œ1-5sï¼Œå¯é€‰)
    if (this.llmEnabled) {
      this.llmAnalysis = { status: 'pending', available: false };
      this.service.getLLMAnalysis(this.analysisResult.summary.queryId)
        .subscribe(
          result => this.llmAnalysis = result,
          error => this.llmAnalysis = { status: 'failed', available: false }
        );
    }
  }
  
  // è·å–å½“å‰æ˜¾ç¤ºçš„è¯Šæ–­
  get currentDiagnostics(): DiagnosticResult[] {
    if (this.selectedNodeId === null) {
      // æ€»è§ˆ: è¿”å›èšåˆè¯Šæ–­ (ç”¨äºæ˜¾ç¤º)
      return [];  // ä½¿ç”¨ aggregated_diagnostics
    } else {
      // èŠ‚ç‚¹è¯¦æƒ…: è¿”å›è¯¥èŠ‚ç‚¹çš„è¯Šæ–­
      return this.analysisResult.node_diagnostics[this.selectedNodeId] || [];
    }
  }
  
  // è·å–å½“å‰æ˜¾ç¤ºçš„å»ºè®®
  get currentSuggestions(): MergedRecommendation[] {
    if (this.selectedNodeId === null) {
      // æ€»è§ˆ: è¿”å›èåˆåçš„å…¨å±€å»ºè®®
      return this.llmAnalysis?.merged_recommendations || 
             this.flattenRuleSuggestions();
    } else {
      // èŠ‚ç‚¹è¯¦æƒ…: è¿”å›è¯¥èŠ‚ç‚¹è¯Šæ–­çš„å»ºè®®
      return this.currentDiagnostics.flatMap(d => d.suggestions);
    }
  }
  
  // æ˜¯å¦æ˜¾ç¤ºæ ¹å› åˆ†æ
  get showRootCauseAnalysis(): boolean {
    return this.selectedNodeId === null && 
           this.llmAnalysis?.available === true;
  }
}
```

#### G.11.4 UI ç»„ä»¶ç»“æ„ (ngx-admin é£æ ¼)

```typescript
// profile-diagnostic.component.ts
@Component({
  selector: 'app-profile-diagnostic',
  template: `
    <nb-card>
      <nb-card-header>
        <span>è¯Šæ–­åˆ†æ</span>
        <nb-badge *ngIf="llmAnalysis?.status === 'pending'" 
                  status="warning" text="AI åˆ†æä¸­..."></nb-badge>
      </nb-card-header>
      
      <nb-card-body>
        <!-- æ€»è§ˆæ¨¡å¼ -->
        <ng-container *ngIf="!selectedNodeId">
          
          <!-- æ ¹å› åˆ†æå¡ç‰‡ (LLM) -->
          <nb-card *ngIf="showRootCauseAnalysis" accent="primary">
            <nb-card-header>ğŸ” æ ¹å› åˆ†æ</nb-card-header>
            <nb-card-body>
              <app-root-cause-list 
                [rootCauses]="llmAnalysis.root_causes">
              </app-root-cause-list>
              <app-causal-graph 
                [chains]="llmAnalysis.causal_chains">
              </app-causal-graph>
            </nb-card-body>
          </nb-card>
          
          <!-- è¯Šæ–­é—®é¢˜åˆ—è¡¨ (èšåˆ) -->
          <nb-card>
            <nb-card-header>âš ï¸ è¯Šæ–­é—®é¢˜</nb-card-header>
            <nb-card-body>
              <app-aggregated-diagnostic-list
                [diagnostics]="analysisResult.aggregated_diagnostics">
              </app-aggregated-diagnostic-list>
            </nb-card-body>
          </nb-card>
          
          <!-- ä¼˜åŒ–å»ºè®® (èåˆ) -->
          <nb-card accent="success">
            <nb-card-header>ğŸ’¡ ä¼˜åŒ–å»ºè®®</nb-card-header>
            <nb-card-body>
              <app-recommendation-list
                [recommendations]="currentSuggestions"
                [showSource]="true">
              </app-recommendation-list>
            </nb-card-body>
          </nb-card>
          
        </ng-container>
        
        <!-- èŠ‚ç‚¹è¯¦æƒ…æ¨¡å¼ -->
        <ng-container *ngIf="selectedNodeId">
          <app-node-diagnostic-detail
            [nodeId]="selectedNodeId"
            [diagnostics]="currentDiagnostics"
            (viewRootCause)="clearSelection()">
          </app-node-diagnostic-detail>
        </ng-container>
        
      </nb-card-body>
    </nb-card>
  `
})
export class ProfileDiagnosticComponent { }
```

### G.12 v7.0 vs ä¹‹å‰ç‰ˆæœ¬å¯¹æ¯”

| ç»´åº¦ | v6.0 (è§„åˆ™é©±åŠ¨) | v7.0 (LLMå¢å¼º) |
|------|----------------|----------------|
| **éšå¼æ ¹å› è¯†åˆ«** | éœ€è¦æ‰‹å†™è§„åˆ™ | âœ… å¼€æ”¾åŸŸæ¨ç† |
| **SQL ä¼˜åŒ–å»ºè®®** | é€šç”¨æ¨¡æ¿ | âœ… é’ˆå¯¹æ€§ SQL ç¤ºä¾‹ |
| **å› æœè§£é‡Š** | æ¨¡æ¿åŒ–æ–‡æœ¬ | âœ… è‡ªç„¶è¯­è¨€è§£é‡Š |
| **ä¸šåŠ¡ç†è§£** | âŒ | âœ… å¯ç†è§£ä¸šåŠ¡è¯­ä¹‰ |
| **å­¦ä¹ èƒ½åŠ›** | âŒ | âœ… å¯ä»åé¦ˆä¸­æ”¹è¿› |
| **å»¶è¿Ÿ** | < 10ms | 1-5s (å¯ç¼“å­˜) |
| **æˆæœ¬** | å…è´¹ | æŒ‰ Token è®¡è´¹ |
| **ç¦»çº¿å¯ç”¨** | âœ… | âŒ éœ€è¦ç½‘ç»œ |

### G.13 å®æ–½è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| **Phase 1** | SQLite è¡¨ç»“æ„å®ç° | 1 å¤© | P0 |
| **Phase 2** | LLM æœåŠ¡æŠ½è±¡å±‚ (Trait) | 0.5 å¤© | P0 |
| **Phase 3** | LLM å®¢æˆ·ç«¯å°è£… (async-openai) | 1 å¤© | P0 |
| **Phase 4** | è¯·æ±‚/å“åº”æ•°æ®ç»“æ„ | 1 å¤© | P0 |
| **Phase 5** | è§„åˆ™å¼•æ“ + LLM ç»“æœèåˆ | 1.5 å¤© | P0 |
| **Phase 6** | ç¼“å­˜å’ŒæŒä¹…åŒ– | 1 å¤© | P1 |
| **Phase 7** | API ç«¯ç‚¹å®ç° | 1 å¤© | P1 |
| **Phase 8** | å‰ç«¯é›†æˆ (ngx-admin) | 2 å¤© | P1 |
| **Phase 9** | æµ‹è¯•å’Œè°ƒä¼˜ | 1 å¤© | P1 |
| **æ€»è®¡** | | **11 å¤©** |

### G.14 é…ç½®ç¤ºä¾‹

```toml
# config.toml
[llm]
enabled = true
default_provider = "deepseek"
cache_ttl_hours = 24
max_retries = 3

[llm.providers.deepseek]
name = "deepseek"
display_name = "DeepSeek Chat"
api_base = "https://api.deepseek.com/v1"
model_name = "deepseek-chat"
# API key from environment: DEEPSEEK_API_KEY
max_tokens = 4096
temperature = 0.3
timeout_seconds = 60
priority = 1

[llm.providers.openai]
name = "openai"
display_name = "OpenAI GPT-4o"
api_base = "https://api.openai.com/v1"
model_name = "gpt-4o"
# API key from environment: OPENAI_API_KEY
max_tokens = 4096
temperature = 0.3
timeout_seconds = 60
priority = 2
```

---

### G.15 Profile åˆ†æè‡ªåŠ¨è°ƒç”¨ LLM æµç¨‹

#### G.15.1 è‡ªåŠ¨é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Profile åˆ†æè‡ªåŠ¨è°ƒç”¨ LLM æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  GET /api/clusters/profiles/:query_id/analyze                              â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. è§„åˆ™å¼•æ“åˆ†æ (åŒæ­¥, < 50ms)                                        â”‚   â”‚
â”‚  â”‚    - ProfileComposer::parse()                                         â”‚   â”‚
â”‚  â”‚    - RuleEngine::analyze()                                           â”‚   â”‚
â”‚  â”‚    - RootCauseAnalyzer::analyze() (v5.0 rule-based)                  â”‚   â”‚
â”‚  â”‚    - è¾“å‡º: ProfileAnalysisResponse (without llm_analysis)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. æ£€æŸ¥ LLM æ¡ä»¶                                                       â”‚   â”‚
â”‚  â”‚    - llm_service.is_available() == true                              â”‚   â”‚
â”‚  â”‚    - aggregated_diagnostics.len() > 0                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”œâ”€â”€ æ¡ä»¶ä¸æ»¡è¶³ â”€â”€â–¶ ç›´æ¥è¿”å› ProfileAnalysisResponse                   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼ æ¡ä»¶æ»¡è¶³                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. æ„å»º LLM è¯·æ±‚ (enhance_with_llm)                                   â”‚   â”‚
â”‚  â”‚    - ä» ProfileSummary æå–æŸ¥è¯¢ä¿¡æ¯                                    â”‚   â”‚
â”‚  â”‚    - ä» ExecutionTree æå–çƒ­ç‚¹èŠ‚ç‚¹                                     â”‚   â”‚
â”‚  â”‚    - ä» AggregatedDiagnostic è½¬æ¢è¯Šæ–­ç»“æœ                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. è°ƒç”¨ LLM æœåŠ¡ (å¼‚æ­¥, 1-10s)                                         â”‚   â”‚
â”‚  â”‚    - æ£€æŸ¥ç¼“å­˜ (cache_key)                                             â”‚   â”‚
â”‚  â”‚    - ç¼“å­˜å‘½ä¸­: ç›´æ¥è¿”å›                                                 â”‚   â”‚
â”‚  â”‚    - ç¼“å­˜æœªå‘½ä¸­: è°ƒç”¨ LLM API                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 5. ç»“æœèåˆ (merge_root_causes + merge_recommendations)              â”‚   â”‚
â”‚  â”‚    - LLM æ ¹å› ä¼˜å…ˆ (å¯èƒ½åŒ…å«éšå¼æ ¹å› )                                    â”‚   â”‚
â”‚  â”‚    - è§„åˆ™è¯Šæ–­è¡¥å…… (æœªè¢«è¦†ç›–çš„ç‹¬ç«‹é—®é¢˜)                                  â”‚   â”‚
â”‚  â”‚    - å»ºè®®å»é‡åˆå¹¶ (æ ‡è®°æ¥æº: rule/llm/both)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 6. è¿”å›å¢å¼ºåçš„ ProfileAnalysisResponse                               â”‚   â”‚
â”‚  â”‚    - llm_analysis.available = true                                   â”‚   â”‚
â”‚  â”‚    - llm_analysis.status = "completed"                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å¤±è´¥å¤„ç†:                                                                   â”‚
â”‚  - LLM è°ƒç”¨å¤±è´¥: llm_analysis.status = "failed: <error>"                    â”‚
â”‚  - è§„åˆ™å¼•æ“ç»“æœä»ç„¶è¿”å›ï¼Œç”¨æˆ·ä½“éªŒä¸ä¸­æ–­                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### G.15.2 å‘é€ç»™ LLM çš„æ•°æ®æ ¼å¼

ä» Profile åˆ†æç»“æœæ„å»ºçš„ LLM è¯·æ±‚æ•°æ®ç»“æ„ï¼š

```json
{
  "query_summary": {
    "sql_statement": "SELECT ... (æˆªæ–­è‡³2000å­—ç¬¦)",
    "query_type": "SELECT",
    "total_time_seconds": 15.5,
    "scan_bytes": 1073741824,
    "output_rows": 10000,
    "be_count": 5,
    "has_spill": true,
    "session_variables": {}
  },
  "execution_plan": {
    "dag_description": "OLAP_SCAN -> HASH_JOIN -> AGGREGATE -> SORT -> RESULT_SINK",
    "hotspot_nodes": [
      {
        "operator": "HASH_JOIN",
        "plan_node_id": 2,
        "time_percentage": 45.0,
        "key_metrics": {
          "ProbeRows": "100000000",
          "BuildRows": "5000000",
          "HashTableSize": "4.5GB"
        },
        "upstream_operators": []
      }
    ]
  },
  "rule_diagnostics": [
    {
      "rule_id": "S001",
      "severity": "Warning",
      "operator": "OLAP_SCAN",
      "plan_node_id": 1,
      "message": "æ•°æ®å€¾æ–œ: max/avg = 3.5 (3ä¸ªèŠ‚ç‚¹)",
      "evidence": {
        "reason": "æ‰«æè¡Œæ•°ä¸å‡: max=100M, min=5M, avg=20M",
        "affected_nodes": "OLAP_SCAN/plan_node_1, OLAP_SCAN/plan_node_3, ..."
      }
    },
    {
      "rule_id": "Q003",
      "severity": "Error",
      "operator": "AGGREGATE",
      "plan_node_id": 4,
      "message": "è§¦å‘ Spill (1ä¸ªèŠ‚ç‚¹)",
      "evidence": {
        "reason": "Spillæ•°æ®é‡: 2.5GB",
        "affected_nodes": "AGGREGATE/plan_node_4"
      }
    }
  ],
  "key_metrics": {}
}
```

#### G.15.3 LLM è¿”å›æ•°æ®æ ¼å¼

```json
{
  "root_causes": [
    {
      "root_cause_id": "RC001",
      "description": "åˆ†æ¡¶é”®ä¸åˆç†å¯¼è‡´æ•°æ®å€¾æ–œ",
      "confidence": 0.9,
      "evidence": ["S001æ˜¾ç¤ºå€¾æ–œæ¯”3.5", "Q003æ˜¾ç¤ºSpillæ˜¯å€¾æ–œçš„ä¸‹æ¸¸å½±å“"],
      "symptoms": ["S001", "Q003", "G002"],
      "is_implicit": false
    }
  ],
  "causal_chains": [
    {
      "chain": ["åˆ†æ¡¶é”®ä¸åˆç†", "â†’", "æ•°æ®å€¾æ–œ", "â†’", "å†…å­˜å‹åŠ›", "â†’", "Spill"],
      "explanation": "æ•°æ®å€¾æ–œå¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ï¼Œæœ€ç»ˆè§¦å‘Spill"
    }
  ],
  "recommendations": [
    {
      "priority": 1,
      "action": "ä¼˜åŒ–åˆ†æ¡¶é”®è®¾è®¡",
      "expected_improvement": "å‡å°‘å€¾æ–œ50%ä»¥ä¸Š",
      "sql_example": "ALTER TABLE orders SET (\"bucketing_column\" = \"order_id\");"
    }
  ],
  "summary": "æ ¹æœ¬åŸå› æ˜¯åˆ†æ¡¶é”®è®¾è®¡ä¸åˆç†å¯¼è‡´çš„æ•°æ®å€¾æ–œ...",
  "hidden_issues": [
    {
      "issue": "ç»Ÿè®¡ä¿¡æ¯å¯èƒ½è¿‡æœŸ",
      "suggestion": "æ‰§è¡Œ ANALYZE TABLE æ›´æ–°ç»Ÿè®¡ä¿¡æ¯"
    }
  ]
}
```

#### G.15.4 ç¼“å­˜ç­–ç•¥

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| ç¼“å­˜é”® | `cache_key = hash(sql_hash + profile_hash)` |
| ç¼“å­˜ TTL | é»˜è®¤ 24 å°æ—¶ (å¯é…ç½®) |
| ç¼“å­˜å‘½ä¸­ | ç›¸åŒ SQL + ç›¸åŒ Profile æŒ‡æ ‡ â†’ ç›´æ¥è¿”å›ç¼“å­˜ |
| ç¼“å­˜æ›´æ–° | æ¯æ¬¡å‘½ä¸­æ›´æ–° `hit_count` å’Œ `last_accessed_at` |
| ç¼“å­˜æ¸…ç† | å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸç¼“å­˜ |

---

**æ–‡æ¡£æ›´æ–°å®Œæˆ**

å˜æ›´è®°å½•:
- v7.0 (2024-12-08): æ–°å¢ LLM å¢å¼ºè®¾è®¡
  - G.2: LLM æœåŠ¡æŠ½è±¡å±‚è®¾è®¡ (Trait, æ”¯æŒå¤šåœºæ™¯)
  - G.3: LLM å¢å¼ºæ¶æ„å›¾
  - G.4: Rust LLM åº“é€‰å‹ (async-openai)
  - G.5: LLM API è¯·æ±‚/å“åº”è®¾è®¡
  - G.6: System Prompt è®¾è®¡
  - G.7: LLM å®¢æˆ·ç«¯å®ç°
  - G.8: SQLite æ•°æ®è¡¨è®¾è®¡ (7 å¼ è¡¨ + æµç¨‹è¯´æ˜)
    - ä¿®æ”¹ is_default â†’ is_active (æ”¯æŒå•ä¸€æ¿€æ´»)
  - G.9: å®Œæ•´è°ƒç”¨æµç¨‹
  - G.10: è§„åˆ™å¼•æ“ä¸ LLM ç»“æœèåˆè®¾è®¡
  - G.11: å‰ç«¯å±•ç¤ºè®¾è®¡ (æ€»è§ˆ vs èŠ‚ç‚¹è¯¦æƒ…)
  - G.12: v7.0 vs ä¹‹å‰ç‰ˆæœ¬å¯¹æ¯”
  - G.13: å®æ–½è®¡åˆ’ (11 å¤©)
  - G.14: é…ç½®ç¤ºä¾‹
- v7.1 (2024-12-08): Profile åˆ†æè‡ªåŠ¨è°ƒç”¨ LLM
  - G.15: Profile åˆ†æè‡ªåŠ¨è°ƒç”¨ LLM æµç¨‹
    - G.15.1: è‡ªåŠ¨é›†æˆæ¶æ„å›¾
    - G.15.2: å‘é€ç»™ LLM çš„æ•°æ®æ ¼å¼
    - G.15.3: LLM è¿”å›æ•°æ®æ ¼å¼
    - G.15.4: ç¼“å­˜ç­–ç•¥
