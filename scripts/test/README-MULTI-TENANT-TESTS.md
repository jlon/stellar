# Multi-Tenant API Testing Scripts

## ğŸ“‹ æ¦‚è¿°

è¿™äº›è„šæœ¬ç”¨äºæµ‹è¯• Stellar çš„å¤šç§Ÿæˆ·åŠŸèƒ½ï¼Œè¦†ç›–ä¸‰ç§ç”¨æˆ·è§’è‰²çš„å®Œæ•´æ“ä½œæµç¨‹ã€‚

## ğŸ¯ æµ‹è¯•è§’è‰²

### 1. è¶…çº§ç®¡ç†å‘˜ (Super Admin)
- **ç”¨æˆ·å**: `admin`
- **å¯†ç **: `admin`
- **æƒé™**: å®Œå…¨æ§åˆ¶ï¼Œå¯ä»¥åˆ›å»ºç»„ç»‡ã€ç®¡ç†æ‰€æœ‰èµ„æºã€è·¨ç»„ç»‡æ“ä½œ

### 2. ç»„ç»‡ç®¡ç†å‘˜ (Organization Admin)
- **ç”¨æˆ·å**: `alpha_admin` / `beta_admin`
- **å¯†ç **: `Alpha@123` / `Beta@123`
- **æƒé™**: åªèƒ½ç®¡ç†æ‰€å±ç»„ç»‡çš„èµ„æºï¼Œæ— æ³•è®¿é—®å…¶ä»–ç»„ç»‡

### 3. æ™®é€šç”¨æˆ· (Regular User)
- **ç”¨æˆ·å**: `alpha_user1`
- **å¯†ç **: `User@123`
- **æƒé™**: æœ€å°æƒé™ï¼Œåªèƒ½è®¿é—®è¢«æˆæƒçš„èµ„æº

## ğŸ“ æµ‹è¯•è„šæœ¬

```
scripts/test/
â”œâ”€â”€ test-multi-tenant-super-admin.sh    # è¶…çº§ç®¡ç†å‘˜æµ‹è¯•
â”œâ”€â”€ test-multi-tenant-org-admin.sh      # ç»„ç»‡ç®¡ç†å‘˜æµ‹è¯•
â”œâ”€â”€ test-multi-tenant-regular-user.sh   # æ™®é€šç”¨æˆ·æµ‹è¯•
â””â”€â”€ test-multi-tenant-all.sh            # ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ææ¡ä»¶

1. åç«¯æœåŠ¡è¿è¡Œåœ¨ `http://localhost:8081`
2. ä½¿ç”¨é»˜è®¤è¶…çº§ç®¡ç†å‘˜è´¦å· (`admin/admin`)
3. å·²å®‰è£… `curl` å’Œ `python3`

### æ–¹å¼ä¸€ï¼šä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd /home/oppo/Documents/stellar/scripts/test
./test-multi-tenant-all.sh
```

### æ–¹å¼äºŒï¼šå•ç‹¬è¿è¡Œæµ‹è¯•

```bash
# 1. è¿è¡Œè¶…çº§ç®¡ç†å‘˜æµ‹è¯•ï¼ˆåˆ›å»ºåŸºç¡€è®¾æ–½ï¼‰
./test-multi-tenant-super-admin.sh

# 2. è¿è¡Œç»„ç»‡ç®¡ç†å‘˜æµ‹è¯•ï¼ˆéªŒè¯ç»„ç»‡éš”ç¦»ï¼‰
./test-multi-tenant-org-admin.sh

# 3. è¿è¡Œæ™®é€šç”¨æˆ·æµ‹è¯•ï¼ˆéªŒè¯æƒé™é™åˆ¶ï¼‰
./test-multi-tenant-regular-user.sh
```

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### è¶…çº§ç®¡ç†å‘˜æµ‹è¯• (test-multi-tenant-super-admin.sh)

âœ… **æ­¥éª¤ï¼š**
1. ä½¿ç”¨ admin/admin ç™»å½•
2. éªŒè¯è¶…çº§ç®¡ç†å‘˜èº«ä»½
3. åˆ›å»ºç»„ç»‡ Alpha (å«ç®¡ç†å‘˜ alpha_admin)
4. åˆ›å»ºç»„ç»‡ Beta (å«ç®¡ç†å‘˜ beta_admin)
5. åˆ—å‡ºæ‰€æœ‰ç»„ç»‡
6. ä¸ºç»„ç»‡ Alpha åˆ›å»ºé›†ç¾¤
7. ä¸ºç»„ç»‡ Beta åˆ›å»ºé›†ç¾¤
8. åˆ—å‡ºæ‰€æœ‰é›†ç¾¤ï¼ˆè·¨ç»„ç»‡è§†å›¾ï¼‰
9. åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
10. åˆ›å»ºç³»ç»Ÿçº§è§’è‰²
11. åˆ—å‡ºæ‰€æœ‰è§’è‰²

âœ… **éªŒè¯ç‚¹ï¼š**
- è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç»„ç»‡
- è¶…çº§ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç»„ç»‡çš„èµ„æº
- è¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¸ºä»»æ„ç»„ç»‡åˆ›å»ºé›†ç¾¤
- è¶…çº§ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç³»ç»Ÿçº§è§’è‰²

### ç»„ç»‡ç®¡ç†å‘˜æµ‹è¯• (test-multi-tenant-org-admin.sh)

âœ… **æ­¥éª¤ï¼š**
1. ä½¿ç”¨ alpha_admin/Alpha@123 ç™»å½•
2. éªŒè¯ç”¨æˆ·èº«ä»½å’Œç»„ç»‡å…³è”
3. è·å–å½“å‰ç»„ç»‡è¯¦æƒ…
4. åˆ—å‡ºç»„ç»‡ï¼ˆåº”åªçœ‹åˆ°è‡ªå·±çš„ç»„ç»‡ï¼‰
5. åœ¨ç»„ç»‡å†…åˆ›å»ºç”¨æˆ· (alpha_user1)
6. åˆ—å‡ºç»„ç»‡å†…ç”¨æˆ·
7. åˆ›å»ºç»„ç»‡çº§è§’è‰² (alpha_developer)
8. åˆ—å‡ºç»„ç»‡å†…è§’è‰²
9. åˆ—å‡ºç»„ç»‡å†…é›†ç¾¤
10. ä¸ºç»„ç»‡åˆ›å»ºé¢å¤–é›†ç¾¤
11. å°è¯•åˆ›å»ºç³»ç»Ÿè§’è‰²ï¼ˆåº”å¤±è´¥ï¼‰
12. å°è¯•è®¿é—®ç»„ç»‡ Betaï¼ˆåº”å¤±è´¥ï¼‰

âœ… **éªŒè¯ç‚¹ï¼š**
- ç»„ç»‡ç®¡ç†å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±çš„ç»„ç»‡
- ç»„ç»‡ç®¡ç†å‘˜åˆ›å»ºçš„ç”¨æˆ·è‡ªåŠ¨å…³è”åˆ°å½“å‰ç»„ç»‡
- ç»„ç»‡ç®¡ç†å‘˜åªèƒ½åˆ›å»ºç»„ç»‡çº§è§’è‰²
- ç»„ç»‡ç®¡ç†å‘˜æ— æ³•åˆ›å»ºç³»ç»Ÿè§’è‰²
- ç»„ç»‡ç®¡ç†å‘˜æ— æ³•è®¿é—®å…¶ä»–ç»„ç»‡çš„èµ„æº

### æ™®é€šç”¨æˆ·æµ‹è¯• (test-multi-tenant-regular-user.sh)

âœ… **æ­¥éª¤ï¼š**
1. ä½¿ç”¨ alpha_user1/User@123 ç™»å½•
2. éªŒè¯ç”¨æˆ·èº«ä»½
3. åˆ—å‡ºå¯è§é›†ç¾¤
4. è·å–é›†ç¾¤è¯¦æƒ…
5. å°è¯•åˆ›å»ºé›†ç¾¤ï¼ˆåº”å¤±è´¥ï¼‰
6. å°è¯•åˆ›å»ºç”¨æˆ·ï¼ˆåº”å¤±è´¥ï¼‰
7. å°è¯•åˆ›å»ºè§’è‰²ï¼ˆåº”å¤±è´¥ï¼‰
8. å°è¯•åˆ—å‡ºç»„ç»‡ï¼ˆåº”è¢«é™åˆ¶ï¼‰
9. æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰
10. å°è¯•åˆ—å‡ºç”¨æˆ·ï¼ˆåº”è¢«é™åˆ¶ï¼‰
11. å°è¯•åˆ—å‡ºè§’è‰²ï¼ˆåº”è¢«é™åˆ¶ï¼‰

âœ… **éªŒè¯ç‚¹ï¼š**
- æ™®é€šç”¨æˆ·æ— æ³•æ‰§è¡Œç®¡ç†æ“ä½œ
- æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è¢«æˆæƒçš„é›†ç¾¤
- æ™®é€šç”¨æˆ·æ— æ³•åˆ›å»ºèµ„æº
- æ™®é€šç”¨æˆ·ä½œç”¨åŸŸé™å®šåœ¨ç»„ç»‡å†…

## ğŸ” æµ‹è¯•è¾“å‡ºè¯´æ˜

### é¢œè‰²æ ‡è¯†
- ğŸŸ¢ **ç»¿è‰²**: æµ‹è¯•é€šè¿‡
- ğŸŸ¡ **é»„è‰²**: è­¦å‘Šæˆ–æç¤ºä¿¡æ¯
- ğŸ”µ **è“è‰²**: æ­¥éª¤è¯´æ˜
- ğŸ”´ **çº¢è‰²**: æµ‹è¯•å¤±è´¥

### è¾“å‡ºç¤ºä¾‹

```bash
[Step 1] Login as Super Admin (admin/admin)...
âœ“ Login successful
Token: eyJhbGciOiJIUzI1NiI...

[Step 3] Create Organization Alpha...
âœ“ Organization Alpha created (ID: 2)
{
  "id": 2,
  "code": "ORG_ALPHA",
  "name": "Alpha Corporation",
  ...
}
```

## ğŸ­ æµ‹è¯•åœºæ™¯è®¾è®¡

### åœºæ™¯ 1: å¤šç»„ç»‡èµ„æºéš”ç¦»
- åˆ›å»ºä¸¤ä¸ªç»„ç»‡ï¼šAlpha å’Œ Beta
- æ¯ä¸ªç»„ç»‡éƒ½æœ‰è‡ªå·±çš„ç®¡ç†å‘˜ã€ç”¨æˆ·ã€è§’è‰²å’Œé›†ç¾¤
- éªŒè¯ç»„ç»‡é—´èµ„æºå®Œå…¨éš”ç¦»

### åœºæ™¯ 2: è§’è‰²æƒé™éªŒè¯
- è¶…çº§ç®¡ç†å‘˜ï¼šå…¨å±€ç®¡ç†æƒé™
- ç»„ç»‡ç®¡ç†å‘˜ï¼šç»„ç»‡å†…ç®¡ç†æƒé™
- æ™®é€šç”¨æˆ·ï¼šåªè¯»æˆ–æœ‰é™æ“ä½œæƒé™

### åœºæ™¯ 3: è¾¹ç•Œæµ‹è¯•
- ç»„ç»‡ç®¡ç†å‘˜å°è¯•è®¿é—®å…¶ä»–ç»„ç»‡ â†’ 403 Forbidden
- æ™®é€šç”¨æˆ·å°è¯•åˆ›å»ºèµ„æº â†’ 403 Forbidden
- æ™®é€šç”¨æˆ·å°è¯•æŸ¥çœ‹æœªæˆæƒé›†ç¾¤ â†’ 403 Forbidden

## ğŸ“ æµ‹è¯•æ•°æ®

### ç»„ç»‡
- **Alpha Corporation** (ORG_ALPHA)
- **Beta Industries** (ORG_BETA)

### ç”¨æˆ·
| ç”¨æˆ·å | å¯†ç  | è§’è‰² | ç»„ç»‡ |
|--------|------|------|------|
| admin | admin | Super Admin | - |
| alpha_admin | Alpha@123 | Org Admin | Alpha |
| beta_admin | Beta@123 | Org Admin | Beta |
| alpha_user1 | User@123 | Regular User | Alpha |

### é›†ç¾¤
- **alpha_cluster** - Alpha ç»„ç»‡ä¸»é›†ç¾¤
- **alpha_cluster_dev** - Alpha ç»„ç»‡å¼€å‘é›†ç¾¤
- **beta_cluster** - Beta ç»„ç»‡ä¸»é›†ç¾¤

### è§’è‰²
- **system_auditor** - ç³»ç»Ÿçº§å®¡è®¡è§’è‰²
- **alpha_developer** - Alpha ç»„ç»‡å¼€å‘è€…è§’è‰²

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œé¡ºåº**: å¿…é¡»æŒ‰ç…§ super-admin â†’ org-admin â†’ regular-user çš„é¡ºåºæ‰§è¡Œ
2. **ä¾èµ–å…³ç³»**: åç»­æµ‹è¯•ä¾èµ–å‰é¢æµ‹è¯•åˆ›å»ºçš„æ•°æ®
3. **æ¸…ç†æ•°æ®**: æµ‹è¯•è„šæœ¬ä¸ä¼šè‡ªåŠ¨æ¸…ç†æ•°æ®ï¼Œå¦‚éœ€é‡æ–°æµ‹è¯•ï¼Œè¯·æ‰‹åŠ¨æ¸…ç†æ•°æ®åº“
4. **ç«¯å£é…ç½®**: é»˜è®¤åç«¯ç«¯å£ä¸º 8081ï¼Œå¦‚æœ‰ä¿®æ”¹è¯·ç¼–è¾‘è„šæœ¬ä¸­çš„ `BASE_URL`

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šç™»å½•å¤±è´¥
```bash
âœ— Login failed
Note: Make sure you ran test-multi-tenant-super-admin.sh first
```
**è§£å†³**: ç¡®ä¿æŒ‰é¡ºåºè¿è¡Œè„šæœ¬ï¼Œæˆ–æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²åˆ›å»º

### é—®é¢˜ï¼š403 Forbidden
```bash
âœ— Cannot access cluster details (HTTP 403)
```
**è§£å†³**: è¿™å¯èƒ½æ˜¯é¢„æœŸè¡Œä¸ºï¼ŒéªŒè¯æƒé™é…ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜ï¼šåç«¯æœªå“åº”
```bash
curl: (7) Failed to connect to localhost port 8081
```
**è§£å†³**: 
1. æ£€æŸ¥åç«¯æ˜¯å¦åœ¨è¿è¡Œï¼š`ps aux | grep stellar`
2. æ£€æŸ¥ç«¯å£ï¼š`lsof -i :8081`
3. å¯åŠ¨åç«¯ï¼š`cd backend && cargo run`

## ğŸ“ˆ é¢„æœŸç»“æœ

æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
================================================
âœ“ ALL TESTS PASSED
================================================

Multi-Tenant Feature Verification:
  âœ“ Organizations created and isolated
  âœ“ Super admin can manage all resources
  âœ“ Org admins are scoped to their organization
  âœ“ Regular users have limited permissions
  âœ“ Cross-org access is blocked
  âœ“ Role-based access control working

The multi-tenant system is working correctly!
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¤šç§Ÿæˆ·è®¾è®¡æ–‡æ¡£](../../docs/multi-tenant-design.md)
- [API æ–‡æ¡£](../../docs/api.md)
- [æƒé™æ¨¡å‹](../../docs/permissions.md)

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒé¡¹ç›® README æˆ–æäº¤ Issueã€‚
